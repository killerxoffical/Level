<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVEL UP - Welcome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@latest/dist/dotlottie-wc.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #121212; color-scheme: dark; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: start; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; transform: scale(1); opacity: 1; overflow-y: auto; padding: 1rem; }
        .screen.hidden { opacity: 0; transform: scale(1.05); pointer-events: none; }
        .auth-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 1rem; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; opacity: 0; transform: scale(0.95); pointer-events: none; }
        .auth-view.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        #modal-screen, #forgot-password-modal, #booking-screen, #participant-list-screen, #results-submission-screen, #sponsor-profile-screen, #payment-screen, #guild-post-form-screen, #guild-application-screen, #user-profile-screen, #player-squad-post-form-screen, #loading-overlay, #gift-card-open-modal, #topup-purchase-modal, #redeem-task-screen, #partner-screen { z-index: 1000; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        #ad-view-screen { z-index: 1001; background-color: #121212; padding: 0;}
        .modal-box { background-color: #242428; border: 1px solid #3a3a3a; box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05) inset; max-width: 380px; width: 90%; border-radius: 1.5rem; }
        .input-field { background-color: #121212; box-shadow: inset 6px 6px 12px #0c0c0c, inset -6px -6px 12px #1a1a1a; transition: box-shadow 0.2s ease; }
        .input-field:focus-within, .form-input:focus { box-shadow: inset 6px 6px 12px #0c0c0c, inset -6px -6px 12px #1a1a1a, 0 0 0 2px #1DB954 !important; outline: none; }
        .action-button, .booking-btn, .manage-btn { background-image: linear-gradient(to right, #1DB954, #1ed760); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; border: none; }
        .action-button:hover:not(:disabled), .booking-btn:hover, .manage-btn:hover { box-shadow: 0 6px 20px rgba(29, 185, 84, 0.3); transform: translateY(-2px); }
        .action-button:active:not(:disabled), .booking-btn:active, .manage-btn:active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); transform: translateY(1px); }
        .action-button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        main { background: #121212; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #ffffff; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; color: #9ca3af; }
        #splash-screen-logo, #splash-screen-lottie { position: absolute; transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out; }
        #splash-screen-lottie.fade-out { opacity: 0; transform: scale(0.8); }
        #splash-screen-logo { opacity: 0; transform: scale(0.8); }
        #splash-screen-logo.fade-in { opacity: 1; transform: scale(1); }
        .nav-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; z-index: 200; }
        .nav-bar { position: relative; display: flex; justify-content: space-around; align-items: center; background-color: #212124; padding: 8px; border-radius: 9999px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { display: flex; align-items: center; justify-content: center; padding: 12px 16px; cursor: pointer; color: #a1a1aa; position: relative; z-index: 10; transition: color 0.3s ease-out; border-radius: 9999px; }
        .nav-item .nav-icon { font-size: 20px; transition: color 0.3s ease-out; }
        .nav-item .nav-label { font-weight: 600; font-size: 14px; white-space: nowrap; margin-left: 0; max-width: 0; opacity: 0; overflow: hidden; transition: max-width 0.3s ease-out, opacity 0.2s 0.1s ease-out, margin-left 0.3s ease-out; }
        .nav-item.active { color: #212124; }
        .nav-item.active .nav-label { max-width: 100px; opacity: 1; margin-left: 10px; }
        #nav-indicator { position: absolute; top: 8px; height: calc(100% - 16px); background-color: #ffffff; border-radius: 9999px; z-index: 5; transition: all 0.35s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .countdown-item { background-color: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; }
        .countdown-item span { font-size: 0.9rem; font-weight: bold; line-height: 1; }
        .countdown-item p { font-size: 0.5rem; text-transform: uppercase; color: #a1a1aa; margin-top: 1px; }
        .form-section { background: #1e1e1e; border: 1px solid #2a2a2a; }
        .form-label { color: #a1a1aa; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 600; }
        .form-input, .form-select, .form-textarea { background: #121212; border: 1px solid #333; color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; transition: border-color 0.2s; }
        .igl-input-box { background-color: rgba(212, 175, 55, 0.1); border: 1px solid #d4af37 !important; }
        .post-card, .guild-post-card, .player-squad-post-card { background: #28282B; border: 1px solid #3a3a3a; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .slot-progress-bar { background-color: #444; }
        .slot-progress-fill { background-image: linear-gradient(to right, #1DB954, #34d399); }
        .dashboard-page { transition: opacity 0.3s ease-in-out; }
        .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 45; transition: transform 0.3s ease, opacity 0.3s ease, bottom 0.3s ease; transform: scale(0); opacity: 0;}
        .fab.visible { transform: scale(1); opacity: 1; }
        #scroll-to-top-btn { bottom: 156px; right: 20px; background-color: #2a2a2a; color: white; border: 1px solid #444; box-shadow: 8px 8px 16px #0d0d0d, -8px -8px 16px #252525;}
        #scroll-to-top-btn:hover { background-color: #3a3a3a; transform: translateY(-2px); }
        .tab-button { flex: 1; text-align: center; padding: 0.75rem 0; background-color: #2a2a2a; color: #a1a1aa; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .tab-button.active-tab { background-color: #1DB954; color: white; }
        .tab-content-section { display: none; }
        .tab-content-section.active-section { display: block; }
        .home-tab-content { display: none; }
        .home-tab-content.active { display: block; }
        .home-tab-link { font-size: 0.85rem; font-weight: 600; color: #a1a1aa; cursor: pointer; transition: color 0.2s ease; padding: 0.5rem 0.25rem; white-space: nowrap; }
        .home-tab-link.active-home-tab { color: #1DB954; }
        .swipe-container { position: relative; width: 100%; background-color: #121212; border-radius: 9999px; padding: 6px; overflow: hidden; box-shadow: inset 4px 4px 8px #0c0c0c, inset -4px -4px 8px #1a1a1a; }
        .swipe-text { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); text-align: center; color: #a1a1aa; font-weight: bold; z-index: 1; pointer-events: none; }
        .swipe-handle { position: relative; z-index: 2; width: 50px; height: 50px; background-image: linear-gradient(to right, #1DB954, #1ed760); border-radius: 50%; cursor: grab; display: flex; align-items: center; justify-content: center; touch-action: none; transition: transform 0.2s ease; }
        .swipe-handle:active { transform: scale(1.1); }
        .swipe-track { position: absolute; left: 0; top: 0; height: 100%; background-color: rgba(29, 185, 84, 0.3); border-radius: 9999px; }
        @keyframes pulse-green-glow { 0% { box-shadow: 0 0 5px rgba(29, 185, 84, 0.4), 0 0 10px rgba(29, 185, 84, 0.3); } 70% { box-shadow: 0 0 15px rgba(29, 185, 84, 0.8), 0 0 25px rgba(29, 185, 84, 0.6); } 100% { box-shadow: 0 0 5px rgba(29, 185, 84, 0.4), 0 0 10px rgba(29, 185, 84, 0.3); } }
        .is-live-match { border-color: #1DB954; animation: pulse-green-glow 2s infinite; }
        #image-lightbox { z-index: 1002; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); transition: opacity 0.3s ease; }
        #lightbox-img { max-width: 90vw; max-height: 80vh; object-fit: contain; }
        .rating-stars .fa-star { cursor: pointer; transition: color 0.2s; }
        #page-transition-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.2s ease-in-out; backdrop-filter: blur(5px); }
        #page-transition-overlay.active { opacity: 1; pointer-events: auto; }
        .notification-badge { position: absolute; top: 8px; right: 28px; background-color: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .mail-item.unread { background-color: #2a2a2a; border-left-color: #1DB954; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .banned-card { opacity: 0.6; background: #28282B; pointer-events: none; box-shadow: inset 0 0 20px rgba(255, 50, 50, 0.3); }
        .gender-radio:checked + label, .custom-radio:checked + label { background-color: #1DB954; color: white; border-color: #1DB954; }
        #strength-bar-container { width: 100%; height: 6px; background-color: #333; border-radius: 3px; overflow: hidden; margin-top: -8px; margin-bottom: 8px; }
        #strength-bar { height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s, background-color 0.3s; }
        .strength-weak { background-color: #ef4444; width: 33%; }
        .strength-medium { background-color: #f59e0b; width: 66%; }
        .strength-strong { background-color: #10b981; width: 100%; }
        .slider-media { width: 100%; height: 100%; object-fit: cover; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; pointer-events: none; }
        .clickable-post-indicator { position: absolute; bottom: 10px; left: 10px; background-color: rgba(29, 185, 84, 0.8); color: white; border-radius: 12px; padding: 4px 8px; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 4px; z-index: 10; pointer-events: none; }
        .post-card.highlighted-post, .guild-post-card.highlighted-post, .player-squad-post-card.highlighted-post { box-shadow: 0 0 15px 5px rgba(29, 185, 84, 0.6); border: 2px solid #1DB954; transform: scale(1.02); animation: pulse-green-glow 1.5s infinite; }
        .verification-badge { width: 1.2em; height: 1.2em; margin-left: 0.4em; vertical-align: middle; cursor: pointer; }
        .premium-header { background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0 0 24px 24px; }
        .header-back-btn { background-color: rgba(255, 255, 255, 0.1); }
        #profile-content { background: radial-gradient(circle, #1e1e1e 0%, #121212 100%); }
        .setting-item { background-color: #2a2a2a; border-radius: 0.75rem; padding: 1.1rem 1rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: background-color 0.2s, transform 0.2s; border: 1px solid #3a3a3a; width: 100%; }
        .setting-item:hover { background-color: #3a3a3a; transform: scale(1.02); }
        .setting-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; }
        .setting-icon i { font-size: 1.2rem; color: white; }
        .bg-icon-blue { background-color: #3b82f6; }
        .bg-icon-green { background-color: #22c55e; }
        .bg-icon-orange { background-color: #f97316; }
        .bg-icon-red { background-color: #ef4444; }
        .bg-icon-yellow { background-color: #eab308; }
        .bg-icon-purple { background-color: #8b5cf6; }
        .setting-label { font-size: 1.05rem; font-weight: 600; color: #e5e7eb; }
        .section-header { color: #9ca3af; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; padding: 1.5rem 0.25rem 0.5rem 0.25rem; }
        #payment-content-area { padding-top: 80px !important; }
        .payment-method-btn { background-color: #2a2a2a; border: 1px solid #3a3a3a; transition: all 0.2s ease; }
        .payment-method-btn:hover { background-color: #3a3a3a; transform: translateY(-2px); border-color: #1DB954; }
        .payment-method-img { width: 48px; height: 48px; object-fit: contain; border-radius: 0.75rem; margin-right: 1rem; }
        .user-profile-stat { background-color: #2a2a2a; border: 1px solid #3a3a3a; border-radius: 0.75rem; padding: 1rem; text-align: center; }
        .user-profile-stat-value { font-size: 1.5rem; font-weight: bold; font-family: 'Oswald', sans-serif; }
        .user-profile-stat-label { font-size: 0.75rem; color: #a1a1aa; text-transform: uppercase; margin-top: 0.25rem; }
        .card-tag { background-color: rgba(255, 255, 255, 0.1); color: #a1a1aa; font-size: 0.7rem; font-weight: 600; padding: 4px 10px; border-radius: 9999px; display: inline-flex; align-items: center; gap: 6px; }

        /* Sidebar Styles */
        #sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: #1e1e24; z-index: 300; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 299; transition: opacity 0.3s ease-in-out; }
        .sidebar-menu-item { display: flex; align-items: center; gap: 16px; padding: 12px 16px; color: #e5e7eb; font-weight: 500; border-radius: 8px; transition: background-color 0.2s, color 0.2s; cursor: pointer; font-size: 0.95rem;}
        .sidebar-menu-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .sidebar-menu-item .icon-bg { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .sidebar-menu-item .icon-bg i { font-size: 1.1rem; }
        
        /* UPDATED GIFT CARD STYLES */
        .gift-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .gift-card-preview { aspect-ratio: 1 / 1.2; border-radius: 1rem; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; overflow: hidden; background-size: cover; background-position: center; }
        .gift-card-preview:active { transform: scale(0.95); }
        .gift-card-preview .card-footer { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); padding: 0.5rem; text-align: center; color: white; font-size: 0.7rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .gift-card-preview > div:first-child { position: absolute; inset: 0; z-index: 2; }
        .gift-card-claimed::before { content: 'CLAIMED'; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; color: #9ca3af; font-family: 'Oswald', sans-serif; font-size: 1.5rem; letter-spacing: 2px; }
        .gift-card-preview .opacity-50.cursor-default { pointer-events: none; }
        #gift-card-open-modal .modal-box { max-width: 320px; background: transparent; border: none; box-shadow: none; position: relative; }
        .gift-card-open-modal-content { perspective: 1000px; }
        .gift-card-flipper { position: relative; width: 100%; aspect-ratio: 3 / 4.2; transition: transform 0.8s; transform-style: preserve-3d; }
        .gift-card-flipper.is-flipped { transform: rotateY(180deg); }
        .gift-card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .card-front { background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; }
        .card-back { background-color: #1e1e1e; transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background-size: contain; background-position: center; background-repeat: no-repeat;}
        .open-card-btn { background-image: linear-gradient(to right, #eab308, #f59e0b); color: #121212; font-weight: bold; padding: 0.75rem 2.5rem; border-radius: 9999px; transition: all 0.2s; border: none; box-shadow: 0 4px 15px rgba(234, 179, 8, 0.3); font-family: 'Oswald', sans-serif; letter-spacing: 1px; }
        .open-card-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 6px 20px rgba(234, 179, 8, 0.4); }
        .bad-luck-icon { font-size: 5rem; color: #4b5563; }
        .bad-luck-text { font-family: 'Oswald', sans-serif; font-size: 2rem; color: #9ca3af; margin-top: 1rem; }
        .close-card-modal-btn { position: absolute; top: -15px; right: -15px; width: 40px; height: 40px; background-color: #1a1a1a; color: white; border-radius: 50%; font-size: 1.5rem; border: 2px solid white; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; }
        @keyframes fadeInReveal { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .card-back > * { animation: fadeInReveal 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; opacity: 0; }

        /* NEW Horizontal Store Styles */
        .horizontal-scroll-container { display: flex; overflow-x: auto; gap: 1rem; padding: 0.5rem 0 1rem 0; scroll-snap-type: x mandatory; }
        .horizontal-scroll-container > div { scroll-snap-align: start; }
        .store-item-h { flex: 0 0 160px; width: 160px; background: #2a2a2e; border: 1px solid #3a3a3a; border-radius: 1rem; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; }
        .store-item-h:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .store-item-h-image { width: 100%; aspect-ratio: 1 / 1.2; object-fit: cover; }
        .store-item-h-content { padding: 0.75rem; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .store-item-h-title { font-size: 0.9rem; font-weight: 600; color: white; display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-grow: 1; }
        .store-item-h-button { width: 100%; padding: 0.6rem 0; border-radius: 0.5rem; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: auto; }

        /* NEW Topup Purchase / Redeem Code Styles */
        #topup-purchase-modal .modal-box { max-width: 340px; background: transparent; border: none; box-shadow: none; perspective: 1000px; }
        .topup-card-flipper { position: relative; width: 100%; aspect-ratio: 3 / 4.2; transition: transform 2s cubic-bezier(0.19, 1, 0.22, 1); transform-style: preserve-3d; }
        .topup-card-flipper.is-flipped { transform: rotateY(180deg); }
        .topup-card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.5); background-size: cover; background-position: center; }
        .topup-card-back { background-image: linear-gradient(to bottom right, #2a2a2e, #1e1e1e); transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; }
        .redeem-code-wrapper { background: #121212; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px dashed #3a3a3a; margin-top: 1rem; width: 100%; position: relative; overflow: hidden; }
        .redeem-code-text { font-family: 'Courier New', Courier, monospace; font-size: 1.1rem; font-weight: bold; color: #6ee7b7; letter-spacing: 2px; }
        @keyframes scan-light { 0% { top: -10%; } 100% { top: 110%; } }
        .scan-overlay::after { content: ''; position: absolute; top: -10%; left: 0; width: 100%; height: 10%; background: linear-gradient(to bottom, rgba(110, 231, 183, 0), rgba(110, 231, 183, 0.5), rgba(110, 231, 183, 0)); animation: scan-light 2s ease-in-out infinite; }
        
        /* NEW Mission/Task Styles */
        .task-card {
            background-color: #28282B;
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid #3a3a3a;
        }
        .task-icon-container {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
            background: linear-gradient(145deg, #2a2a2f, #232327);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            color: #3b82f6;
            font-size: 1.5rem;
            border: 2px solid #3b82f6;
        }
        .task-progress {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #121212;
            color: #a1a1aa;
            font-size: 0.65rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 9999px;
            border: 1px solid #3a3a3a;
        }
        .task-reward {
            background-color: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            color: #f59e0b;
            font-weight: bold;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .task-reward img { width: 16px; height: 16px; }
        .task-action-btn {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            padding: 0.6rem 1.5rem;
            border-radius: 9999px;
            transition: all 0.2s ease;
        }
        .task-action-btn:hover:not(:disabled) {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .task-action-btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
        }

    </style>
</head>
<body class="overflow-hidden">
    
    <!-- New Sidebar -->
    <div id="sidebar-overlay" class="hidden"></div>
    <aside id="sidebar" class="flex flex-col no-scrollbar overflow-y-auto">
        <div class="p-4 border-b border-gray-700/50">
            <div id="sidebar-profile-header" class="flex items-center gap-4 cursor-pointer">
                <img id="sidebar-avatar" src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" class="w-16 h-16 rounded-full object-cover border-2 border-gray-600">
                <div>
                    <h2 id="sidebar-username" class="text-xl font-bold text-white">USER NAME</h2>
                    <div class="flex items-center">
                       <p id="sidebar-teamname" class="text-sm text-gray-400">TEAM NAME</p>
                       <img id="sidebar-team-badge" src="" class="h-4 ml-2 hidden" alt="Team Badge">
                    </div>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-2 text-white">
                 <div class="bg-[#2a2a2e] p-2 rounded-lg flex items-center justify-between font-semibold h-full text-sm">
                    <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763055321.png?alt=media&token=58051d4b-446d-4a30-b588-bed5a5f49c8d" class="w-6 h-6">
                    <span id="sidebar-coin-balance">0</span>
                    <div class="bg-orange-500 rounded-md w-4 h-4 flex items-center justify-center text-white font-bold cursor-pointer">+</div>
                </div>
                 <div class="bg-[#2a2a2e] p-2 rounded-lg flex items-center justify-between font-semibold h-full text-sm">
                    <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763297995.png?alt=media&token=db9ebed1-ff51-49ed-a311-0327313dae56" class="w-6 h-6">
                    <span id="sidebar-diamond-balance">0</span>
                    <div class="bg-orange-500 rounded-md w-4 h-4 flex items-center justify-center text-white font-bold cursor-pointer">+</div>
                </div>
            </div>
        </div>

        <nav class="flex-grow p-2 space-y-1">
            <a id="sidebar-stream-stats" class="sidebar-menu-item"><div class="icon-bg bg-red-500/20"><i class="fa-solid fa-chart-line text-red-300"></i></div><span>Stream Statistics</span></a>
            <a id="sidebar-store" class="sidebar-menu-item"><div class="icon-bg bg-purple-500/20"><i class="fa-solid fa-store text-purple-300"></i></div><span>Store</span></a>
            <a id="sidebar-history" class="sidebar-menu-item"><div class="icon-bg bg-blue-500/20"><i class="fa-solid fa-receipt text-blue-300"></i></div><span>History</span></a>
            <a id="sidebar-redeem" class="sidebar-menu-item"><div class="icon-bg bg-green-500/20"><i class="fa-solid fa-gift text-green-300"></i></div><span>Redeem Code</span></a>
            <a id="sidebar-leaderboard" class="sidebar-menu-item"><div class="icon-bg bg-yellow-500/20"><i class="fa-solid fa-trophy text-yellow-300"></i></div><span>Leaderboard</span></a>
            <a id="sidebar-coupons" class="sidebar-menu-item relative">
                <div class="icon-bg bg-teal-500/20"><i class="fa-solid fa-ticket text-teal-300"></i></div>
                <span>Gift Cards</span>
                <span id="sidebar-coupons-badge" class="absolute top-2 right-2 w-5 h-5 bg-red-600 text-white text-xs font-bold rounded-full flex items-center justify-center hidden">0</span>
            </a>
            <a id="sidebar-partner" class="sidebar-menu-item"><div class="icon-bg bg-green-500/20"><i class="fa-solid fa-handshake-simple text-green-300"></i></div><span class="text-green-400 font-bold">Join a Partner</span></a>
            <a id="sidebar-my-channel" class="sidebar-menu-item"><div class="icon-bg bg-indigo-500/20"><i class="fa-solid fa-tv text-indigo-300"></i></div><span>My channel</span></a>
            <a id="sidebar-monetize" class="sidebar-menu-item"><div class="icon-bg bg-yellow-600/20"><i class="fa-solid fa-sack-dollar text-yellow-500"></i></div><span>Monetize Earning</span></a>
        </nav>
        <div class="p-4 border-t border-gray-700/50 relative">
            <a href="javascript:void(0)" id="sidebar-contact-btn" class="w-14 h-14 rounded-full bg-green-500 flex items-center justify-center text-white text-3xl absolute -top-7 right-4 shadow-lg hover:scale-110 transition-transform">
                <i class="fa-solid fa-phone"></i>
            </a>
            <div class="bg-gray-800/50 p-2 rounded-full flex justify-around items-center">
                <a href="https://t.me/levelupbd" target="_blank" class="text-gray-400 hover:text-white text-2xl"><i class="fab fa-facebook"></i></a>
                <a href="https://t.me/levelupbd" target="_blank" class="text-gray-400 hover:text-white text-2xl"><i class="fab fa-telegram"></i></a>
            </div>
        </div>
    </aside>

    <div id="page-transition-overlay"></div>

    <!-- Screen 1: Splash -->
    <div id="splash-screen" class="screen bg-black !justify-center">
        <dotlottie-wc id="splash-screen-lottie" src="https://lottie.host/09fd19d9-9bd5-42ca-8089-880621573a27/qqEJoYOp7E.lottie" style="width: 300px; height: 300px" autoplay loop></dotlottie-wc>
        <img id="splash-screen-logo" src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="LEVEL UP Logo" class="w-48 h-48 rounded-full">
    </div>

    <!-- Screen 2: Auth -->
    <div id="auth-container" class="screen bg-black hidden !justify-center">
        <div id="login-view" class="auth-view active"><div class="w-full max-w-sm text-white text-center"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="Logo" class="w-24 h-24 mx-auto mb-4 rounded-full"><h1 class="text-4xl font-bold">LEVEL UP</h1><p class="text-md text-gray-400 mb-10">Welcome Back</p><form id="login-form-element" class="space-y-5"><div class="relative flex items-center w-full input-field rounded-2xl"><i class="fa-solid fa-envelope absolute left-5 text-gray-400"></i><input id="login-email" type="text" placeholder="Email" required class="w-full bg-transparent pl-12 pr-5 py-4 text-white placeholder-gray-400 border-none rounded-2xl focus:outline-none"></div><div class="relative flex items-center w-full input-field rounded-2xl"><i class="fa-solid fa-lock absolute left-5 text-gray-400"></i><input id="login-password" type="password" placeholder="Password" required class="w-full bg-transparent pl-12 pr-12 py-4 text-white placeholder-gray-400 border-none rounded-2xl focus:outline-none"><i id="toggle-login-password" class="fa-solid fa-eye password-toggle"></i></div><div><a href="#" id="forgot-password-link" class="block text-sm text-right text-gray-400 hover:text-white -mt-2 mb-6">Forgot password?</a><button type="submit" class="w-full py-4 rounded-2xl action-button text-lg flex items-center justify-center h-[52px]">Sign In</button></div></form><div class="text-center mt-8 text-base text-gray-400 space-y-4"><p>Don't have an account? <a href="#" id="show-signup" class="font-bold text-[#1DB954] hover:underline">Sign Up</a></p><p><a href="https://t.me/Blackmoney54" target="_blank" rel="noopener noreferrer" class="hover:underline">Contact <span class="text-[#1DB954] font-semibold">Help</span></a></p></div></div></div>
        <div id="signup-view" class="auth-view"><div class="w-full max-w-sm text-white"><div class="text-center mb-6"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="Logo" class="w-20 h-20 mx-auto mb-3 rounded-full"><h1 class="text-3xl font-bold">Create Account</h1></div><form id="signup-form-element" class="space-y-4">
            <div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-user absolute left-5 text-gray-400"></i><input id="signup-fullname" type="text" placeholder="Full Name" required class="w-full bg-transparent pl-12 pr-5 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"></div>
            <div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-envelope absolute left-5 text-gray-400"></i><input id="signup-email" type="email" placeholder="Email Address (@gmail.com only)" required class="w-full bg-transparent pl-12 pr-5 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"></div>
            <div class="flex items-center w-full rounded-xl input-field px-5">
                <i class="fa-brands fa-whatsapp text-gray-400 mr-3 text-lg"></i>
                <span class="text-gray-400 text-sm pr-2">+880</span>
                <input id="signup-whatsapp" type="tel" placeholder="WhatsApp Number" required class="flex-1 bg-transparent py-3 text-sm text-white placeholder-gray-400 border-none focus:outline-none">
            </div>
            <div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-lock absolute left-5 text-gray-400"></i><input id="signup-password" type="password" placeholder="Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"><i id="toggle-signup-password" class="fa-solid fa-eye password-toggle"></i></div>
            <div id="strength-bar-container"><div id="strength-bar"></div></div>
            <div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-lock absolute left-5 text-gray-400"></i><input id="signup-confirm-password" type="password" placeholder="Confirm Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"><i id="toggle-confirm-password" class="fa-solid fa-eye password-toggle"></i></div>
            <p id="password-match-msg" class="text-xs -mt-2 ml-2 h-4"></p>
            <div class="flex justify-center space-x-2 my-2"><div><input type="radio" id="male" name="gender" class="hidden gender-radio" value="male" checked><label for="male" class="cursor-pointer flex items-center justify-center w-24 h-11 text-xs text-gray-400 rounded-full input-field">Male</label></div><div><input type="radio" id="female" name="gender" class="hidden gender-radio" value="female"><label for="female" class="cursor-pointer flex items-center justify-center w-24 h-11 text-xs text-gray-400 rounded-full input-field">Female</label></div><div><input type="radio" id="other" name="gender" class="hidden gender-radio" value="other"><label for="other" class="cursor-pointer flex items-center justify-center w-24 h-11 text-xs text-gray-400 rounded-full input-field">Other</label></div></div>
            <button type="submit" class="w-full py-4 mt-4 rounded-xl action-button text-lg flex items-center justify-center h-[52px]">Sign Up</button>
        </form><div class="text-center mt-4"><p class="text-sm text-gray-400">Already have an account? <a href="#" id="show-login" class="font-bold text-[#1DB954] hover:underline">Sign In</a></p></div></div></div>
    </div>
    
    <!-- Screen 3: Dashboard -->
    <div id="dashboard-screen" class="screen hidden p-0 justify-start">
        <main class="w-full h-full text-white overflow-y-auto no-scrollbar">
            <!-- Headers -->
            <header id="main-header" class="sticky top-0 z-40 bg-[#1e1e1e]/80 backdrop-blur-md border-b border-gray-800 p-3 flex justify-between items-center gap-2 rounded-b-2xl">
                <button id="sidebar-toggle" class="text-xl text-gray-300 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="flex items-center gap-2">
                    <button id="home-search-btn" class="text-xl text-gray-300 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10">
                        <i class="fa-solid fa-search"></i>
                    </button>
                    <div id="wallet-button" class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-full p-2 px-4 flex items-center gap-3 cursor-pointer hover:border-green-500 transition-all duration-300">
                        <i class="fa-solid fa-wallet text-xl text-green-400"></i>
                        <div>
                            <p class="text-sm font-bold text-white font-oswald tracking-wider"><span id="header-wallet-balance">0.00</span> <span class="text-xs font-normal text-gray-300">TK</span></p>
                        </div>
                    </div>
                </div>
            </header>
            <header id="home-search-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                 <button id="back-from-home-search-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="relative w-full ml-2">
                    <input id="home-search-input" type="text" placeholder="Search..." class="w-full bg-gray-900/50 border border-gray-700 rounded-full pl-10 pr-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-green-500">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                </div>
            </header>
            <header id="search-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <div class="relative w-full">
                    <input id="search-input-mobile" type="text" placeholder="Search by event, sponsor, or tags..." class="w-full bg-gray-900/50 border border-gray-700 rounded-full pl-10 pr-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-green-500">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                </div>
            </header>
            <header id="my-matches-header" class="hidden sticky top-0 z-40 premium-header py-4 px-4 text-center">
                <h2 class="text-xl font-bold">My Match History</h2>
            </header>
            <header id="team-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-team-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Manage Your Team</h2>
                <div class="w-10"></div>
            </header>
            <header id="wallet-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-wallet-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">My Wallet & Stats</h2>
                <div class="w-10"></div>
            </header>
            <header id="mailbox-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-mailbox-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Mailbox</h2>
                <div class="w-10"></div>
            </header>
            <header id="history-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-history-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Transaction History</h2>
                <div class="w-10"></div>
            </header>
             <header id="redeem-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-redeem-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Redeem Code</h2>
                <div class="w-10"></div>
            </header>
            <header id="edit-profile-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-edit-profile-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Edit Profile</h2>
                <div class="w-10"></div>
            </header>
            <header id="change-password-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-change-password-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Change Password</h2>
                <div class="w-10"></div>
            </header>
            <header id="manage-posts-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-manage-posts-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Manage Posts</h2>
                <div class="w-10"></div>
            </header>
             <header id="my-coupons-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-coupons-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">Gift Cards</h2>
                <div class="w-10"></div>
            </header>

            <!-- Page Content Area -->
            <div class="pb-24">
                <div id="home-content" class="dashboard-page">
                    <div id="home-tabs" class="px-4 py-2 flex items-center gap-4 overflow-x-auto no-scrollbar sticky top-[68px] bg-[#121212] z-30">
                        <button class="home-tab-link active-home-tab" data-target="post-feed">All</button>
                        <button class="home-tab-link" data-target="home-tournaments-feed">Tournament</button>
                        <button class="home-tab-link" data-target="home-guild-feed">Guild</button>
                        <button class="home-tab-link" data-target="home-player-squad-feed">Squad</button>
                        <button class="home-tab-link" data-target="home-livestream-feed">Live</button>
                        <button class="home-tab-link" data-target="home-missions-feed">Missions</button>
                        <button class="home-tab-link" data-target="home-store-feed">Store</button>
                    </div>
                    <div id="slider-wrapper" class="p-4">
                        <div class="relative w-full overflow-hidden shadow-lg rounded-xl">
                            <h2 class="absolute top-4 left-0 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs font-bold uppercase tracking-wider px-5 py-2 rounded-r-full shadow-lg z-10">Promotion</h2>
                            <div class="flex transition-transform duration-500 ease-in-out" id="slider-container"></div>
                            <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-2" id="slider-dots"></div>
                        </div>
                    </div>
                    
                    <div id="post-feed" class="home-tab-content active space-y-6 px-4"></div>
                    <div id="home-tournaments-feed" class="home-tab-content space-y-6 px-4"></div>
                    <div id="home-guild-feed" class="home-tab-content space-y-6 px-4"></div>
                    <div id="home-player-squad-feed" class="home-tab-content space-y-6 px-4"></div>
                    <div id="home-livestream-feed" class="home-tab-content px-4"></div>
                    <div id="home-missions-feed" class="home-tab-content space-y-4 px-4"></div>
                    <div id="home-store-feed" class="home-tab-content px-4"></div>
                </div>

                <div id="search-content" class="dashboard-page hidden p-4"><div id="search-results-container" class="space-y-6"></div></div>
                
                <div id="my-matches-content" class="dashboard-page hidden p-4 md:p-6">
                    <div class="flex gap-2 mb-4">
                        <button class="tab-button my-matches-tab" data-target="upcoming-matches-section">Booked Matches</button>
                        <button class="tab-button my-matches-tab" data-target="history-matches-section">History</button>
                    </div>
                    <div id="upcoming-matches-section" class="tab-content-section"><div id="upcoming-matches-container" class="space-y-6"></div></div>
                    <div id="history-matches-section" class="tab-content-section"><div id="history-matches-container" class="space-y-6"></div></div>
                </div>
                
                <div id="manage-posts-content" class="dashboard-page hidden p-4">
                    <div class="flex gap-2 mb-4">
                        <button class="tab-button manage-need-tab active-tab" data-target="my-posts-section">My Posts</button>
                        <button class="tab-button manage-need-tab" data-target="approvals-section">Approvals</button>
                        <button class="tab-button manage-need-tab" data-target="my-requests-section">My Requests</button>
                    </div>
                    <div id="my-posts-section" class="tab-content-section active-section space-y-4"></div>
                    <div id="approvals-section" class="tab-content-section space-y-4"></div>
                    <div id="my-requests-section" class="tab-content-section space-y-4"></div>
                </div>

                <div id="profile-content" class="dashboard-page hidden p-4">
                    <div class="mb-6">
                        <button id="edit-profile-btn" class="w-full flex items-center p-4 bg-[#2a2a2a] rounded-xl hover:bg-[#3a3a3a] transition-colors border border-gray-700">
                            <div class="relative w-16 h-16 flex-shrink-0">
                                <img id="profile-page-avatar" src="" class="w-16 h-16 rounded-full object-cover border-2 border-gray-600">
                                <div id="initial-avatar-upload-icon" class="hidden absolute inset-0 bg-black/60 rounded-full items-center justify-center">
                                    <i class="fa-solid fa-camera text-xl text-white"></i>
                                </div>
                            </div>
                            <div class="ml-4 text-left">
                                <h2 id="dashboard-user-name" class="text-xl font-bold text-white truncate"></h2>
                                <p class="text-sm text-gray-400">Edit personal details</p>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-500 ml-auto"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-8 text-white text-center">
                        <div class="bg-gradient-to-br from-red-800 to-gray-800 p-3 rounded-xl border border-red-700/50">
                            <p id="profile-stat-kills" class="text-2xl font-bold font-oswald">0</p>
                            <p class="text-xs text-gray-300">Total Kills</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-800 to-gray-800 p-3 rounded-xl border border-blue-700/50">
                            <p id="profile-stat-played" class="text-2xl font-bold font-oswald">0</p>
                            <p class="text-xs text-gray-300">Played</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-800 to-gray-800 p-3 rounded-xl border border-green-700/50">
                            <p id="profile-stat-wins" class="text-2xl font-bold font-oswald">0</p>
                            <p class="text-xs text-gray-300">Wins</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <h4 class="section-header">Account</h4>
                            <div class="space-y-3">
                                <button id="profile-wallet-button" class="setting-item">
                                    <div class="flex items-center">
                                        <div class="setting-icon bg-icon-green"><i class="fa-solid fa-wallet"></i></div>
                                        <span class="setting-label">My Wallet</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                                </button>
                                <button id="create-team-button" class="setting-item">
                                    <div class="flex items-center">
                                        <div class="setting-icon bg-icon-orange"><i class="fa-solid fa-users"></i></div>
                                        <span class="setting-label">My Team</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                                </button>
                                <button id="manage-posts-button" class="setting-item">
                                    <div class="flex items-center">
                                        <div class="setting-icon bg-icon-purple"><i class="fa-solid fa-handshake-angle"></i></div>
                                        <span class="setting-label">Manage Your Posts</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                                </button>
                                <button id="change-password-button" class="setting-item">
                                    <div class="flex items-center">
                                        <div class="setting-icon bg-icon-blue"><i class="fa-solid fa-key"></i></div>
                                        <span class="setting-label">Change Password</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                                </button>
                                <button id="mailbox-button" class="setting-item relative">
                                    <div class="flex items-center">
                                        <div class="setting-icon bg-icon-yellow"><i class="fa-solid fa-envelope"></i></div>
                                        <span class="setting-label">Mailbox</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                                </button>
                                 <button id="logout-button-settings" class="setting-item">
                                    <div class="flex items-center">
                                        <div class="setting-icon bg-icon-red"><i class="fa-solid fa-arrow-right-from-bracket"></i></div>
                                        <span class="setting-label">Logout</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <p class="text-center text-gray-600 mt-8 text-sm">App ver 1.0.8</p>
                </div>


                <div id="team-form-content" class="dashboard-page hidden p-4 md:p-6">
                    <form id="team-form" class="space-y-6">
                        <div class="form-section p-4 rounded-xl space-y-4">
                            <div>
                                <label for="team-name" class="form-label">Team Name</label>
                                <input type="text" id="team-name" class="form-input" placeholder="Enter your team's name" required>
                            </div>
                            <div>
                                <label class="form-label text-center block">Team Logo</label>
                                <div class="relative w-24 h-24 mx-auto">
                                    <input type="file" id="team-logo-upload" class="hidden" accept="image/*">
                                    <label for="team-logo-upload" class="cursor-pointer group">
                                        <img id="team-logo-preview" src="" class="rounded-full w-full h-full object-cover border-2 border-gray-600 group-hover:border-green-500 transition-colors">
                                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center transition-opacity">
                                            <i class="fa-solid fa-camera text-2xl"></i>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div id="team-members-container" class="space-y-4">
                            <div class="form-section p-3 rounded-lg igl-input-box">
                                <p class="text-sm font-semibold text-yellow-300 mb-2">IGL (In-Game Leader)</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="member-0-name" placeholder="In-Game Name" class="form-input text-sm" required>
                                    <input type="text" id="member-0-uid" placeholder="UID" class="form-input text-sm" required>
                                </div>
                            </div>
                            <div class="form-section p-3 rounded-lg"><p class="text-sm font-semibold text-gray-300 mb-2">Player 2</p><div class="grid grid-cols-2 gap-2"><input type="text" id="member-1-name" placeholder="In-Game Name" class="form-input text-sm" required><input type="text" id="member-1-uid" placeholder="UID" class="form-input text-sm" required></div></div>
                            <div class="form-section p-3 rounded-lg"><p class="text-sm font-semibold text-gray-300 mb-2">Player 3</p><div class="grid grid-cols-2 gap-2"><input type="text" id="member-2-name" placeholder="In-Game Name" class="form-input text-sm" required><input type="text" id="member-2-uid" placeholder="UID" class="form-input text-sm" required></div></div>
                            <div class="form-section p-3 rounded-lg"><p class="text-sm font-semibold text-gray-300 mb-2">Player 4</p><div class="grid grid-cols-2 gap-2"><input type="text" id="member-3-name" placeholder="In-Game Name" class="form-input text-sm" required><input type="text" id="member-3-uid" placeholder="UID" class="form-input text-sm" required></div></div>
                            <div class="form-section p-3 rounded-lg"><p class="text-sm font-semibold text-gray-300 mb-2">Player 5</p><div class="grid grid-cols-2 gap-2"><input type="text" id="member-4-name" placeholder="In-Game Name" class="form-input text-sm" required><input type="text" id="member-4-uid" placeholder="UID" class="form-input text-sm" required></div></div>
                        </div>
                        <button type="submit" id="save-team-btn" class="w-full py-4 mt-4 rounded-xl action-button text-lg flex items-center justify-center h-[52px]">Create Team</button>
                    </form>
                </div>
                
                <div id="wallet-content" class="dashboard-page hidden"></div>
                <div id="mailbox-content" class="dashboard-page hidden"></div>
                <div id="history-content" class="dashboard-page hidden p-4"></div>
                <div id="redeem-content" class="dashboard-page hidden p-4"></div>
                <div id="my-coupons-content" class="dashboard-page hidden p-4"></div>
                <div id="edit-profile-content" class="dashboard-page hidden p-4">
                    <form id="edit-profile-form" class="space-y-6">
                        <div class="relative w-32 h-32 mx-auto">
                            <input type="file" id="new-profile-image-upload" class="hidden" accept="image/*">
                            <label for="new-profile-image-upload" class="cursor-pointer group">
                                <img id="edit-profile-avatar-preview" src="" class="rounded-full w-full h-full object-cover border-4 border-gray-700 group-hover:border-green-500 transition-colors">
                                <div class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center transition-opacity">
                                    <i class="fa-solid fa-camera text-3xl"></i>
                                </div>
                            </label>
                        </div>
                        <div>
                            <label for="edit-profile-name" class="form-label">Full Name</label>
                            <input type="text" id="edit-profile-name" class="form-input" required>
                        </div>
                        <button type="submit" class="w-full py-3 mt-4 rounded-xl action-button text-lg flex items-center justify-center h-[48px]">Save Changes</button>
                    </form>
                </div>
                 <div id="change-password-content" class="dashboard-page hidden p-4">
                    <form id="change-password-form" class="space-y-4">
                        <div class="relative flex items-center w-full input-field rounded-xl">
                            <i class="fa-solid fa-key absolute left-5 text-gray-400"></i>
                            <input id="current-password" type="password" placeholder="Current Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none">
                             <i class="fa-solid fa-eye password-toggle"></i>
                        </div>
                        <div class="relative flex items-center w-full input-field rounded-xl">
                            <i class="fa-solid fa-lock absolute left-5 text-gray-400"></i>
                            <input id="new-password" type="password" placeholder="New Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none">
                            <i class="fa-solid fa-eye password-toggle"></i>
                        </div>
                        <div class="relative flex items-center w-full input-field rounded-xl">
                           <i class="fa-solid fa-lock absolute left-5 text-gray-400"></i>
                            <input id="confirm-new-password" type="password" placeholder="Confirm New Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none">
                             <i class="fa-solid fa-eye password-toggle"></i>
                        </div>
                        <button type="submit" class="w-full py-3 mt-4 rounded-xl action-button text-lg flex items-center justify-center h-[48px]">Update Password</button>
                    </form>
                    <div class="mt-12 border-t-2 border-red-500/30 pt-6">
                        <h3 class="text-xl font-bold text-red-400 text-center">Danger Zone</h3>
                        <p class="text-center text-gray-400 text-sm mt-2 mb-4">Once you delete your account, there is no going back. Please be certain.</p>
                        <button id="delete-account-btn" class="w-full py-3 rounded-xl bg-red-800 hover:bg-red-700 text-white font-bold transition-colors">Delete My Account</button>
                    </div>
                </div>
                
                <div id="coming-soon-content" class="dashboard-page hidden p-6 text-center flex flex-col justify-center items-center h-[calc(100vh-100px)]"><i class="fa-solid fa-tools text-6xl text-green-500 mb-6"></i><h1 class="text-4xl font-bold">Coming Soon!</h1><p class="text-gray-400 mt-2">This feature is under active development.</p><button id="back-home-btn" class="mt-8 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">Back to Home</button></div>
            </div>
        </main>
        
        <button id="need-fab" class="fab action-button"><i class="fa-solid fa-plus text-2xl"></i></button>
        <button id="scroll-to-top-btn" class="fab !opacity-0 !transform-none !scale-0 transition-all duration-300"><i class="fa-solid fa-arrow-up text-2xl"></i></button>

    </div>
    
    <!-- Fullscreen Overlays for Users -->
    <div id="booking-screen" class="screen hidden !p-0 justify-start"><div id="booking-content-area" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="participant-list-screen" class="screen hidden !p-0 justify-start"><div id="participant-list-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="results-submission-screen" class="screen hidden !p-0 justify-start"><div id="results-submission-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative pb-28"></div></div>
    <div id="sponsor-profile-screen" class="screen hidden !p-0 justify-start"><div id="sponsor-profile-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="user-profile-screen" class="screen hidden !p-0 justify-start"><div id="user-profile-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="guild-post-form-screen" class="screen hidden !p-0 justify-start"><div id="guild-post-form-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="guild-application-screen" class="screen hidden !p-0 justify-start"><div id="guild-application-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="player-squad-post-form-screen" class="screen hidden !p-0 justify-start"><div id="player-squad-post-form-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div></div>
    <div id="payment-screen" class="screen hidden !p-0 justify-start">
        <header id="payment-header" class="hidden absolute top-0 left-0 w-full z-50 premium-header py-3 px-4 flex justify-between items-center">
            <button id="back-from-payment-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h2 class="text-xl font-bold">Payment</h2>
            <div class="w-10"></div>
        </header>
        <div id="payment-content-area" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6"></div>
    </div>

    <!-- NEW Redeem Task Screen -->
    <div id="redeem-task-screen" class="screen hidden !p-0 justify-start">
        <div id="redeem-task-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6 pb-28"></div>
    </div>

    <!-- NEW Partner Screen -->
    <div id="partner-screen" class="screen hidden !p-0 justify-start">
        <div class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative">
            <header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-from-partner-screen" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-bold">  </h2>
                <div class="w-10"></div>
            </header>
            <div class="p-6 space-y-6">
                <div class="text-center">
                    <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="LEVEL UP Logo" class="w-24 h-24 rounded-full mx-auto border-4 border-green-500 mb-4">
                    <h1 class="text-3xl font-bold font-oswald text-green-400">LEVEL UP   !</h1>
                    <p class="text-gray-400 mt-2">         </p>
                </div>

                <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700">
                    <h3 class="font-bold text-lg text-white mb-3">      ?</h3>
                    <ul class="space-y-3 text-gray-300 text-sm">
                        <li class="flex items-start"><i class="fa-solid fa-check-circle text-green-400 mt-1 mr-3"></i><span>      </span></li>
                        <li class="flex items-start"><i class="fa-solid fa-check-circle text-green-400 mt-1 mr-3"></i><span>       </span></li>
                        <li class="flex items-start"><i class="fa-solid fa-check-circle text-green-400 mt-1 mr-3"></i><span>          </span></li>
                        <li class="flex items-start"><i class="fa-solid fa-check-circle text-green-400 mt-1 mr-3"></i><span>       </span></li>
                        <li class="flex items-start"><i class="fa-solid fa-check-circle text-green-400 mt-1 mr-3"></i><span>       </span></li>
                    </ul>
                </div>

                <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700">
                    <h3 class="font-bold text-lg text-white mb-3">  ?</h3>
                    <p class="text-sm text-gray-300 mb-4">        :</p>
                    <ol class="space-y-3 text-gray-300 text-sm">
                        <li><span class="font-bold text-green-400">.   :</span>    </li>
                         <div class="bg-black/30 p-3 my-2 rounded-lg flex justify-between items-center">
                            <code id="partner-link-text" class="text-sm text-gray-300 truncate">https://levelupbd.gamer.gd/</code>
                            <button id="copy-partner-link-btn" class="bg-gray-600 hover:bg-gray-700 w-10 h-10 rounded-md flex items-center justify-center transition-colors flex-shrink-0 ml-2"><i class="fa-solid fa-copy"></i></button>
                        </div>
                        <li><span class="font-bold text-green-400">.  :</span>        ( Chrome)  </li>
                        <li><span class="font-bold text-green-400">.   :</span>     "   "     </li>
                        <li><span class="font-bold text-green-400">.  :</span> Sponsor       </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>


    <!-- Modals -->
    <div id="modal-screen" class="screen hidden !justify-center"></div>
    <div id="forgot-password-modal" class="screen hidden !justify-center"><div class="modal-box p-6 text-white text-center flex flex-col items-center relative"><button id="close-forgot-modal" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><h3 class="text-2xl font-bold mb-2">Reset Password</h3><p class="text-gray-300 text-sm mb-6">Enter your email and we'll send you a reset link.</p><form id="forgot-password-form" class="w-full"><div class="relative flex items-center w-full input-field rounded-xl mb-4"><i class="fa-solid fa-envelope absolute left-5 text-gray-400"></i><input id="forgot-email-input" type="email" placeholder="Your Email Address" required class="w-full bg-transparent pl-12 pr-5 py-3 text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"></div><button type="submit" class="w-full py-3 rounded-xl action-button text-base flex items-center justify-center h-[44px]">Send Reset Link</button></form></div></div>
    
    <!-- NEW Loading Overlay -->
    <div id="loading-overlay" class="screen hidden !justify-center" style="z-index: 1001; background-color: rgba(18, 18, 18, 0.8); backdrop-filter: blur(8px);">
        <div class="text-center">
            <dotlottie-wc src="https://lottie.host/e21415f9-b849-4323-8646-a2e3f1699933/i57m53VT2e.lottie" style="width: 200px; height: 200px;" autoplay loop></dotlottie-wc>
            <p id="loading-text" class="text-white font-semibold mt-4 text-lg">Processing...</p>
        </div>
    </div>
    
    <!-- NEW Gift Card Opening Modal -->
    <div id="gift-card-open-modal" class="screen hidden !justify-center">
        <!-- Gift card will be rendered here by JS -->
    </div>
    
    <!-- NEW Ad View Screen -->
    <div id="ad-view-screen" class="screen hidden !justify-start">
        <!-- Ad View content will be rendered here by JS -->
    </div>

    <!-- NEW Top-up Purchase/Reveal Modal -->
    <div id="topup-purchase-modal" class="screen hidden !justify-center">
        <!-- Top-up card flip animation will be rendered here by JS -->
    </div>

    <!-- Image Lightbox -->
    <div id="image-lightbox" class="screen hidden !justify-center" onclick="hideLightbox()">
        <button class="absolute top-4 right-4 text-white text-4xl">&times;</button>
        <img id="lightbox-img" src="" alt="Screenshot" onclick="event.stopPropagation()">
    </div>

    <audio id="booking-success-sound" preload="auto"></audio>
    
    <div class="nav-container hidden">
         <nav class="nav-bar">
            <div id="nav-indicator"></div>
            <a href="#" id="nav-home" class="nav-item active"><i class="fa-solid fa-house nav-icon"></i><span class="nav-label">Home</span></a>
            <a href="#" id="nav-search" class="nav-item"><i class="fa-solid fa-magnifying-glass nav-icon"></i><span class="nav-label">Search</span></a>
            <a href="#" id="nav-my-matches" class="nav-item"><i class="fa-solid fa-trophy nav-icon"></i><span class="nav-label">My Matches</span></a>
            <a href="#" id="nav-reels" class="nav-item"><i class="fa-brands fa-youtube nav-icon"></i><span class="nav-label">Reels</span></a>
            <a href="#" id="nav-profile" class="nav-item"><i class="fa-solid fa-user nav-icon"></i><span class="nav-label">Profile</span></a>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBLhxlVr8mjel_rVI1xqeRJ2DSywjiI2ek",
            authDomain: "nxzwallet.firebaseapp.com",
            databaseURL: "https://nxzwallet-default-rtdb.firebaseio.com",
            projectId: "nxzwallet",
            storageBucket: "nxzwallet.appspot.com",
            messagingSenderId: "910859278641",
            appId: "1:910859278641:web:d896205c530816fb297810" 
        };
        firebase.initializeApp(firebaseConfig);
        
        // --- FIX START: Moved loader variables and functions to global scope ---
        let loadingOverlay = null;
        let loadingTextEl = null;

        function showLoader(text = 'Processing...') {
            if (loadingOverlay) {
                loadingTextEl.textContent = text;
                loadingOverlay.classList.remove('hidden');
            }
        }
        function hideLoader() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }
        // --- FIX END ---

        function showCustomModal(config) {
            const { type = 'error', title, message, primaryButton, secondaryButton, autoClose, onRender, iconHtml } = config;
            const modalScreen = document.getElementById('modal-screen');
            if (!modalScreen) return;

            const lottieSources = {
                success: 'https://lottie.host/eda3572d-13ba-488f-a99f-93a027e02e86/46P9bapUv1.lottie',
                error: 'https://lottie.host/adeb3497-0612-44f8-bddc-c7c564f22c9b/ypALfoP56V.lottie'
            };

            let buttonsHTML = '';
            if (primaryButton) {
                buttonsHTML += primaryButton.link 
                    ? `<a href="${primaryButton.link}" target="_blank" class="w-full py-3 mb-2 rounded-xl action-button text-base inline-block">${primaryButton.text}</a>`
                    : `<button id="custom-modal-primary-btn" class="w-full py-3 mb-2 rounded-xl action-button text-base">${primaryButton.text}</button>`;
            }
            if (secondaryButton) {
                buttonsHTML += `<button id="custom-modal-secondary-btn" class="w-full py-3 rounded-xl bg-gray-600 hover:bg-gray-700 text-base">${secondaryButton.text}</button>`;
            }
            
            const isCustomHtmlMessage = typeof message === 'string' && message.trim().startsWith('<');

            const iconElement = iconHtml 
                ? `<div class="w-24 h-24 -mt-16 z-10 flex items-center justify-center">${iconHtml}</div>`
                : (lottieSources[type] 
                    ? `<div class="w-24 h-24 -mt-16 z-10"><dotlottie-wc src="${lottieSources[type]}" autoplay loop style="width: 100%; height: 100%;"></dotlottie-wc></div>`
                    : '');
            
            const contentHTML = isCustomHtmlMessage 
                ? message 
                : `
                    ${iconElement}
                    <h3 class="text-2xl font-bold ${iconElement ? 'mt-2' : ''} mb-2 z-10">${title}</h3>
                    <div class="text-gray-300 text-sm mb-6 z-10">${message}</div>
                `;

            const paddingClass = isCustomHtmlMessage ? '' : 'p-6';
            
            modalScreen.innerHTML = `
                <div class="modal-box text-white text-center flex flex-col items-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
                       ${type === 'success' ? '<dotlottie-wc src="https://lottie.host/933f0761-a979-4009-ac22-692723146d2f/J43a2j75sU.lottie" autoplay loop style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></dotlottie-wc>' : ''}
                    </div>
                    <div class="w-full ${paddingClass}">
                        ${isCustomHtmlMessage ? `<h3 class="text-2xl font-bold mb-4 z-10">${title}</h3>` : ''}
                        ${contentHTML}
                    </div>
                    <div class="w-full z-10 ${paddingClass} pt-0">
                        ${buttonsHTML}
                    </div>
                </div>`;
            
            modalScreen.classList.remove('hidden');

            if (onRender) {
                onRender(modalScreen);
            }

            const closeModal = () => {
                modalScreen.classList.add('hidden');
            };
            
            if (autoClose) {
                setTimeout(closeModal, autoClose);
            }

            const primaryBtnEl = document.getElementById('custom-modal-primary-btn');
            const secondaryBtnEl = document.getElementById('custom-modal-secondary-btn');

            if (primaryBtnEl && primaryButton && primaryButton.onClick) {
                primaryBtnEl.addEventListener('click', () => {
                    primaryButton.onClick();
                    if (!autoClose && primaryButton.closeOnClick !== false) closeModal();
                }, { once: true });
            }
            if (secondaryBtnEl) {
                secondaryBtnEl.addEventListener('click', () => {
                    if (secondaryButton.onClick) secondaryButton.onClick();
                    if (!autoClose) closeModal();
                }, { once: true });
            } else if (!primaryButton || !primaryButton.link) {
                 const singleButton = primaryBtnEl || document.querySelector('.action-button');
                 if(singleButton && !autoClose) singleButton.addEventListener('click', closeModal, { once: true });
            }
        }


        const showModal = (type, title, message, buttonText = 'Continue', onContinue = null) => {
            showCustomModal({
                type: type,
                title: title,
                message: message,
                primaryButton: { text: buttonText, onClick: onContinue }
            });
        };

        function updateTotalStorage(sizeDifference) {
            if (typeof sizeDifference !== 'number') return;
            const storageRef = database.ref('/admin/storage/totalUsedKB');
            storageRef.transaction(currentTotal => {
                return (currentTotal || 0) + sizeDifference;
            });
        }
        
        async function uploadImage(file, path) {
            if (!file) return null;
            
            showLoader('Uploading Image...');
            try {
                const fileRef = storage.ref().child(`${path}/${Date.now()}_${file.name}`);
                const snapshot = await fileRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                const fileSizeKB = file.size / 1024;
                return { url: downloadURL, size: fileSizeKB };
            } catch (error) {
                console.error("Image upload via Firebase Storage failed:", error);
                handleFirebaseError({ message: "Image upload failed. Please try again." });
                return null;
            } finally {
                hideLoader();
            }
        }
        
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        window.dbData = { users: {}, posts: {}, sliderImages: [], admin: {}, guildPosts: {}, playerSquadPosts: {}, redeemCodes: {} };
        const DEFAULT_AVATAR = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed";
        const DEFAULT_TEAM_LOGO = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed";
        const APP_LOGO_URL = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed";
        const MIN_DEPOSIT = 20; const MAX_DEPOSIT = 5000; const MIN_WITHDRAW = 50; const MAX_WITHDRAW = 500; const WITHDRAW_LIMIT_PER_DAY = 2;
        const paymentMethods = {
            bkash: { name: 'bKash', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQ_HdpMiHFyZ_YfUCB_-vNcDujA8hYsYys91VA0TCyzQ&s=10', number: '01647712206', type: 'Send Money' },
            nagad: { name: 'Nagad', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTeLPfqiqpP3bbq8yh5BaQeIfvjvn3auAfy0xUP4GHoDw&s', number: '01647712206', type: 'Send Money' },
            rocket: { name: 'Rocket', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQnNnydSE3RbmYHBeYiFeuxbin5CoY1G_uGC6n9gG3CPw&s=10', number: '016477122060', type: 'Send Money' }
        };
        let currentPaymentData = {}; let guildPostImageFile = null; let playerSquadPostImageFile = null;
        let giftCardTimers = [];

        function timeAgo(isoDateString) { const date = new Date(isoDateString); const seconds = Math.floor((new Date() - date) / 1000); if (seconds < 2) return `just now`; if (seconds < 60) return `${seconds}s ago`; const minutes = Math.floor(seconds / 60); if (minutes < 60) return `${minutes}m ago`; const hours = Math.floor(minutes / 60); if (hours < 24) return `${hours}h ago`; const days = Math.floor(hours / 24); return `${days}d ago`; }
        function truncateName(name, maxLength = 15) { if (!name || typeof name !== 'string') return ''; if (name.length <= maxLength) return name; return name.substring(0, maxLength) + '..'; }
        
        function formatNumberCompact(num) {
            num = Number(num);
            if (isNaN(num)) return '0';
            if (num < 1000) {
                return String(num % 1 === 0 ? num : num.toFixed(1)).replace(/\.0$/, '');
            }
            const si = [
                { v: 1E3, s: "k" },
                { v: 1E6, s: "M" },
                { v: 1E9, s: "B" },
                { v: 1E12, s: "T" },
            ];
            let i;
            for (i = si.length - 1; i > 0; i--) {
                if (num >= si[i].v) {
                    break;
                }
            }
            return (num / si[i].v).toFixed(1).replace(/\.0$/, "") + si[i].s;
        }

        function preloadImages(urls) {
            urls.forEach(url => {
                const img = new Image();
                img.src = url;
            });
        }
        
        function getBangladeshDateString() {
            const now = new Date();
            const bstTime = new Date(now.getTime() + (6 * 60 * 60 * 1000));
            const year = bstTime.getUTCFullYear();
            const month = String(bstTime.getUTCMonth() + 1).padStart(2, '0');
            const day = String(bstTime.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            preloadImages([
                'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763055321.png?alt=media&token=58051d4b-446d-4a30-b588-bed5a5f49c8d', 
                'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763297995.png?alt=media&token=db9ebed1-ff51-49ed-a311-0327313dae56',
                'https://i.imgur.com/8x8eFqg.jpg'
            ]);

            const screens = { splash: document.getElementById('splash-screen'), auth: document.getElementById('auth-container'), dashboard: document.getElementById('dashboard-screen'), modal: document.getElementById('modal-screen'), forgot: document.getElementById('forgot-password-modal'), booking: document.getElementById('booking-screen'), participants: document.getElementById('participant-list-screen'), results: document.getElementById('results-submission-screen'), sponsorProfile: document.getElementById('sponsor-profile-screen'), userProfile: document.getElementById('user-profile-screen'), payment: document.getElementById('payment-screen'), guildPostForm: document.getElementById('guild-post-form-screen'), guildApplication: document.getElementById('guild-application-screen'), playerSquadPostForm: document.getElementById('player-squad-post-form-screen'), giftCardOpen: document.getElementById('gift-card-open-modal'), topupPurchase: document.getElementById('topup-purchase-modal'), adView: document.getElementById('ad-view-screen'), redeemTask: document.getElementById('redeem-task-screen'), partner: document.getElementById('partner-screen') };
            const authViews = { login: document.getElementById('login-view'), signup: document.getElementById('signup-view') };
            const navContainer = document.querySelector('.nav-container');
            let isInitialAuthCheck = true, currentUserData = null;
            let teamLogoFile = null;
            let newAvatarFile = null;
            
            // --- FIX START: Assign DOM elements to global loader variables ---
            loadingOverlay = document.getElementById('loading-overlay');
            loadingTextEl = document.getElementById('loading-text');
            // --- FIX END ---

            function showNavBar() { if(navContainer) navContainer.classList.remove('hidden'); }
            function hideNavBar() { if(navContainer) navContainer.classList.add('hidden'); }

            document.addEventListener('contextmenu', e => { if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') { e.preventDefault(); } });

            const handleFirebaseError = (err) => { showModal('error', 'An Error Occurred', err.message, 'Try Again'); };

            function calculateUserStats(userData, allPosts) {
                const posts = Object.values(allPosts || {});
                const bookings = Object.values(userData.bookings || {});
                let played = 0, wins = 0, kills = 0;
                
                bookings.forEach(booking => {
                    const post = posts.find(p => p.id === booking.postId && p.status === 'completed');
                    if (post) {
                        played++;
                        const finalRankings = Object.values(post.participants || {}).map(p => { let totalPoints = 0; if (post.approvedResults && post.approvedResults[p.userId]) { Object.values(post.approvedResults[p.userId]).forEach(mapResult => { totalPoints += calculatePoints(mapResult.kills, mapResult.position); }); } return { userId: p.userId, totalPoints }; }).sort((a, b) => b.totalPoints - a.totalPoints);
                        if (finalRankings.length > 0 && finalRankings[0].userId === auth.currentUser.uid) { wins++; }

                        if (post.approvedResults && post.approvedResults[auth.currentUser.uid]) {
                            Object.values(post.approvedResults[auth.currentUser.uid]).forEach(mapResult => {
                                kills += parseInt(mapResult.kills) || 0;
                            });
                        }
                    }
                });
                return { played, wins, kills };
            }

            function updateProfileStats(userData, allPosts) {
                const stats = calculateUserStats(userData, allPosts);
                document.getElementById('profile-stat-played').textContent = stats.played;
                document.getElementById('profile-stat-wins').textContent = stats.wins;
                document.getElementById('profile-stat-kills').textContent = stats.kills;
            }

            const populateDashboard = (user, userData) => {
                if (!user || !userData) return;
                currentUserData = userData; 
                const name = user.displayName || userData.name; 
                const avatar = userData.avatar || DEFAULT_AVATAR;
                document.getElementById('dashboard-user-name').textContent = name;
                document.getElementById('profile-page-avatar').src = avatar;
                document.getElementById('sidebar-username').textContent = name;
                document.getElementById('sidebar-avatar').src = avatar;
                document.getElementById('sidebar-teamname').textContent = userData.team?.name || 'No Team';
                document.getElementById('sidebar-coin-balance').textContent = formatNumberCompact(userData.wallet?.coins || 0);
                document.getElementById('sidebar-diamond-balance').textContent = formatNumberCompact(userData.wallet?.diamonds || 0);

                const teamBadgeEl = document.getElementById('sidebar-team-badge');
                if (userData.team?.badgeUrl) {
                    teamBadgeEl.src = userData.team.badgeUrl;
                    teamBadgeEl.classList.remove('hidden');
                } else {
                    teamBadgeEl.classList.add('hidden');
                }

                document.getElementById('header-wallet-balance').textContent = (userData.wallet?.live || 0).toFixed(2); 
                updateMailboxBadge();
                updateSidebarBadges(userData);
                
                const initialUploadIcon = document.getElementById('initial-avatar-upload-icon');
                if (initialUploadIcon) { if (avatar === DEFAULT_AVATAR) { initialUploadIcon.classList.remove('hidden'); initialUploadIcon.classList.add('flex'); } else { initialUploadIcon.classList.add('hidden'); initialUploadIcon.classList.remove('flex'); } }
            };
            
            const startApp = (user) => {
                 database.ref('/users/' + user.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (!userData || userData.role !== 'user') {
                         showModal('error', 'Access Denied', 'This seems to be a sponsor account. Please log in via the Sponsor Panel.', 'OK', () => auth.signOut());
                         return;
                    }
                 
                    database.ref().on('value', (snapshot) => {
                        window.dbData = snapshot.val() || { users: {}, posts: {}, sliderImages: [], admin: {}, guildPosts: {}, playerSquadPosts: {}, redeemCodes: {} };
                        const currentUserDataFromDb = window.dbData.users?.[user.uid];

                        if (!currentUserDataFromDb) { auth.signOut(); return; }
                        
                        if (isInitialAuthCheck) {
                            isInitialAuthCheck = false;
                            runSplashAnimation(() => transitionToDashboard());
                        }

                        populateDashboard(user, currentUserDataFromDb);
                        updateProfileStats(currentUserDataFromDb, window.dbData.posts);
                        
                        const currentPage = document.querySelector('.dashboard-page:not(.hidden)');
                        const resultsScreen = document.getElementById('results-submission-screen');
                        
                        if (resultsScreen && !resultsScreen.classList.contains('hidden')) {
                            const postId = resultsScreen.dataset.postId;
                            if (postId) {
                                const post = window.dbData.posts[postId];
                                if (post && (post.status === 'completed' || post.status === 'cancelled')) {
                                    renderHistoryMatchDetailsPage(postId);
                                } else if(post) {
                                    renderLiveMatchPage(postId);
                                }
                            }
                        } else if (currentPage) {
                            switch(currentPage.id) {
                                case 'home-content': 
                                    renderAllPosts(); 
                                    renderTournamentsFeed();
                                    renderHomeGuildPosts(); 
                                    renderHomePlayerSquadPosts();
                                    renderMissionsPage();
                                    renderStorePage();
                                    break;
                                case 'my-matches-content': renderMyMatchesPage(); break;
                                case 'manage-posts-content': renderManageNeedPage(); break;
                                case 'my-coupons-content': renderMyCouponsPage(); break;
                                case 'history-content': renderHistoryPage(); break;
                                case 'redeem-content': renderRedeemPage(); break;
                                case 'profile-content': updateProfileStats(currentUserDataFromDb, window.dbData.posts); break;
                                case 'wallet-content': renderWalletPage(); break;
                                case 'mailbox-content': renderMailbox(); break;
                            }
                        }
                    });
                });
            };

            const runSplashAnimation = (onComplete) => {
                setTimeout(() => { document.getElementById('splash-screen-lottie').classList.add('fade-out'); document.getElementById('splash-screen-logo').classList.add('fade-in'); }, 2000);
                setTimeout(() => { screens.splash.classList.add('hidden'); if(onComplete) onComplete(); }, 3000);
            };

            const startAuthFlow = () => { runSplashAnimation(() => { screens.auth.classList.remove('hidden'); }); };

            auth.onAuthStateChanged(user => { 
                if (user) {
                    if (isInitialAuthCheck) startApp(user);
                } else {
                    isInitialAuthCheck = false;
                    startAuthFlow();
                }
            });
            
            function setupAuthPageListeners() {
                const togglePassword = (input, icon) => { const type = input.getAttribute('type') === 'password' ? 'text' : 'password'; input.setAttribute('type', type); icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash'); };
                document.getElementById('toggle-login-password').addEventListener('click', (e) => togglePassword(document.getElementById('login-password'), e.target));
                document.getElementById('toggle-signup-password').addEventListener('click', (e) => togglePassword(document.getElementById('signup-password'), e.target));
                document.getElementById('toggle-confirm-password').addEventListener('click', (e) => togglePassword(document.getElementById('signup-confirm-password'), e.target));
                const signupPassword = document.getElementById('signup-password'); const confirmPassword = document.getElementById('signup-confirm-password'); const matchMsg = document.getElementById('password-match-msg'); const strengthBar = document.getElementById('strength-bar');
                signupPassword.addEventListener('input', () => { const password = signupPassword.value; let strength = 0; if (password.length >= 8) strength++; if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++; if (password.match(/\d/)) strength++; if (password.match(/[^a-zA-Z\d]/)) strength++; strengthBar.className = 'strength-bar'; if (strength <= 1) strengthBar.classList.add('strength-weak'); else if (strength <= 3) strengthBar.classList.add('strength-medium'); else strengthBar.classList.add('strength-strong'); });
                confirmPassword.addEventListener('input', () => { if (confirmPassword.value === "") { matchMsg.textContent = ''; } else if (confirmPassword.value === signupPassword.value) { matchMsg.textContent = 'Passwords match!'; matchMsg.style.color = '#10b981'; } else { matchMsg.textContent = 'Passwords do not match.'; matchMsg.style.color = '#ef4444'; } });
                document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); authViews.login.classList.remove('active'); authViews.signup.classList.add('active'); });
                document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); authViews.signup.classList.remove('active'); authViews.login.classList.add('active'); });
                document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); screens.forgot.classList.remove('hidden'); screens.auth.classList.add('blur-it');});
                document.getElementById('close-forgot-modal').addEventListener('click', () => { screens.forgot.classList.add('hidden'); screens.auth.classList.remove('blur-it'); });
                document.getElementById('forgot-password-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('forgot-email-input').value; handleFormSubmit(e.target, 'Sending...', () => auth.sendPasswordResetEmail(email).then(() => { screens.forgot.classList.add('hidden'); screens.auth.classList.remove('blur-it'); showModal('success', 'Email Sent', `A password reset link has been sent to ${email}.`, 'OK'); })); });
            }
            setupAuthPageListeners();

            function transitionToDashboard() {
                screens.auth.classList.add('hidden');
                screens.dashboard.classList.remove('hidden');
                showNavBar();
                setTimeout(() => {
                    setActiveNavItem(document.getElementById('nav-home')); 
                    navigateToPage('home-content', true); 
                    setupSlider(window.dbData.sliderImages); 
                    initMyMatchesPage();
                    setupHomePageScrolling();
                    setupProfilePageListeners();
                    setupHomeTabs();
                    setupSidebar();
                }, 50);
            }

            const handleFormSubmit = (form, loadingText, promiseProvider) => {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) btn.disabled = true;
                showLoader(loadingText);
                return promiseProvider()
                    .catch(err => {
                        hideLoader();
                        handleFirebaseError(err);
                        throw err; 
                    })
                    .finally(() => {
                        if (btn) btn.disabled = false;
                        if (!loadingOverlay.classList.contains('hidden')) {
                            hideLoader();
                        }
                    });
            };

            const generateReferralCode = (length = 6) => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            const generateReward = (coupon) => {
                let pool = [];
                // **UPDATED**: Specific pool for Daily/Signup/Referral rewards (Coins only)
                const dailyPrizePool = [
                    { value: 0.05, type: 'coin', image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Scratchcard%2FAddText_11-11-03.11.02.png?alt=media&token=46797d54-d62e-4620-a767-e94783eb58d4', weight: 40 },
                    { value: 0.1, type: 'coin', image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Scratchcard%2FAddText_11-11-03.10.38.png?alt=media&token=a96bbdf3-9995-4f36-b586-834093dbdcaf', weight: 25 },
                    { value: 0.5, type: 'coin', image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Scratchcard%2FAddText_11-11-03.10.45.png?alt=media&token=d0780c4f-bd68-4aba-9125-1b04e405792f', weight: 15 },
                    { value: 1, type: 'coin', image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Scratchcard%2FAddText_11-11-03.08.15.png?alt=media&token=cd07efc9-0f86-4b9e-8869-bff9f6d79d9d', weight: 5 },
                    { type: 'bad_luck', weight: 15 }
                ];
                
                // Fallback pool for match rewards (can contain diamonds)
                const matchPrizePool = [
                    ...dailyPrizePool,
                    { value: 0.1, type: 'diamond', image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Scratchcard%2FAddText_11-11-03.07.17.png?alt=media&token=31fcdd73-e2c6-4a69-8de5-ff48b0cc3d93', weight: 8 },
                    { value: 0.2, type: 'diamond', image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Scratchcard%2FAddText_11-11-03.07.27.png?alt=media&token=121d44b7-f7f4-4039-9170-de47854fea4', weight: 5 },
                ];

                if (coupon.storeCardId) {
                    const storeCardData = window.dbData.admin?.store?.giftCards?.[coupon.storeCardId];
                    if (storeCardData) {
                        const purchaseCount = currentUserData.storePurchaseCounters?.[coupon.storeCardId] || 0;
                        if (storeCardData.bigRewards && storeCardData.bigRewards.length > 0 && purchaseCount > 0 && purchaseCount % 10 === 0) {
                             return storeCardData.bigRewards[Math.floor(Math.random() * storeCardData.bigRewards.length)];
                        }
                        pool = storeCardData.rewards || dailyPrizePool;
                    } else {
                        pool = dailyPrizePool;
                    }
                } else if (coupon.reason === 'Daily Reward' || coupon.reason === 'Sign-up Bonus' || coupon.reason === 'Referral Bonus') {
                    pool = dailyPrizePool;
                } else {
                    pool = matchPrizePool; // Default for other types like match rewards
                }

                const totalWeight = pool.reduce((sum, prize) => sum + (prize.weight || 0), 0);
                let random = Math.random() * totalWeight;
                for (const prize of pool) {
                    if (random < prize.weight) { return prize; }
                    random -= prize.weight;
                }
                return pool.find(p => p.type === 'bad_luck') || pool[pool.length-1];
            };

            async function giveScratchCard(userId, options) {
                if (!userId || !options) return;
                const { reason = 'Daily Reward', storeCardId = null } = options;
                const newCouponRef = database.ref(`users/${userId}/myCoupons`).push();
                const validityHours = reason.startsWith('Store Purchase') ? 12 : 24;
                const couponData = {
                    id: newCouponRef.key,
                    type: 'gift_card',
                    reason: reason,
                    storeCardId: storeCardId,
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + validityHours * 60 * 60 * 1000).toISOString(),
                    scratched: false,
                    reward: null // Reward is determined on first open
                };
                await newCouponRef.set(couponData);
            }
            
            document.getElementById('signup-form-element').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                
                if (localStorage.getItem('accountCreated')) {
                    showModal('error', 'Device Limit Reached', 'You can only create one account per device.');
                    return;
                }

                handleFormSubmit(form, 'Signing Up...', async () => {
                    const email = form.querySelector('#signup-email').value.trim();
                    if (!email.toLowerCase().endsWith('@gmail.com')) { throw { message: 'Registration is only allowed with a @gmail.com address.' }; }
                    const password = form.querySelector('#signup-password').value;
                    if (password !== form.querySelector('#signup-confirm-password').value) { throw { message: 'Passwords do not match.' }; }
                    
                    const emailExistsSnapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
                    if (emailExistsSnapshot.exists()) { throw { message: 'This email is already registered. Please use a different email or try logging in.' }; }

                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const fullName = form.querySelector('#signup-fullname').value;
                    await user.updateProfile({ displayName: fullName });

                    const newUserDbData = { 
                        name: fullName, 
                        email: email, 
                        whatsapp: '+880' + form.querySelector('#signup-whatsapp').value, 
                        gender: form.querySelector('input[name="gender"]:checked').value, 
                        avatar: DEFAULT_AVATAR, 
                        role: 'user', 
                        wallet: { live: 0, event: 0, coins: 0, diamonds: 0 }, 
                        team: null, 
                        bookings: {}, 
                        mailbox: {},
                        myCoupons: {},
                        transactions: {},
                        storePurchaseCounters: {},
                        referralCode: generateReferralCode(),
                        lastScratchClaim: 0,
                        missionProgress: {}
                    };
                    await database.ref('users/' + user.uid).set(newUserDbData);
                    
                    localStorage.setItem('accountCreated', 'true');
                    
                    showCustomModal({ type: 'success', title: 'Registration Successful!', message: 'Welcome to LEVEL UP! Taking you to the home page...', autoClose: 2500 });
                    setTimeout(() => window.location.reload(), 2500);
                });
            });

            document.getElementById('login-form-element').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                handleFormSubmit(form, 'Signing In...', async () => {
                    let email = document.getElementById('login-email').value.trim();
                    const password = document.getElementById('login-password').value;
                    if (email && !email.includes('@')) { email += '@gmail.com'; }
                    await auth.signInWithEmailAndPassword(email, password);
                    showCustomModal({ type: 'success', title: 'Login Successful!', message: 'Welcome back! Taking you to the home page...', autoClose: 2000 });
                    setTimeout(() => window.location.reload(), 2000);
                });
            });
            
            document.getElementById('team-logo-upload').addEventListener('change', e => { const file = e.target.files[0]; if (file) { teamLogoFile = file; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('team-logo-preview').src = event.target.result; }; reader.readAsDataURL(file); } });
            
            // Old Search Logic (for bottom nav)
            function handleGlobalSearch(searchTerm) { 
                const resultsContainer = document.getElementById('search-results-container'); 
                const posts = Object.values(window.dbData.posts || {}); 
                const filteredPosts = posts.filter(p => p.details.eventName.toLowerCase().includes(searchTerm) || p.author.name.toLowerCase().includes(searchTerm) || (p.details.tags && p.details.tags.some(t => t.toLowerCase().includes(searchTerm)))); 
                resultsContainer.innerHTML = filteredPosts.length > 0 ? filteredPosts.map(createPostCardHTML).join('') : `<p class="text-center text-gray-500 mt-8">No results found.</p>`; 
                initializeCountdowns(); 
            }
            document.getElementById('search-input-mobile').addEventListener('input', e => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const resultsContainer = document.getElementById('search-results-container');
                if (searchTerm.length < 3) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">Type at least 3 characters to search.</p>';
                    return;
                }
                handleGlobalSearch(searchTerm);
            });

            // New Home Search Logic
            function handleHomeSearch() {
                const searchTerm = document.getElementById('home-search-input').value.toLowerCase().trim();
                const activeTabEl = document.querySelector('.home-tab-link.active-home-tab');
                if (!activeTabEl) return;
                const activeTab = activeTabEl.dataset.target;

                if (searchTerm.length === 0) {
                    renderAllPosts();
                    renderTournamentsFeed();
                    renderHomeGuildPosts();
                    renderHomePlayerSquadPosts();
                    return;
                }

                if (activeTab === 'post-feed' || activeTab === 'home-tournaments-feed') {
                    const posts = Object.values(window.dbData.posts || {});
                    const filtered = posts.filter(p => p.details.eventName.toLowerCase().includes(searchTerm) || p.author.name.toLowerCase().includes(searchTerm));
                    const container = document.getElementById(activeTab);
                    container.innerHTML = filtered.length > 0 ? filtered.map(createPostCardHTML).join('') : '<p class="text-center text-gray-500 p-4">No event matches found.</p>';
                } else if (activeTab === 'home-guild-feed') {
                    const posts = Object.values(window.dbData.guildPosts || {});
                    const filtered = posts.filter(p => p.guildName.toLowerCase().includes(searchTerm) || p.creatorName.toLowerCase().includes(searchTerm));
                    document.getElementById('home-guild-feed').innerHTML = filtered.length > 0 ? filtered.map(createGuildPostCardHTML).join('') : '<p class="text-center text-gray-500 p-4">No guilds found.</p>';
                } else if (activeTab === 'home-player-squad-feed') {
                    const posts = Object.values(window.dbData.playerSquadPosts || {});
                    const filtered = posts.filter(p => p.description.toLowerCase().includes(searchTerm) || p.creatorName.toLowerCase().includes(searchTerm));
                    document.getElementById('home-player-squad-feed').innerHTML = filtered.length > 0 ? filtered.map(createPlayerSquadPostCardHTML).join('') : '<p class="text-center text-gray-500 p-4">No posts found.</p>';
                }
            }

            function renderAllPosts() {
                const feed = document.getElementById('post-feed');
                const now = Date.now();
                
                const eventPosts = Object.values(window.dbData.posts || {});
                const guildPosts = Object.values(window.dbData.guildPosts || {});
                const playerSquadPosts = Object.values(window.dbData.playerSquadPosts || {});
                
                const allPosts = [...eventPosts, ...guildPosts, ...playerSquadPosts];

                const boostedPosts = allPosts.filter(p => p.boostedUntil && p.boostedUntil > now);
                const regularPosts = allPosts.filter(p => !p.boostedUntil || p.boostedUntil <= now);
                
                const shuffleArray = arr => arr.sort(() => Math.random() - 0.5);
                
                const shuffledBoosted = shuffleArray(boostedPosts);
                const shuffledRegular = shuffleArray(regularPosts);
                
                const finalPosts = [...shuffledBoosted, ...shuffledRegular];

                const postsHTML = finalPosts.map(post => {
                    if (post.details && post.details.eventName) return createPostCardHTML(post);
                    if (post.guildName) return createGuildPostCardHTML(post);
                    if (post.description) return createPlayerSquadPostCardHTML(post);
                    return '';
                }).join('');

                if (!postsHTML.trim()) { 
                    feed.innerHTML = `<div class="text-center text-gray-500 p-10 bg-gray-800/50 rounded-lg"><i class="fa-solid fa-ghost text-4xl mb-4"></i><p>No posts available at the moment.</p></div>`;
                } else {
                    feed.innerHTML = postsHTML;
                }
                initializeCountdowns();
            }

            function renderTournamentsFeed() {
                const feed = document.getElementById('home-tournaments-feed');
                const posts = Object.values(window.dbData.posts || {}).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (posts.length === 0) {
                    feed.innerHTML = `<div class="text-center text-gray-500 p-10 bg-gray-800/50 rounded-lg"><i class="fa-solid fa-trophy text-4xl mb-4"></i><p>No tournaments available right now.</p></div>`;
                    return;
                }
                feed.innerHTML = posts.map(createPostCardHTML).join('');
                initializeCountdowns();
            }
            
            const createPostCardHTML = (post) => {
                const matchEndTime = new Date(post.matchDate).getTime();
                if (matchEndTime < Date.now()) {
                    return ''; // Hide post if event time has passed
                }
                const isBooked = currentUserData?.bookings && !!currentUserData.bookings[post.id];
                if (isBooked) return '';

                const sponsorData = window.dbData.users?.[post.authorId];
                const allBadges = window.dbData.admin?.config?.verifiedBadges || {};
                let verifiedBadgeHTML = '';
                if (sponsorData && sponsorData.verifiedBadge !== undefined && sponsorData.verifiedBadge !== null && allBadges[sponsorData.verifiedBadge]) {
                    verifiedBadgeHTML = `<img src="${allBadges[sponsorData.verifiedBadge]}" alt="Verified" class="verification-badge" data-badge-index="${sponsorData.verifiedBadge}">`;
                }

                const matchDate = new Date(post.matchDate), formattedDate = matchDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }); 
                
                let prizeOrPracticeHTML = '';
                if (post.details.eventType === 'practice') {
                    prizeOrPracticeHTML = `<div class="border-t border-gray-700 pt-4 text-center"><p class="font-bold text-xl text-orange-400 font-oswald tracking-wider">PRACTICE MATCH</p></div>`;
                } else {
                    const prizeListHTML = (post.details.winningPrizes && post.details.winningPrizes.length > 0) ? post.details.winningPrizes.map(p => `<li><span class="font-semibold text-green-400">${p.rank}:</span> ${p.prize} TK</li>`).join('') : '<li>No prize details provided.</li>';
                    prizeOrPracticeHTML = `<details class="border-t border-gray-700 pt-3"><summary class="font-bold text-green-500 cursor-pointer">WINNING PRIZE <span class="text-xs font-normal text-gray-400">(See More...)</span></summary><ul class="list-disc list-inside text-gray-300 text-xs space-y-1 mt-2">${prizeListHTML}</ul></details>`;
                }

                const slotPercentage = (post.slots.total > 0 ? ((post.slots.booked || 0) / post.slots.total) * 100 : 0); 
                const formatTime = (timeStr) => { if (!timeStr) return 'N/A'; let [hours, minutes] = timeStr.split(':'); const ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12; hours = hours ? hours : 12; return `${hours}:${minutes} ${ampm}`; }; 
                const isFull = (post.slots.booked || 0) >= post.slots.total; 
                let buttonHTML; 
                if(isFull) { 
                    buttonHTML = `<button class="booking-btn text-white font-bold py-3 px-6 rounded-lg text-base" disabled style="background: #880808;">SLOT FULL</button>`; 
                } else { 
                    buttonHTML = `<button class="booking-btn text-white font-bold py-3 px-6 rounded-lg text-base" data-post-id="${post.id}">BOOK</button>`; 
                }
                
                const entryFeeHTML = post.entryFee > 0
                    ? `<p class="font-oswald text-2xl font-bold text-white">${post.entryFee} <span class="text-sm">TK</span></p>`
                    : `<p class="font-oswald text-2xl font-bold text-green-400">FREE</p>`;

                return `<div class="post-card rounded-2xl overflow-hidden" data-post-id-wrapper="${post.id}">
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3 cursor-pointer sponsor-profile-trigger" data-sponsor-id="${post.authorId}">
                                <img src="${post.author.avatar || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-600">
                                <div class="overflow-hidden">
                                    <div class="flex items-center">
                                        <p class="font-semibold text-white truncate">${post.author.name}</p>
                                        ${verifiedBadgeHTML}
                                    </div>
                                    <p class="text-xs text-gray-400">${timeAgo(post.timestamp)}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="countdown-container text-right" data-countdown="${post.matchDate}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="px-4">
                        <img src="${post.imageUrl}" class="w-full h-auto max-h-96 object-contain rounded-lg" alt="Post Image">
                    </div>
                    <div class="p-4 bg-[#28282B] space-y-3 text-sm">
                        <div class="mb-2">
                            <p class="text-xl font-oswald font-bold text-green-400">${truncateName(post.details.eventName, 25)}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div><strong class="text-gray-400">Match Type:</strong> <span class="text-white font-semibold">${post.details.matchType}</span></div>
                            <div><strong class="text-gray-400">Team Type:</strong> <span class="text-white font-semibold">${post.details.teamType}</span></div>
                            <div><strong class="text-gray-400">Total Slots:</strong> <span class="text-white font-semibold">${post.slots.total}</span></div>
                            <div><strong class="text-gray-400">Date:</strong> <span class="text-white font-semibold">${formattedDate}</span></div>
                            <div><strong class="text-gray-400">ID Pass:</strong> <span class="text-white font-semibold">${formatTime(post.details.idPassTime)}</span></div>
                            <div><strong class="text-gray-400">Match Starts:</strong> <span class="text-white font-semibold">${formatTime(post.details.matchStartTime)}</span></div>
                            <div class="col-span-2"><strong class="text-gray-400">Maps:</strong> <span class="text-white font-semibold">${post.details.numMatches} | ${post.details.maps.join(', ')}</span></div>
                        </div>
                        ${prizeOrPracticeHTML}
                    </div>
                    <div class="p-3 bg-black/30 flex justify-between items-center gap-4">
                        <div class="text-center">
                            <p class="text-gray-400 text-xs">ENTRY FEE</p>
                            ${entryFeeHTML}
                        </div>
                        <div class="flex-grow">
                            <div class="w-full slot-progress-bar rounded-full h-2.5">
                                <div class="slot-progress-fill h-2.5 rounded-full" style="width: ${slotPercentage}%"></div>
                            </div>
                            <p class="text-center text-xs text-gray-300 mt-1">${post.slots.booked || 0}/${post.slots.total} SLOTS BOOKED</p>
                        </div>
                        ${buttonHTML}
                    </div>
                </div>`;
            }

            function initializeCountdowns() { document.querySelectorAll('.countdown-container').forEach(c => { const update = () => { const t = new Date(c.dataset.countdown).getTime(), n = new Date().getTime(), d = t - n; if (d < 0) { c.innerHTML = `<p class="text-red-500 font-bold text-sm">EVENT ENDED</p>`; return; } c.innerHTML = `<div class="flex justify-end gap-1.5 text-white"><div class="countdown-item text-center"><span>${String(Math.floor(d/(1e3*60*60*24))).padStart(2,'0')}</span><p>Days</p></div><div class="countdown-item text-center"><span>${String(Math.floor(d%(1e3*60*60*24)/(1e3*60*60))).padStart(2,'0')}</span><p>Hrs</p></div><div class="countdown-item text-center"><span>${String(Math.floor(d%(1e3*60*60)/(1e3*60))).padStart(2,'0')}</span><p>Min</p></div><div class="countdown-item text-center"><span>${String(Math.floor(d%(1e3*60)/1e3)).padStart(2,'0')}</span><p>Sec</p></div></div>`; }; update(); setInterval(update, 1000); }); }
            
            function setupHomePageScrolling() {
                const mainContentArea = document.querySelector('#dashboard-screen main');
                const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
                if (!mainContentArea || !scrollToTopBtn) return;
                mainContentArea.addEventListener('scroll', () => {
                    if (mainContentArea.scrollTop > 1000) {
                        scrollToTopBtn.classList.add('visible');
                    } else {
                        scrollToTopBtn.classList.remove('visible');
                    }
                });
                scrollToTopBtn.addEventListener('click', () => {
                    mainContentArea.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            function setupSlider(sliderData) {
                const sC = document.getElementById('slider-container'), dC = document.getElementById('slider-dots');
                if (!sC || !dC) return;
                clearInterval(window.sliderInterval);

                const slidesArray = Array.isArray(sliderData) ? sliderData : [];

                if (slidesArray.length === 0) {
                    dC.innerHTML = '';
                    sC.innerHTML = '<div class="text-center w-full p-10 bg-gray-800/50 rounded-xl"><i class="fa-solid fa-images text-4xl text-gray-500 mb-4"></i><p class="text-gray-400">No promotional content available.</p></div>';
                    return;
                }

                sC.innerHTML = slidesArray.map(slide => {
                    let mediaElement = '';
                    let clickableIndicator = '';
                    const hasPostId = slide.postId || slide.guildPostId || slide.playerSquadPostId;
                    let wrapperClass = hasPostId ? 'cursor-pointer' : '';

                    switch(slide.type) {
                        case 'video':
                            mediaElement = `<video class="slider-media" src="${slide.url}" loop playsinline ${slide.autoplay ? 'autoplay' : ''} ${!slide.isMuted ? '' : 'muted'}></video>`;
                            break;
                        case 'gif':
                        case 'image':
                        default:
                            mediaElement = `<img src="${slide.url}" class="slider-media" alt="Slider Content">`;
                            break;
                    }

                    if (hasPostId) {
                        clickableIndicator = `<div class="clickable-post-indicator"><i class="fas fa-link"></i> VIEW POST</div>`;
                    }
                    
                    return `<div class="w-full flex-shrink-0 relative aspect-video ${wrapperClass}" 
                                ${slide.postId ? `data-post-id="${slide.postId}"` : ''} 
                                ${slide.guildPostId ? `data-guild-post-id="${slide.guildPostId}"` : ''}
                                ${slide.playerSquadPostId ? `data-playersquad-post-id="${slide.playerSquadPostId}"` : ''}
                            >${mediaElement}${clickableIndicator}</div>`;
                }).join('');

                const slides = sC.children;
                let cI = 0;
                dC.innerHTML = '';
                for (let i = 0; i < slides.length; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'w-2 h-2 rounded-full cursor-pointer transition-colors ' + (i === 0 ? 'bg-white' : 'bg-white/50');
                    dot.addEventListener('click', () => { cI = i; updateSlider(); });
                    dC.appendChild(dot);
                }

                function updateSlider() {
                    if (slides.length > 0) {
                        sC.style.transform = `translateX(-${cI * 100}%)`;
                        Array.from(dC.children).forEach((dot, index) => {
                            dot.classList.toggle('bg-white', index === cI);
                            dot.classList.toggle('bg-white/50', index !== cI);
                        });
                        sC.querySelectorAll('video').forEach((video, index) => {
                            if (index === cI && slidesArray[index].autoplay) {
                                video.play().catch(e => console.log("Autoplay blocked"));
                            } else {
                                video.pause();
                            }
                        });
                    }
                }

                if (slides.length > 1) {
                     const startInterval = () => {
                        clearInterval(window.sliderInterval); 
                        window.sliderInterval = setInterval(() => { cI = (cI + 1) % slides.length; updateSlider(); }, 5000);
                    };
                    const stopInterval = () => clearInterval(window.sliderInterval);

                    sC.addEventListener('mousedown', stopInterval);
                    sC.addEventListener('touchstart', stopInterval, { passive: true });
                    sC.addEventListener('mouseup', startInterval);
                    sC.addEventListener('mouseleave', startInterval);
                    sC.addEventListener('touchend', startInterval);
                    
                    startInterval();
                }
                updateSlider();
            }

            function highlightPost(postId, postType = 'event') {
                document.getElementById('nav-home').click();

                setTimeout(() => {
                    let tabSelector, feedSelector, postSelector;

                    switch(postType) {
                        case 'guild':
                            tabSelector = '#home-tabs .home-tab-link[data-target="home-guild-feed"]';
                            feedSelector = '#home-guild-feed';
                            postSelector = `.guild-post-card[data-guild-post-id-wrapper="${postId}"]`;
                            break;
                        case 'playerSquad':
                            tabSelector = '#home-tabs .home-tab-link[data-target="home-player-squad-feed"]';
                            feedSelector = '#home-player-squad-feed';
                            postSelector = `.player-squad-post-card[data-playersquad-post-id-wrapper="${postId}"]`;
                            break;
                        case 'event':
                        default:
                            tabSelector = '#home-tabs .home-tab-link[data-target="post-feed"]';
                            feedSelector = '#post-feed';
                            postSelector = `.post-card[data-post-id-wrapper="${postId}"]`;
                            break;
                    }

                    const tabToClick = document.querySelector(tabSelector);
                    if (tabToClick) tabToClick.click();
                    
                    const postFeed = document.querySelector(feedSelector);
                    const postElement = document.querySelector(postSelector);
                    
                    if (postElement && postFeed) {
                        document.querySelectorAll('.highlighted-post').forEach(el => el.classList.remove('highlighted-post'));
                        postFeed.prepend(postElement);
                        postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        postElement.classList.add('highlighted-post');
                        setTimeout(() => {
                            postElement.classList.remove('highlighted-post');
                        }, 3000);
                    } else {
                        showModal('error', 'Post Not Found', 'This promotional post may have expired or is no longer available.');
                    }
                }, 250); // wait for page transition
            }
            
            document.getElementById('slider-container').addEventListener('click', e => {
                const slide = e.target.closest('[data-post-id], [data-guild-post-id], [data-playersquad-post-id]');
                if (slide) {
                    if (slide.dataset.postId) {
                        highlightPost(slide.dataset.postId, 'event');
                    } else if (slide.dataset.guildPostId) {
                        highlightPost(slide.dataset.guildPostId, 'guild');
                    } else if (slide.dataset.playersquadPostId) {
                        highlightPost(slide.dataset.playersquadPostId, 'playerSquad');
                    }
                }
            });

            const navItems = document.querySelectorAll('.nav-item'), navIndicator = document.getElementById('nav-indicator'); const allHeaders = document.querySelectorAll('header'); const needFab = document.getElementById('need-fab'); const transitionOverlay = document.getElementById('page-transition-overlay');
            const updateNavIndicator = (activeItem) => { if (activeItem) { navIndicator.style.width = `${activeItem.offsetWidth}px`; navIndicator.style.left = `${activeItem.offsetLeft}px`; } else { navIndicator.style.width = '0px'; }};
            const setActiveNavItem = (itemToActivate) => { navItems.forEach(i => i.classList.remove('active')); if(itemToActivate) { itemToActivate.classList.add('active'); } setTimeout(() => updateNavIndicator(itemToActivate), 400); };
            
            const navigateToPage = (pageId, isInitial = false) => {
                 showNavBar();
                 const showNewPage = () => {
                     document.querySelectorAll('.dashboard-page').forEach(p => p.classList.add('hidden')); 
                     const newPage = document.getElementById(pageId); if (newPage) newPage.classList.remove('hidden');
                     
                     allHeaders.forEach(h => h.classList.add('hidden'));
                     document.getElementById('home-search-header').classList.add('hidden'); // Ensure home search is hidden by default

                     switch(pageId) { 
                        case 'home-content': 
                            document.getElementById('main-header').classList.remove('hidden'); 
                            document.getElementById('home-search-input').value = '';
                            break; 
                        case 'search-content': document.getElementById('search-header').classList.remove('hidden'); break; 
                        case 'my-matches-content': document.getElementById('my-matches-header').classList.remove('hidden'); break; 
                        case 'team-form-content': document.getElementById('team-header').classList.remove('hidden'); hideNavBar(); break; 
                        case 'wallet-content': document.getElementById('wallet-header').classList.remove('hidden'); break; 
                        case 'mailbox-content': document.getElementById('mailbox-header').classList.remove('hidden'); break;
                        case 'history-content': document.getElementById('history-header').classList.remove('hidden'); break;
                        case 'redeem-content': document.getElementById('redeem-header').classList.remove('hidden'); break;
                        case 'my-coupons-content': document.getElementById('my-coupons-header').classList.remove('hidden'); break;
                        case 'edit-profile-content': document.getElementById('edit-profile-header').classList.remove('hidden'); break; 
                        case 'change-password-content': document.getElementById('change-password-header').classList.remove('hidden'); break; 
                        case 'manage-posts-content': document.getElementById('manage-posts-header').classList.remove('hidden'); break;
                        case 'payment-content': hideNavBar(); break;
                        case 'coming-soon-content': /* No header */ break;
                        case 'profile-content': // Use default header for profile
                        default: 
                            document.getElementById('main-header').classList.remove('hidden'); // Fallback to main header for profile
                            break;
                     }
                     pageId === 'manage-posts-content' ? needFab.classList.add('visible') : needFab.classList.remove('visible');
                     switch(pageId) {
                        case 'home-content': 
                            renderAllPosts(); 
                            renderTournamentsFeed();
                            renderHomeGuildPosts(); 
                            renderHomePlayerSquadPosts(); 
                            renderMissionsPage();
                            renderStorePage();
                            break;
                        case 'my-matches-content': renderMyMatchesPage(); break;
                        case 'manage-posts-content': renderManageNeedPage(); break;
                        case 'my-coupons-content': renderMyCouponsPage(); break;
                        case 'history-content': renderHistoryPage(); break;
                        case 'redeem-content': renderRedeemPage(); break;
                        case 'search-content': document.getElementById('search-results-container').innerHTML = '<p class="text-center text-gray-500 mt-8">Type at least 3 characters to search.</p>'; break;
                        case 'wallet-content': renderWalletPage(); break;
                        case 'mailbox-content': renderMailbox(); break;
                     }
                 }
                 if (isInitial) { 
                    showNewPage(); 
                 } else { 
                    transitionOverlay.classList.add('active'); 
                    setTimeout(() => { 
                        showNewPage(); 
                        setTimeout(() => transitionOverlay.classList.remove('active'), 50); 
                    }, 200); 
                 }
            }

            navItems.forEach(item => item.addEventListener('click', (e) => { 
                e.preventDefault(); 
                if (item.id === 'nav-home' && item.classList.contains('active')) { window.location.reload(); return; } 
                
                if (item.id === 'nav-reels') {
                    setActiveNavItem(item);
                    navigateToPage('coming-soon-content');
                    return;
                }
                
                setActiveNavItem(item); 
                const pageId = item.id.replace('nav-', '') + '-content'; 
                navigateToPage(pageId); 
            }));

            document.getElementById('back-home-btn').addEventListener('click', () => document.getElementById('nav-home').click()); 
            needFab.addEventListener('click', () => { 
                showCustomModal({
                    title: '   ?',
                    iconHtml: `<img src="${APP_LOGO_URL}" alt="Logo" class="w-24 h-24 rounded-full object-cover">`,
                    message: `<div class="space-y-3"><button id="fab-need-guild" class="w-full py-3 rounded-lg action-button font-bold text-sm">Guild</button><button id="fab-need-player-squad" class="w-full py-3 rounded-lg action-button font-bold text-sm">Player/Squad</button></div>`,
                    primaryButton: null,
                    onRender: (modal) => {
                        modal.querySelector('#fab-need-guild').addEventListener('click', () => { document.getElementById('modal-screen').classList.add('hidden'); screens.guildPostForm.classList.remove('hidden'); renderGuildPostForm(); });
                        modal.querySelector('#fab-need-player-squad').addEventListener('click', () => { document.getElementById('modal-screen').classList.add('hidden'); screens.playerSquadPostForm.classList.remove('hidden'); renderPlayerSquadPostForm(); });
                    }
                });
            }); 
            
            function goBackToProfile() { navigateToPage('profile-content'); setActiveNavItem(document.getElementById('nav-profile')); }
            function goHome() { navigateToPage('home-content'); setActiveNavItem(document.getElementById('nav-home')); }
            
            document.getElementById('back-from-team-btn').addEventListener('click', goBackToProfile);
            document.getElementById('back-from-wallet-btn').addEventListener('click', goBackToProfile);
            document.getElementById('back-from-mailbox-btn').addEventListener('click', goBackToProfile);
            document.getElementById('back-from-history-btn').addEventListener('click', goHome);
            document.getElementById('back-from-redeem-btn').addEventListener('click', goHome);
            document.getElementById('back-from-edit-profile-btn').addEventListener('click', goBackToProfile);
            document.getElementById('back-from-change-password-btn').addEventListener('click', goBackToProfile);
            document.getElementById('back-from-manage-posts-btn').addEventListener('click', goBackToProfile);
            document.getElementById('back-from-coupons-btn').addEventListener('click', goHome);
            
            function renderMyTeamPage() { const team = currentUserData.team; const saveBtn = document.getElementById('save-team-btn'); const form = document.getElementById('team-form'); if (team) { document.getElementById('team-name').value = team.name; document.getElementById('team-logo-preview').src = team.logo || DEFAULT_TEAM_LOGO; for(let i=0; i < 5; i++) { const member = team.members[i]; const nameInput = document.querySelector(`#member-${i}-name`); const uidInput = document.querySelector(`#member-${i}-uid`); if(member && nameInput && uidInput) { nameInput.value = member.name; uidInput.value = member.uid; } else if (nameInput && uidInput) { nameInput.value = ''; uidInput.value = ''; } } saveBtn.textContent = "Update Team"; } else { if (form) form.reset(); teamLogoFile = null; document.getElementById('team-logo-preview').src = DEFAULT_TEAM_LOGO; saveBtn.textContent = "Create Team"; } }
            
            document.getElementById('team-form').addEventListener('submit', e => {
                e.preventDefault();
                handleFormSubmit(e.target, 'Saving Team...', async () => {
                    const teamName = document.getElementById('team-name').value.trim();
                    if (!teamName) throw new Error('Please enter a name for your team.');
                    
                    const allUsers = Object.values(window.dbData.users || {});
                    const isNameTaken = allUsers.some(user => user.team && user.team.name.toLowerCase() === teamName.toLowerCase() && (!currentUserData.team || user.team.id !== currentUserData.team.id));
                    if (isNameTaken) throw new Error('This team name is already in use. Please choose another.');

                    let logoInfo = { url: currentUserData.team?.logo || DEFAULT_TEAM_LOGO, size: currentUserData.team?.logoSizeKB || 0 };
                    const oldSize = logoInfo.size;
                    if (teamLogoFile) {
                        const uploadResult = await uploadImage(teamLogoFile, 'team-logos');
                        if (!uploadResult) throw new Error("Logo upload failed.");
                        logoInfo.url = uploadResult.url; logoInfo.size = uploadResult.size;
                    }
                    const members = [];
                    for (let i = 0; i < 5; i++) {
                        const name = document.querySelector(`#member-${i}-name`).value.trim();
                        const uid = document.querySelector(`#member-${i}-uid`).value.trim();
                        if (name && uid) { members.push({ name, uid }); }
                    }
                    if (members.length < 5) throw new Error('Please provide all 5 player details.');
                    
                    const wasUpdating = !!currentUserData.team;
                    const teamData = { id: wasUpdating ? currentUserData.team.id : Date.now(), name: document.getElementById('team-name').value, logo: logoInfo.url, logoSizeKB: logoInfo.size, members };
                    await database.ref('users/' + auth.currentUser.uid + '/team').set(teamData);
                    updateTotalStorage(logoInfo.size - oldSize);
                    teamLogoFile = null;

                    showModal('success', `Team ${wasUpdating ? 'Updated' : 'Created'}!`, `Your team has been successfully ${wasUpdating ? 'updated' : 'created'}.`, 'Awesome!', () => document.getElementById('nav-profile').click());
                });
            });
            
            let bookingState = { postId: null, post: null, selectedTeam: null, selectedPlayers: [] };
            document.body.addEventListener('click', e => { 
                const bookBtn = e.target.closest('.booking-btn'); 
                const sponsorTrigger = e.target.closest('.sponsor-profile-trigger');
                const userTrigger = e.target.closest('.user-profile-trigger');
                const verifiedBadge = e.target.closest('.verification-badge');

                if (verifiedBadge) { e.preventDefault(); e.stopPropagation(); const badgeIndex = parseInt(verifiedBadge.dataset.badgeIndex); let badgeTitle = 'BEST T2 TEAM'; let badgeDescription = '      '; if (badgeIndex === 0) { badgeDescription = '   , NID          '; } else if (badgeIndex === 1) { badgeDescription = ' NID              '; } showModal('success', badgeTitle, badgeDescription, ' '); return; }

                if (bookBtn && !bookBtn.disabled) { 
                    hideNavBar();
                    const postId = bookBtn.dataset.postId;
                    const post = window.dbData.posts[postId];
                    const isSoloMatch = post.details.teamType.toLowerCase() === 'solo';

                    if (currentUserData.wallet.live < post.entryFee) { showModal('error', 'Insufficient Balance', `You need ${post.entryFee} TK to book this match. Your balance is ${currentUserData.wallet.live.toFixed(2)} TK.`); showNavBar(); return; } 
                    if (!isSoloMatch && !currentUserData.team) { showModal('error', 'No Team Found', `You must create a team to join Squad or Duo matches. Go to Profile -> My Team.`, 'Go to Profile', () => { document.getElementById('nav-profile').click(); setTimeout(() => document.getElementById('create-team-button').click(), 50); }); showNavBar(); return; } 

                    bookingState = { postId, post, selectedTeam: currentUserData.team, selectedPlayers: [] }; 
                    screens.booking.classList.remove('hidden'); 
                    renderBookingStep_Rules(); 
                }
                if(sponsorTrigger) { hideNavBar(); const sponsorId = sponsorTrigger.dataset.sponsorId; renderSponsorProfile(sponsorId); screens.sponsorProfile.classList.remove('hidden'); }
                if(userTrigger) { hideNavBar(); const userId = userTrigger.dataset.userId; renderUserProfile(userId); screens.userProfile.classList.remove('hidden'); }
            });

            function playBookingSound() { const soundUrl = window.dbData.admin?.settings?.bookingSoundUrl; if (soundUrl) { const audio = document.getElementById('booking-success-sound'); if (audio) { audio.src = soundUrl; audio.play().catch(e => console.error("Audio play failed.", e)); } } }

            function handleBookingConfirmation() {
                const { post, selectedTeam, selectedPlayers } = bookingState;
                const updates = {};
                const slotNumber = (post.slots.booked || 0) + 1;
                const newParticipantKey = database.ref(`posts/${post.id}/participants`).push().key;

                updates[`/posts/${post.id}/slots/booked`] = slotNumber;
                updates[`/posts/${post.id}/participants/${newParticipantKey}`] = { userId: auth.currentUser.uid, teamId: selectedTeam ? selectedTeam.id : null, players: selectedPlayers, slotNumber: slotNumber };
                updates[`/users/${auth.currentUser.uid}/wallet/live`] = currentUserData.wallet.live - post.entryFee;
                updates[`/users/${auth.currentUser.uid}/bookings/${post.id}`] = { postId: post.id, teamId: selectedTeam ? selectedTeam.id : null, players: selectedPlayers, bookingDate: new Date().toISOString() };
                const authorCurrentEventBalance = window.dbData.users[post.authorId]?.wallet.event || 0;
                updates[`/users/${post.authorId}/wallet/event`] = authorCurrentEventBalance + post.entryFee;
                
                database.ref().update(updates).then(() => { 
                    screens.booking.classList.add('hidden'); 
                    showNavBar();
                    playBookingSound();
                    showModal('success', 'Booking Confirmed!', `You have successfully booked slot #${slotNumber}. Good luck!`, 'Awesome!', () => { document.getElementById('nav-my-matches').click(); }); 
                }).catch(err => { handleFirebaseError(err); showNavBar(); });
            }

            function renderBookingStep_Rules() {
                const contentArea = document.getElementById('booking-content-area');
                const post = bookingState.post;
                const rules = post.details.rules;
                const rulesHTML = (rules && rules.length > 0) ? `<ul class="list-disc list-inside text-gray-300 space-y-2">${rules.map(rule => `<li>${rule}</li>`).join('')}</ul>` : '<p class="text-gray-300">No specific rules provided for this match.</p>';
                contentArea.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold">Match Rules</h1><button id="booking-close-btn" class="text-gray-400 text-2xl">&times;</button></div><div class="p-4 bg-[#1e1e1e] border border-gray-700 rounded-lg max-h-80 overflow-y-auto mb-6">${rulesHTML}</div><label for="agree-rules" class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" id="agree-rules" class="hidden"><div class="w-6 h-6 border-2 border-gray-500 rounded flex items-center justify-center check-icon-container"><i class="fa-solid fa-check text-white hidden"></i></div><span class="text-gray-300">I have read and agree to the match rules.</span></label><div class="fixed bottom-0 left-0 w-full p-4 bg-[#1e1e1e] border-t border-gray-800 flex gap-2"><button id="booking-back-btn-2" class="w-1/3 py-3 rounded-lg bg-gray-600 font-bold">Back</button><button id="booking-next-btn-2" class="w-2/3 py-3 rounded-lg action-button" disabled>Next</button></div>`;
                const agreeCheckbox = contentArea.querySelector('#agree-rules'), nextBtn = contentArea.querySelector('#booking-next-btn-2');
                agreeCheckbox.addEventListener('change', () => { contentArea.querySelector('.check-icon-container .fa-check').classList.toggle('hidden', !agreeCheckbox.checked); nextBtn.disabled = !agreeCheckbox.checked; });
                nextBtn.addEventListener('click', renderBookingStep_TeamSelection);
                contentArea.querySelector('#booking-back-btn-2').addEventListener('click', () => { screens.booking.classList.add('hidden'); showNavBar(); });
                contentArea.querySelector('#booking-close-btn').addEventListener('click', () => { screens.booking.classList.add('hidden'); showNavBar(); });
            }
            
            function renderBookingStep_TeamSelection() {
                const { post } = bookingState; const teamType = post.details.teamType.toLowerCase(); const contentArea = document.getElementById('booking-content-area'); const myTeam = currentUserData.team; let selectionHTML = '', maxSelection = 0, headerText = '';
                if (teamType === 'squad') { bookingState.selectedPlayers = myTeam.members; renderBookingStep_Confirm(); return; } 
                else if (teamType === 'duo') { maxSelection = 2; headerText = 'Select Your Duo'; selectionHTML = myTeam.members.map((member, index) => `<label class="flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-colors duration-200 ${index === 0 ? 'bg-green-500/30 border-green-500' : 'bg-[#1e1e1e] border-gray-700'} border"><input type="checkbox" class="player-checkbox hidden" value="${index}" ${index === 0 ? 'checked disabled' : ''}><div class="w-6 h-6 border-2 border-gray-500 rounded-md flex items-center justify-center check-icon-container"><i class="fa-solid fa-check text-white ${index === 0 ? '' : 'hidden'}"></i></div><div><p class="font-semibold">${member.name} ${index === 0 ? '(IGL - You)' : ''}</p><p class="text-xs text-gray-400">UID: ${member.uid}</p></div></label>`).join(''); } 
                else if (teamType === 'solo') {
                    maxSelection = 1; headerText = 'Confirm Your Entry';
                    if (myTeam && myTeam.members && myTeam.members.length > 0) {
                        const igl = myTeam.members[0];
                        selectionHTML = `<div class="p-4 bg-green-500/30 border border-green-500 rounded-lg"><p class="font-semibold">${igl.name} (from your team)</p><p class="text-xs text-gray-400">UID: ${igl.uid}</p></div><p class="text-xs text-center text-gray-400 mt-2">You will be registered using your IGL info.</p>`;
                    } else {
                        selectionHTML = `<div class="form-section p-4 rounded-xl space-y-4"><p class="text-sm text-gray-300 mb-2">Provide your in-game details for this solo match.</p><div><label for="solo-ingame-name" class="form-label">In-Game Name</label><input type="text" id="solo-ingame-name" class="form-input" placeholder="Your In-Game Name" value="${currentUserData.name || ''}" required></div><div><label for="solo-ingame-uid" class="form-label">In-Game UID</label><input type="text" id="solo-ingame-uid" class="form-input" placeholder="Your In-Game UID" required></div></div>`;
                    }
                }
                contentArea.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold">${headerText}</h1><button id="booking-close-btn" class="text-gray-400 text-2xl">&times;</button></div><div class="space-y-3 mb-24">${selectionHTML}</div><div class="fixed bottom-0 left-0 w-full p-4 bg-[#1e1e1e] border-t border-gray-800 flex gap-2"><button id="booking-back-btn-3" class="w-1/3 py-3 rounded-lg bg-gray-600 font-bold">Back</button><button id="booking-next-btn-3" class="w-2/3 py-3 rounded-lg action-button" ${teamType === 'duo' ? 'disabled' : ''}>Next</button></div>`;
                contentArea.querySelector('#booking-close-btn').addEventListener('click', () => { screens.booking.classList.add('hidden'); showNavBar(); }); contentArea.querySelector('#booking-back-btn-3').addEventListener('click', renderBookingStep_Rules);
                contentArea.querySelector('#booking-next-btn-3').addEventListener('click', () => { 
                    if (teamType === 'duo') { const selectedIndexes = Array.from(contentArea.querySelectorAll('.player-checkbox:checked')).map(cb => parseInt(cb.value)); bookingState.selectedPlayers = selectedIndexes.map(i => myTeam.members[i]); } 
                    else if (teamType === 'solo') { 
                        if (myTeam && myTeam.members && myTeam.members.length > 0) {
                            bookingState.selectedPlayers = [myTeam.members[0]];
                        } else {
                            const soloName = document.getElementById('solo-ingame-name').value.trim();
                            const soloUid = document.getElementById('solo-ingame-uid').value.trim();
                            if (!soloName || !soloUid) {
                                showModal('error', 'Details Required', 'Please enter your In-Game Name and UID.');
                                return;
                            }
                            bookingState.selectedPlayers = [{ name: soloName, uid: soloUid }];
                        }
                    } 
                    renderBookingStep_Confirm(); 
                });
                if (teamType === 'duo') { const checkboxes = contentArea.querySelectorAll('.player-checkbox:not(:disabled)'), nextBtn = contentArea.querySelector('#booking-next-btn-3'); checkboxes.forEach(cb => { cb.addEventListener('change', () => { const checkedCount = contentArea.querySelectorAll('.player-checkbox:checked').length; cb.closest('label').classList.toggle('bg-green-500/30', cb.checked); cb.closest('label').classList.toggle('border-green-500', cb.checked); cb.closest('label').classList.toggle('bg-[#1e1e1e]', !cb.checked); cb.closest('label').classList.toggle('border-gray-700', !cb.checked); cb.closest('label').querySelector('.fa-check').classList.toggle('hidden', !cb.checked); if (checkedCount > maxSelection) { cb.checked = false; cb.closest('label').classList.remove('bg-green-500/30', 'border-green-500'); cb.closest('label').classList.add('bg-[#1e1e1e]', 'border-gray-700'); cb.closest('label').querySelector('.fa-check').classList.add('hidden'); } nextBtn.disabled = contentArea.querySelectorAll('.player-checkbox:checked').length !== maxSelection; }); }); }
            }

            function renderBookingStep_Confirm() {
                const contentArea = document.getElementById('booking-content-area'); const playersHTML = bookingState.selectedPlayers.map(p => `<li class="text-gray-300">${p.name} <span class="text-xs text-gray-500">(UID: ${p.uid})</span></li>`).join(''); const teamName = bookingState.post.details.teamType === 'squad' ? `: ${bookingState.selectedTeam.name}` : ` (${bookingState.post.details.teamType.toUpperCase()})`;
                contentArea.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold">Confirmation</h1><button id="booking-close-btn" class="text-gray-400 text-2xl">&times;</button></div><div class="space-y-4"><div class="p-4 bg-[#1e1e1e] border border-gray-700 rounded-lg"><p class="text-sm text-gray-400">MATCH</p><p class="text-lg font-bold">${bookingState.post.details.eventName}</p></div><div class="p-4 bg-[#1e1e1e] border border-gray-700 rounded-lg"><p class="text-sm text-gray-400">YOUR ROSTER${teamName}</p><ul class="list-disc list-inside mt-2">${playersHTML}</ul></div><div class="p-4 bg-[#1e1e1e] border border-gray-700 rounded-lg flex justify-between items-center"><p class="text-sm text-gray-400">ENTRY FEE</p><p class="text-2xl font-bold font-oswald text-green-400">${bookingState.post.entryFee > 0 ? bookingState.post.entryFee + ' TK' : 'FREE'}</p></div></div><div class="fixed bottom-0 left-0 w-full p-4 bg-[#1e1e1e] border-t border-gray-800"><div id="swipe-confirm" class="swipe-container"><div class="swipe-track"></div><div class="swipe-handle"><i class="fa-solid fa-chevron-right text-white"></i><i class="fa-solid fa-chevron-right text-white -ml-2"></i></div><div class="swipe-text">SWIPE TO CONFIRM BOOKING</div></div></div>`;
                contentArea.querySelector('#booking-close-btn').addEventListener('click', () => { screens.booking.classList.add('hidden'); showNavBar(); }); initSwipeToConfirm();
            }

            function initSwipeToConfirm(onConfirm) {
                const swipeContainer = document.querySelector('#swipe-confirm, #payment-swipe-confirm');
                if (!swipeContainer) return;
                const handle = swipeContainer.querySelector('.swipe-handle');
                const track = swipeContainer.querySelector('.swipe-track');
                const text = swipeContainer.querySelector('.swipe-text');
                
                let isDragging = false, startX, currentX;

                const resetSwipe = () => {
                    handle.style.transition = 'transform 0.3s ease';
                    track.style.transition = 'width 0.3s ease';
                    handle.style.transform = 'translateX(0px)';
                    track.style.width = '0px';
                    if (text) text.style.opacity = 1;
                    setTimeout(() => {
                        handle.style.transition = 'none';
                        track.style.transition = 'none';
                    }, 300);
                };

                const onDragMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    currentX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX) - startX;
                    const maxTranslate = swipeContainer.offsetWidth - handle.offsetWidth - 12; // 12 for padding
                    let newTranslate = Math.max(0, Math.min(currentX, maxTranslate));
                    handle.style.transform = `translateX(${newTranslate}px)`;
                    track.style.width = `${newTranslate + handle.offsetWidth / 2}px`;
                    if (text) text.style.opacity = 1 - (newTranslate / maxTranslate);
                };
                
                const onDragEnd = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    handle.style.cursor = 'grab';

                    document.removeEventListener('mousemove', onDragMove);
                    document.removeEventListener('touchmove', onDragMove);
                    document.removeEventListener('mouseup', onDragEnd);
                    document.removeEventListener('touchend', onDragEnd);
                    
                    const maxTranslate = swipeContainer.offsetWidth - handle.offsetWidth - 12;

                    if (currentX > maxTranslate * 0.8) {
                        handle.style.transform = `translateX(${maxTranslate}px)`;
                        track.style.width = '100%';
                        if (text) text.style.opacity = 0;
                        
                        if (onConfirm) {
                            onConfirm(resetSwipe);
                        } else {
                            handleBookingConfirmation();
                        }
                    } else {
                        resetSwipe();
                    }
                };

                const onDragStart = (e) => {
                    isDragging = true;
                    startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    handle.style.transition = 'none';
                    track.style.transition = 'none';
                    handle.style.cursor = 'grabbing';
                    
                    document.addEventListener('mousemove', onDragMove);
                    document.addEventListener('touchmove', onDragMove, { passive: false });
                    document.addEventListener('mouseup', onDragEnd);
                    document.addEventListener('touchend', onDragEnd);
                };
                
                handle.addEventListener('mousedown', onDragStart);
                handle.addEventListener('touchstart', onDragStart, { passive: true });
            }
            
            function initMyMatchesPage() { const container = document.getElementById('my-matches-content'); if (!container) return; const tabs = container.querySelectorAll('.my-matches-tab'); const sections = container.querySelectorAll('.tab-content-section'); tabs.forEach(tab => { tab.addEventListener('click', () => { if (tab.classList.contains('active-tab')) return; tabs.forEach(t => t.classList.remove('active-tab')); sections.forEach(s => s.classList.remove('active-section')); tab.classList.add('active-tab'); document.getElementById(tab.dataset.target)?.classList.add('active-section'); }); }); if (!container.querySelector('.active-tab')) { tabs[0]?.classList.add('active-tab'); sections[0]?.classList.add('active-section'); } }
            function renderMyMatchesPage() { const bookings = Object.values(currentUserData.bookings || {}); const posts = window.dbData.posts || {}; const upcomingContainer = document.getElementById('upcoming-matches-container'); const historyContainer = document.getElementById('history-matches-container'); upcomingContainer.innerHTML = ''; historyContainer.innerHTML = ''; let upcomingCount = 0, historyCount = 0; bookings.sort((a,b) => new Date(b.bookingDate) - new Date(a.bookingDate)).forEach(booking => { const post = posts[booking.postId]; if (post) { const isBanned = (post.bannedUsers || []).includes(auth.currentUser.uid); if (isBanned || post.status === 'completed' || post.status === 'cancelled') { historyContainer.innerHTML += createMyMatchPostCardHTML(post, isBanned); historyCount++; } else { upcomingContainer.innerHTML += createMyMatchPostCardHTML(post, isBanned); upcomingCount++; } } }); if (upcomingCount === 0) upcomingContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">You have no upcoming matches.</p>'; if (historyCount === 0) historyContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No recent match history found.</p>'; initializeCountdowns(); }
            
            function createMyMatchPostCardHTML(post, isBanned = false) {
                const isLive = post.status.startsWith('live');
                const participantInfo = Object.values(post.participants || {}).find(p => p.userId === auth.currentUser.uid);
                const slotNumber = participantInfo ? participantInfo.slotNumber : '?';
                let bottomSectionHTML = '';
                let cardClass = isLive ? 'is-live-match' : '';
                let cardWrapperStart = '', cardWrapperEnd = '';

                if (isBanned) {
                    cardClass = 'banned-card';
                    cardWrapperStart = `<div class="relative"><div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-oswald font-bold px-3 py-1 rounded-full z-10 shadow-lg" style="transform: rotate(10deg);">BANNED</div>`;
                    cardWrapperEnd = '</div>';
                    bottomSectionHTML = `<div class="p-3 bg-red-900/50 text-center"><p class="font-bold text-red-300">Your team was banned from this match</p></div>`;
                } else if (post.status === 'completed' || post.status === 'cancelled') {
                    if (post.status === 'cancelled') {
                        bottomSectionHTML = `<div class="p-3 bg-red-900/50 text-center"><p class="font-bold text-red-400">MATCH CANCELLED ${post.cancellationReason === 'auto' ? '(Auto)' : ''}</p></div>`;
                    } else {
                        const finalRankings = Object.values(post.participants || {}).map(p => { let totalPoints = 0; if (post.approvedResults && post.approvedResults[p.userId]) { Object.values(post.approvedResults[p.userId]).forEach(mapResult => { totalPoints += calculatePoints(mapResult.kills, mapResult.position); }); } return { userId: p.userId, totalPoints }; }).sort((a, b) => b.totalPoints - a.totalPoints); const myRankIndex = finalRankings.findIndex(r => r.userId === auth.currentUser.uid); const myRank = myRankIndex !== -1 ? myRankIndex + 1 : 'N/A'; const myPoints = myRankIndex !== -1 ? finalRankings[myRankIndex].totalPoints : 'N/A';
                        bottomSectionHTML = `<div class="p-3 bg-gray-800/80"><p class="text-center font-bold text-gray-300 mb-2">MATCH COMPLETED</p><div class="flex justify-around text-center"><div class="font-oswald"><p class="text-2xl font-bold text-green-400">#${myRank}</p><p class="text-xs text-gray-400">RANK</p></div><div class="font-oswald"><p class="text-2xl font-bold text-white">${myPoints}</p><p class="text-xs text-gray-400">POINTS</p></div></div></div>`;
                    }
                } else if (isLive) {
                    if (post.roomId && post.roomPass) {
                        bottomSectionHTML = `
                        <div class="p-3 bg-green-900/50 text-center space-y-2">
                            <p class="font-bold text-green-300 animate-pulse">MATCH IS LIVE!</p>
                            <div class="flex justify-around items-center text-xs">
                                <div class="flex items-center gap-2"><span>ID: <strong>${post.roomId}</strong></span><button class="copy-btn-card bg-gray-600 hover:bg-gray-500 w-6 h-6 rounded-md flex items-center justify-center" data-copy-text="${post.roomId}"><i class="fa-solid fa-copy text-xs"></i></button></div>
                                <div class="flex items-center gap-2"><span>PASS: <strong>${post.roomPass}</strong></span><button class="copy-btn-card bg-gray-600 hover:bg-gray-500 w-6 h-6 rounded-md flex items-center justify-center" data-copy-text="${post.roomPass}"><i class="fa-solid fa-copy text-xs"></i></button></div>
                            </div>
                        </div>`;
                    } else {
                        bottomSectionHTML = `<div class="p-3 bg-green-900/50 text-center"><p class="font-bold text-yellow-300 animate-pulse">LIVE: Waiting for ID/Pass...</p></div>`;
                    }
                } else {
                    bottomSectionHTML = `<div class="p-3 bg-black/30 flex justify-between items-center"><p class="text-sm font-semibold">Match Starts In:</p><div class="countdown-container" data-countdown="${post.matchDate}"></div></div>`;
                }

                const cardHTML = `<div class="post-card rounded-2xl overflow-hidden cursor-pointer ${cardClass}" data-post-id="${post.id}"><div class="p-4"><div class="flex justify-between items-start"><div class="flex items-center gap-3"><img src="${post.imageUrl}" class="w-16 h-16 rounded-lg object-cover border-2 border-gray-600"><div><p class="font-bold text-lg text-green-400">${post.details.eventName}</p><p class="text-sm text-gray-400">Match Date: ${new Date(post.matchDate).toLocaleDateString()}</p></div></div><div class="bg-gray-700 w-12 h-12 flex flex-col items-center justify-center rounded-lg"><p class="text-xs -mb-1">SLOT</p><p class="font-bold text-xl text-green-400">#${slotNumber}</p></div></div></div>${bottomSectionHTML}</div>`;
                return `${cardWrapperStart}${cardHTML}${cardWrapperEnd}`;
            }

            document.getElementById('my-matches-content').addEventListener('click', e => { 
                const copyBtn = e.target.closest('.copy-btn-card');
                if (copyBtn) {
                    e.stopPropagation(); 
                    const textToCopy = copyBtn.dataset.copyText;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showModal('success', 'Copied!', `"${textToCopy}" has been copied.`);
                    });
                    return;
                }

                const card = e.target.closest('[data-post-id]'); 
                if(!card || card.classList.contains('banned-card')) return; 
                hideNavBar();
                const postId = card.dataset.postId; 
                const post = window.dbData.posts[postId]; 
                if (!post) { showNavBar(); return; }
                
                if (post.status.startsWith('live')) {
                    renderLiveMatchPage(postId);
                    screens.results.classList.remove('hidden');
                } else if (post.status === 'completed' || post.status === 'cancelled') { 
                    renderHistoryMatchDetailsPage(postId); 
                    screens.results.classList.remove('hidden');
                } else { 
                    showParticipantList(postId); 
                } 
            });
            
            function showParticipantList(postId) {
                const post = window.dbData.posts[postId]; if (!post) return;
                const allBadges = window.dbData.admin?.config?.verifiedBadges || {};

                const participantsHTML = Object.values(post.participants || {}).map(p => { 
                    const participantUser = window.dbData.users[p.userId];
                    const team = participantUser?.team;
                    const isSolo = post.details.teamType.toLowerCase() === 'solo';
                    const teamName = isSolo ? p.players[0].name : (team ? team.name : 'Unknown Team');
                    const teamLogo = isSolo ? participantUser?.avatar || DEFAULT_AVATAR : (team ? team.logo || DEFAULT_TEAM_LOGO : DEFAULT_TEAM_LOGO);
                    
                    if (!participantUser) return '';

                    const { wins, played } = calculateUserStats(participantUser, window.dbData.posts);
                    const winRate = (played > 0) ? ((wins / played) * 100).toFixed(0) : 0;
                    
                    let teamBadgeHTML = '';
                    if (team && team.verifiedBadge !== undefined && team.verifiedBadge !== null && allBadges[team.verifiedBadge]) {
                        teamBadgeHTML = `<img src="${allBadges[team.verifiedBadge]}" alt="Team Badge" class="verification-badge">`;
                    }

                    return `<div class="bg-[#2a2a2a] rounded-lg p-3 flex justify-between items-center">
                                <div class="flex-grow">
                                    <div class="flex items-center">
                                        <p class="font-semibold text-white">#${p.slotNumber} ${teamName}</p>
                                        ${teamBadgeHTML}
                                    </div>
                                    <div class="flex items-center gap-3 text-xs text-gray-400 mt-1">
                                        <span><i class="fa-solid fa-chart-line text-green-400"></i> ${winRate}% Win Rate</span>
                                    </div>
                                </div>
                                <img src="${teamLogo}" class="w-14 h-14 rounded-md object-cover flex-shrink-0">
                            </div>`;
                }).join('');
                const content = document.getElementById('participant-list-content');
                content.innerHTML = `<div class="sticky top-0 bg-[#121212]/80 backdrop-blur-md py-4 flex justify-between items-center z-10"><h2 class="text-2xl font-bold">${post.details.eventName} - Teams</h2><button id="close-participants-btn" class="text-gray-400 text-3xl">&times;</button></div><p class="text-lg mb-2">Slots Filled: <span class="font-bold">${post.participants ? Object.keys(post.participants).length : 0}/${post.slots.total}</span></p><div class="space-y-2 participant-list">${(post.participants && Object.keys(post.participants).length > 0) ? participantsHTML : '<p class="text-gray-500 p-4">No teams have booked yet.</p>'}</div>`;
                screens.participants.classList.remove('hidden'); content.querySelector('#close-participants-btn').addEventListener('click', () => {screens.participants.classList.add('hidden'); showNavBar(); });
            }
            
            const lightbox = document.getElementById('image-lightbox'); const lightboxImg = document.getElementById('lightbox-img');
            function showLightbox(src) { if(src) { lightboxImg.src = src; lightbox.classList.remove('hidden'); } }
            function hideLightbox() { lightbox.classList.add('hidden'); }

            function calculatePoints(kills, position) { const pp = { 1: 12, 2: 9, 3: 8, 4: 7, 5: 6, 6: 5, 7: 4, 8: 3, 9: 2, 10: 1, 11: 0, 12: 0 }; return (parseInt(kills) || 0) + (pp[parseInt(position)] || 0); }
            
            function renderHistoryMatchDetailsPage(postId) { const post = window.dbData.posts[postId]; if (!post) return; const content = document.getElementById('results-submission-content'); const myResults = post.approvedResults?.[auth.currentUser.uid] || {}; const mySubmissionsHTML = `<div class="space-y-3">${post.details.maps.map(map => { const result = myResults[map]; if (!result) return ''; const screenshotHTML = result.screenshot ? `<img src="${result.screenshot}" class="w-24 h-16 object-cover rounded-md cursor-pointer flex-shrink-0" onclick="event.stopPropagation(); showLightbox('${result.screenshot}')">` : ''; return `<div class="p-4 bg-[#1e1e1e] border border-gray-700 rounded-xl flex items-center gap-4">${screenshotHTML}<div class="flex-grow"><h4 class="font-bold text-lg text-green-400">${map}</h4><div class="flex gap-4 mt-1 text-sm"><span><i class="fa-solid fa-crosshairs text-red-400 mr-1"></i> Kills: <span class="font-semibold">${result.kills}</span></span><span><i class="fa-solid fa-trophy text-yellow-400 mr-1"></i> Position: <span class="font-semibold">#${result.position}</span></span></div></div></div>`; }).join('')}</div>`; const hasRated = post.feedback && Object.values(post.feedback).some(fb => fb.userId === auth.currentUser.uid); const feedbackForm = hasRated ? `<div class="p-4 bg-[#1e1e1e] rounded-xl text-center text-green-400 mt-6"><i class="fa-solid fa-check-circle mr-2"></i>Thanks for your feedback!</div>` : `<div id="feedback-form-container" class="mt-6 p-4 bg-[#1e1e1e] rounded-xl"></div>`; content.innerHTML = `<div class="sticky top-0 bg-[#121212]/80 backdrop-blur-md py-4 flex justify-between items-center z-10"><h2 class="text-2xl font-bold">${post.details.eventName}</h2><button id="close-results-btn" class="text-gray-400 text-3xl">&times;</button></div><div id="leaderboard-section" class="mb-6"></div>${Object.keys(myResults).length > 0 ? `<h3 class="text-xl font-bold mt-8 mb-3">My Match Summary</h3>${mySubmissionsHTML}` : ''}${feedbackForm}`; renderLeaderboard(postId, 'approvedResults', 'Final Standings'); if (!hasRated) renderFeedbackForm(postId); content.querySelector('#close-results-btn').addEventListener('click', () => { screens.results.classList.add('hidden'); showNavBar(); }); }
            
            function renderLiveMatchPage(postId) {
                const screen = document.getElementById('results-submission-screen');
                screen.dataset.postId = postId;
                const post = window.dbData.posts[postId]; if (!post) return;
                const content = document.getElementById('results-submission-content');
                
                content.innerHTML = `
                    <div class="sticky top-0 bg-[#121212]/80 backdrop-blur-md py-4 px-4 flex justify-between items-center z-10">
                        <h2 class="text-2xl font-bold">${post.details.eventName}</h2>
                        <button id="close-results-btn" class="text-gray-400 text-3xl">&times;</button>
                    </div>
                    <div class="flex gap-2 mb-4 px-4">
                        <button class="tab-button live-match-tab" data-target="submit-results-section">Submit Results</button>
                        <button class="tab-button live-match-tab" data-target="live-leaderboard-section">Leaderboard</button>
                    </div>
                    <div class="px-4 pb-4 overflow-y-auto h-[calc(100%-120px)] no-scrollbar">
                        <div id="submit-results-section" class="tab-content-section"></div>
                        <div id="live-leaderboard-section" class="tab-content-section"></div>
                    </div>`;
                    
                renderLiveMatchSubmissionForms(postId); 
                renderLeaderboard(postId, 'approvedResults', 'Live Standings'); // Leaderboard now shows approved results for accuracy
                
                content.querySelector('#close-results-btn').addEventListener('click', () => { screens.results.classList.add('hidden'); showNavBar(); delete screen.dataset.postId; });
                setupTabs(content.id, '.live-match-tab', '.tab-content-section');
                content.querySelector('.live-match-tab[data-target="submit-results-section"]')?.click();
            }

            function renderLiveMatchSubmissionForms(postId) {
                const post = window.dbData.posts[postId]; if (!post) return;
                const container = document.getElementById('submit-results-section'); if (!container) return;
                const roomDetailsHTML = (post.roomId && post.roomPass) ? `<div class="mb-4"><div class="bg-gradient-to-br from-green-900 to-gray-800 border border-green-700 rounded-xl p-4 shadow-lg"><h3 class="text-lg font-bold text-center text-green-300 mb-3">Room Details</h3><div class="space-y-3"><div class="flex justify-between items-center bg-black/30 p-2 rounded-lg"><span class="text-gray-400 text-sm font-semibold">Room ID:</span><code class="text-white font-bold text-lg">${post.roomId}</code><button class="copy-btn bg-gray-600 hover:bg-gray-500 w-8 h-8 rounded-md flex items-center justify-center" data-copy-text="${post.roomId}"><i class="fa-solid fa-copy"></i></button></div><div class="flex justify-between items-center bg-black/30 p-2 rounded-lg"><span class="text-gray-400 text-sm font-semibold">Password:</span><code class="text-white font-bold text-lg">${post.roomPass}</code><button class="copy-btn bg-gray-600 hover:bg-gray-500 w-8 h-8 rounded-md flex items-center justify-center" data-copy-text="${post.roomPass}"><i class="fa-solid fa-copy"></i></button></div></div></div></div>` : '';
                const mySubmissions = post.results?.[auth.currentUser.uid] || {};
                let positionOptions = ''; for (let i = 1; i <= post.slots.total; i++) { positionOptions += `<option value="${i}">#${i}</option>`; }

                const formsHTML = post.details.maps.map(mapName => {
                    const isUnlocked = post.mapStates?.[mapName]?.submissionOpen === true;
                    const mySubmission = mySubmissions[mapName];
                    if (mySubmission) {
                        return `<div class="p-4 bg-[#1e1e1e] border border-green-700 rounded-xl mb-4"><h4 class="font-bold text-lg text-green-400">${mapName}</h4><div class="mt-2 text-center text-gray-300"><p class="mb-2"><i class="fa-solid fa-check-circle mr-2 text-green-400"></i>Submission Sent & Locked</p><p>Kills: <span class="font-bold">${mySubmission.kills}</span> | Position: <span class="font-bold">#${mySubmission.position}</span></p>${mySubmission.screenshot ? `<img src="${mySubmission.screenshot}" class="w-full max-w-xs h-auto object-cover rounded-md cursor-pointer mt-3 mx-auto" onclick="event.stopPropagation(); showLightbox('${mySubmission.screenshot}')">` : ''}</div></div>`;
                    }
                    return `<form class="space-y-3 p-4 bg-[#1e1e1e] border ${isUnlocked ? 'border-gray-700' : 'border-gray-800 opacity-60'} rounded-xl mb-4" data-map-name="${mapName}"><fieldset ${!isUnlocked ? 'disabled' : ''}><div class="flex justify-between items-center"><h4 class="font-bold text-lg ${isUnlocked ? 'text-green-400' : 'text-gray-500'}">${mapName}</h4>${!isUnlocked ? '<span class="text-xs text-yellow-400 font-semibold flex items-center gap-2"><i class="fa-solid fa-lock"></i> LOCKED</span>' : '<span class="text-xs text-green-400 font-semibold flex items-center gap-2"><i class="fa-solid fa-unlock"></i> OPEN</span>'}</div><div class="grid grid-cols-2 gap-3 mt-3"><div><label class="form-label">Total Kills</label><input type="number" name="kills" class="form-input" placeholder="0" required></div><div><label class="form-label">Position</label><select name="position" class="form-select" required><option value="">Select</option>${positionOptions}</select></div></div><div><label class="form-label">Screenshot (Proof)</label><input type="file" name="screenshot" accept="image/*" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-white hover:file:bg-gray-700" required></div><button type="submit" class="w-full py-2 mt-2 action-button rounded-lg">Submit for ${mapName}</button>${!isUnlocked ? '<p class="text-xs text-center text-gray-500 mt-2">Wait for the sponsor to unlock submissions for this map.</p>' : ''}</fieldset></form>`;
                }).join('');

                container.innerHTML = `${roomDetailsHTML}<h3 class="text-xl font-bold mb-3">My Match Submissions</h3><div class="space-y-3">${formsHTML}</div>`;
                container.querySelectorAll('.copy-btn').forEach(btn => { btn.addEventListener('click', () => { const textToCopy = btn.dataset.copyText; navigator.clipboard.writeText(textToCopy).then(() => { showModal('success', 'Copied!', `"${textToCopy}" has been copied.`); }); }); });
                
                container.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const map = e.target.dataset.mapName;
                        const file = e.target.elements.screenshot.files[0];
                        handleFormSubmit(form, 'Submitting...', async () => {
                            const kills = e.target.elements.kills.value;
                            const position = e.target.elements.position.value;
                            if (!file) throw new Error('Screenshot Required');
                            if (kills === '' || position === '') throw new Error('Fields Required');
                            const uploadResult = await uploadImage(file, 'result-screenshots');
                            if (!uploadResult || !uploadResult.url) throw new Error('The screenshot could not be uploaded. Please try again.');
                            updateTotalStorage(uploadResult.size);
                            const path = `/posts/${postId}/results/${auth.currentUser.uid}/${map}`;
                            await database.ref(path).set({ kills, position, screenshot: uploadResult.url, submittedAt: new Date().toISOString() });
                            showModal('success', 'Results Submitted!', `Your results for ${map} have been saved successfully.`);
                        });
                    });
                });
            }

            function renderLeaderboard(postId, resultsKey, title = 'Final Standings') {
                const post = window.dbData.posts[postId]; if (!post) return;
                const container = document.getElementById('live-leaderboard-section') || document.getElementById('leaderboard-section'); if (!container) return;
                const resultsSource = post[resultsKey] || {}; const isSolo = post.details.teamType.toLowerCase() === 'solo';

                const leaderboardData = Object.values(post.participants || {}).map(p => {
                    const user = window.dbData.users[p.userId]; if (!user) return null;
                    const team = user.team; const name = isSolo ? p.players[0].name : (team ? team.name : 'Unknown Team'); const logo = isSolo ? user.avatar || DEFAULT_AVATAR : (team ? team.logo || DEFAULT_TEAM_LOGO : DEFAULT_TEAM_LOGO);
                    let totalPoints = 0, totalKills = 0, totalPP = 0;
                    if (resultsSource[p.userId]) { Object.values(resultsSource[p.userId]).forEach(mapResult => { totalPoints += calculatePoints(mapResult.kills, mapResult.position); totalKills += parseInt(mapResult.kills) || 0; totalPP += (calculatePoints(0, mapResult.position)); }); }
                    return { userId: p.userId, name: name, logo: logo, totalPoints, totalKills, totalPP };
                }).filter(Boolean).sort((a, b) => b.totalPoints - a.totalPoints);

                const listHTML = leaderboardData.map((team, index) => {
                    const isMyTeam = team.userId === auth.currentUser.uid;
                    return `<div class="grid grid-cols-12 items-center p-3 rounded-lg ${isMyTeam ? 'bg-green-500/20 border border-green-500' : 'bg-[#2a2a2a]'} text-sm"><span class="font-bold col-span-1 text-center">#${index + 1}</span><img src="${team.logo}" class="w-8 h-8 rounded-full col-span-1 object-cover"><p class="font-semibold col-span-4 ml-2 truncate">${team.name}</p><p class="text-center font-semibold col-span-2">${team.totalKills}</p><p class="text-center font-semibold col-span-2">${team.totalPP}</p><p class="font-bold text-green-400 text-center col-span-2">${team.totalPoints}</p></div>`;
                }).join('');

                container.innerHTML = `<h3 class="text-3xl font-oswald font-bold text-center mb-4">${title}</h3>${leaderboardData.length > 0 ? `<div class="space-y-2 mt-6"><div class="grid grid-cols-12 text-xs text-gray-400 font-bold p-2"><span class="col-span-1 text-center">POS</span><span class="col-span-5 ml-3">TEAM</span><span class="text-center col-span-2">KILLS</span><span class="text-center col-span-2">PLACE</span><span class="text-center col-span-2">TOTAL</span></div>${listHTML}</div>` : '<p class="text-center text-gray-500 p-4">No results available yet.</p>'}`;
            }
            
            function renderFeedbackForm(postId) { const container = document.getElementById('feedback-form-container'); if(!container) return; container.innerHTML = `<h3 class="font-bold text-lg mb-2">Rate This Event</h3><div class="flex justify-center text-2xl gap-2 rating-stars mb-3" data-rating="0">${Array(5).fill(0).map((_, i) => `<i class="fa-regular fa-star" data-value="${i+1}"></i>`).join('')}</div><textarea id="feedback-comment" class="form-textarea" rows="3" placeholder="Write your feedback..."></textarea><button id="submit-feedback-btn" class="w-full py-2 mt-2 action-button rounded-lg" disabled>Submit Feedback</button>`; const stars = container.querySelectorAll('.rating-stars .fa-star'); stars.forEach(star => { star.addEventListener('mouseover', () => highlightStars(stars, star.dataset.value)); star.addEventListener('mouseout', () => highlightStars(stars, container.querySelector('.rating-stars').dataset.rating)); star.addEventListener('click', () => { container.querySelector('.rating-stars').dataset.rating = star.dataset.value; document.getElementById('submit-feedback-btn').disabled = false; }); }); document.getElementById('submit-feedback-btn').addEventListener('click', () => submitFeedback(postId)); }
            function highlightStars(stars, rating) { stars.forEach(star => { star.classList.toggle('fa-solid', star.dataset.value <= rating); star.classList.toggle('fa-regular', star.dataset.value > rating); star.classList.toggle('text-yellow-400', star.dataset.value <= rating); star.classList.toggle('text-gray-500', star.dataset.value > rating); }); }
            function submitFeedback(postId) { const rating = parseInt(document.querySelector('#feedback-form-container .rating-stars').dataset.rating); const comment = document.getElementById('feedback-comment').value; if(rating === 0) { showModal('error', 'Rating required', 'Please select at least one star.'); return; } const newFeedbackKey = database.ref(`posts/${postId}/feedback`).push().key; const newFeedback = { userId: auth.currentUser.uid, rating, comment, timestamp: new Date().toISOString() }; database.ref(`posts/${postId}/feedback/${newFeedbackKey}`).set(newFeedback).then(() => { showModal('success', 'Thank You!', 'Your feedback has been submitted successfully.'); }); }
            
            function handleLikeSponsor(sponsorId) {
                const likeBtn = document.getElementById('like-sponsor-profile-btn');
                const statsGrid = document.querySelector('#sponsor-profile-content .grid-cols-3');
                if (!likeBtn || !statsGrid) return;
                
                const likesCountEl = statsGrid.children[0].querySelector('p:first-child');
                let currentLikes = parseInt(likesCountEl.dataset.rawLikes) || 0;
                const hasLiked = likeBtn.classList.contains('bg-red-600');

                if (hasLiked) { currentLikes--; likeBtn.classList.remove('bg-red-600', 'hover:bg-red-700'); likeBtn.classList.add('action-button'); likeBtn.innerHTML = '<i class="fa-solid fa-heart mr-2"></i> Like'; } else { currentLikes++; likeBtn.classList.remove('action-button'); likeBtn.classList.add('bg-red-600', 'hover:bg-red-700'); likeBtn.innerHTML = '<i class="fa-solid fa-heart mr-2"></i> Unlike'; }
                likesCountEl.textContent = formatNumberCompact(currentLikes);
                likesCountEl.dataset.rawLikes = currentLikes;
                
                database.ref(`users/${sponsorId}/reputation`).transaction(reputation => {
                    if (reputation === null) reputation = { likes: 0, likedBy: {} };
                    reputation.likedBy = reputation.likedBy || {};
                    if (reputation.likedBy[auth.currentUser.uid]) {
                        reputation.likes = (reputation.likes || 1) - 1;
                        delete reputation.likedBy[auth.currentUser.uid];
                    } else {
                        reputation.likes = (reputation.likes || 0) + 1;
                        reputation.likedBy[auth.currentUser.uid] = true;
                    }
                    return reputation;
                });
            }

            function maskName(name) { if (!name) return ''; if (name.length <= 3) return name; return name.substring(0, 3) + '***'; }
            function renderSponsorProfile(sponsorId) {
                const sponsor = window.dbData.users[sponsorId]; if (!sponsor) return; 
                const content = document.getElementById('sponsor-profile-content'); 
                const sponsorPosts = Object.values(window.dbData.posts || {}).filter(p => p.authorId === sponsorId); 
                let totalRatings = 0, ratingCount = 0, successfulEvents = 0; 
                sponsorPosts.forEach(post => { if (post.status === 'completed') successfulEvents++; if (post.feedback) { Object.values(post.feedback).forEach(fb => { totalRatings += fb.rating; ratingCount++; }); } }); 
                const avgRating = ratingCount > 0 ? (totalRatings / ratingCount).toFixed(1) : '0.0'; 
                const hasLiked = sponsor.reputation?.likedBy?.[auth.currentUser.uid]; 
                
                const allBadges = window.dbData.admin?.config?.verifiedBadges || {};
                let verifiedBadgeHTML = '';
                if (sponsor.verifiedBadge !== undefined && sponsor.verifiedBadge !== null && allBadges[sponsor.verifiedBadge]) {
                    verifiedBadgeHTML = `<img src="${allBadges[sponsor.verifiedBadge]}" alt="Verified" class="verification-badge" data-badge-index="${sponsor.verifiedBadge}">`;
                }

                let feedbacksHTML = '<h3 class="text-xl font-bold mt-8 mb-4 text-left">User Feedbacks</h3>'; 
                const allFeedbacks = sponsorPosts.flatMap(p => Object.values(p.feedback || {})).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 
                if (allFeedbacks.length > 0) { feedbacksHTML += `<div class="space-y-4 text-left">${allFeedbacks.map(fb => { const user = window.dbData.users[fb.userId]; const stars = Array(5).fill(0).map((_, i) => `<i class="fa-solid fa-star ${i < fb.rating ? 'text-yellow-400' : 'text-gray-600'}"></i>`).join(''); return `<div class="bg-[#1e1e1e] p-3 rounded-lg border border-gray-700"> <div class="flex justify-between items-center"> <p class="font-semibold text-sm">${user ? maskName(user.name) : 'Ano***'}</p> <div class="flex gap-1 text-xs">${stars}</div> </div> ${fb.comment ? `<p class="text-gray-300 text-sm mt-2 italic">"${fb.comment}"</p>` : ''} </div>`; }).join('')}</div>`; } else { feedbacksHTML += '<p class="text-gray-500 text-center">No feedback yet.</p>'; } 
                
                const rawLikes = sponsor.reputation?.likes || 0;
                content.innerHTML = `<div class="sticky top-0 bg-[#121212] py-4 flex justify-between items-center"><h2 class="text-2xl font-bold">Sponsor Profile</h2><button id="close-sponsor-profile-btn" class="text-gray-400 text-3xl">&times;</button></div><div class="p-6 text-center"><img src="${sponsor.avatar || DEFAULT_AVATAR}" class="w-32 h-32 rounded-full mx-auto border-4 border-green-500"><h2 class="text-3xl font-bold mt-4 flex items-center justify-center">${sponsor.name}${verifiedBadgeHTML}</h2><p class="text-gray-500 text-sm">UID: ${sponsorId}</p><div class="w-full max-w-md mx-auto mt-6 p-4 bg-[#1e1e1e] border border-gray-800 rounded-xl grid grid-cols-3 text-center divide-x divide-gray-700"><div><p class="text-2xl font-bold" data-raw-likes="${rawLikes}">${formatNumberCompact(rawLikes)}</p><p class="text-xs text-gray-400">Likes</p></div><div><p class="text-2xl font-bold">${avgRating}</p><p class="text-xs text-gray-400">Rating</p></div><div><p class="text-2xl font-bold">${successfulEvents}/${sponsorPosts.length}</p><p class="text-xs text-gray-400">Success</p></div></div><button id="like-sponsor-profile-btn" class="w-full max-w-md mx-auto mt-6 py-3 rounded-lg text-white font-bold transition-colors ${hasLiked ? 'bg-red-600 hover:bg-red-700' : 'action-button'}" data-sponsor-id="${sponsorId}"><i class="fa-solid fa-heart mr-2"></i> ${hasLiked ? 'Unlike' : 'Like'}</button></div><div class="px-2 w-full max-w-md mx-auto">${feedbacksHTML}</div>`; 
                
                content.querySelector('#close-sponsor-profile-btn').addEventListener('click', () => { screens.sponsorProfile.classList.add('hidden'); showNavBar(); }); 
                content.querySelector('#like-sponsor-profile-btn').addEventListener('click', (e) => { handleLikeSponsor(e.target.dataset.sponsorId); }); 
            }
            function updateMailboxBadge() { const unreadCount = Object.values(currentUserData?.mailbox || {}).filter(m => !m.read).length; const badge = document.querySelector('#mailbox-button .notification-badge'); if (unreadCount > 0) { if (badge) { badge.textContent = unreadCount; } else { document.getElementById('mailbox-button').innerHTML += `<div class="notification-badge">${unreadCount}</div>`; } } else { if (badge) badge.remove(); } }
            
            function setupTabs(containerId, buttonClass, sectionClass) {
                const container = document.getElementById(containerId); if (!container) return;
                const tabs = container.querySelectorAll(buttonClass); const sections = container.querySelectorAll(sectionClass); if (tabs.length === 0) return;
                let activeTab = container.querySelector(`${buttonClass}.active-tab`);
                if (!activeTab && tabs[0]) {
                    activeTab = tabs[0];
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    sections.forEach(s => s.classList.remove('active-section'));
                    if(activeTab) {
                       activeTab.classList.add('active-tab');
                       const targetSection = document.getElementById(activeTab.dataset.target);
                       if (targetSection) targetSection.classList.add('active-section');
                    }
                }
                tabs.forEach(tab => { tab.addEventListener('click', () => { if (tab.classList.contains('active-tab')) return; tabs.forEach(t => t.classList.remove('active-tab')); sections.forEach(s => s.classList.remove('active-section')); tab.classList.add('active-tab'); const targetSection = document.getElementById(tab.dataset.target); if (targetSection) targetSection.classList.add('active-section'); }); });
            }

            function setupHomeTabs() {
                const tabs = document.querySelectorAll('.home-tab-link');
                const contents = document.querySelectorAll('.home-tab-content');
                const sliderWrapper = document.getElementById('slider-wrapper');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active-home-tab'));
                        contents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active-home-tab');
                        const targetContent = document.getElementById(tab.dataset.target);
                        if(targetContent) targetContent.classList.add('active');

                        // MODIFICATION: Slider only shows on the "All" tab (`post-feed`)
                        if (tab.dataset.target === 'post-feed') { 
                            sliderWrapper.style.display = 'block';
                        } else {
                            sliderWrapper.style.display = 'none';
                        }
                        document.getElementById('home-search-input').value = '';
                        handleHomeSearch();
                    });
                });
            }

            async function addTransaction(userId, transactionData) {
                if (!userId || !transactionData) return;
                const newTransactionRef = database.ref(`users/${userId}/transactions`).push();
                const fullTransactionData = {
                    ...transactionData,
                    id: newTransactionRef.key,
                    timestamp: transactionData.timestamp || new Date().toISOString()
                };
                await newTransactionRef.set(fullTransactionData);
            }

            async function renderWalletPage() {
                const contentArea = document.getElementById('wallet-content');
                const allPosts = Object.values(window.dbData.posts || {});
                const bookings = Object.values(currentUserData.bookings || {});
                let transactions = [];
                let totalWinnings = 0, totalEntryFees = 0;
                
                const stats = calculateUserStats(currentUserData, allPosts);

                const depositsSnapshot = await database.ref('deposits').orderByChild('userId').equalTo(auth.currentUser.uid).once('value');
                const deposits = depositsSnapshot.val() || {};
                Object.values(deposits).forEach(dep => {
                    transactions.push({ date: dep.timestamp, type: `Deposit via ${dep.method}`, description: `TrxID: ${dep.trxId || 'N/A'}`, amount: dep.status === 'rejected' ? 0 : dep.amount, status: dep.status });
                });

                const withdrawalsSnapshot = await database.ref('withdrawals').orderByChild('userId').equalTo(auth.currentUser.uid).once('value');
                const withdrawals = withdrawalsSnapshot.val() || {};
                Object.values(withdrawals).forEach(wd => {
                    transactions.push({ date: wd.timestamp, type: `Withdrawal to ${wd.method}`, description: `Acc: ${wd.accountNumber}`, amount: -wd.amount, status: wd.status });
                });
                
                const userTransactionsSnapshot = await database.ref(`users/${auth.currentUser.uid}/transactions`).orderByChild('timestamp').once('value');
                const userTransactions = userTransactionsSnapshot.val() || {};
                Object.values(userTransactions).forEach(ut => {
                     let amount = ut.amount;
                    let isReward = false;
                    if (ut.type === 'Gift Card Reward' || ut.type === 'Mission Reward') {
                         isReward = true;
                         amount = `+${ut.amount} ${ut.currency}`;
                    }
                    transactions.push({ 
                        date: ut.timestamp, 
                        type: ut.type, 
                        description: ut.description, 
                        amount: amount, 
                        isReward: isReward,
                        status: ut.status || 'completed' 
                    });
                });
                
                bookings.forEach(booking => {
                    const post = allPosts.find(p => p.id === booking.postId);
                    if (post) {
                        if(post.entryFee > 0) { transactions.push({ date: booking.bookingDate, type: 'Booking Fee', description: `Entry for "${post.details.eventName}"`, amount: -post.entryFee }); }
                        if(post.status === 'cancelled' && post.entryFee > 0) { transactions.push({ date: post.cancelledAt || new Date().toISOString(), type: 'Refund', description: `Refund from "${post.details.eventName}"`, amount: post.entryFee }); }
                        if (post.status === 'completed') {
                            totalEntryFees += post.entryFee;
                            const finalRankings = Object.values(post.participants || {}).map(p => { let totalPoints = 0; if (post.approvedResults && post.approvedResults[p.userId]) { Object.values(post.approvedResults[p.userId]).forEach(mapResult => { totalPoints += calculatePoints(mapResult.kills, mapResult.position); }); } return { userId: p.userId, totalPoints }; }).sort((a, b) => b.totalPoints - a.totalPoints);
                            const myRankIndex = finalRankings.findIndex(r => r.userId === auth.currentUser.uid);
                            if (myRankIndex !== -1) {
                                const myRank = myRankIndex + 1;
                                const prizeInfo = (post.details.winningPrizes || []).find(prize => prize.rank === `Top ${myRank}`);
                                if (prizeInfo) { const prizeAmount = parseFloat(prizeInfo.prize); totalWinnings += prizeAmount; transactions.push({ date: post.completedAt || new Date().toISOString(), type: 'Winning Prize', description: `Rank #${myRank} in "${post.details.eventName}"`, amount: prizeAmount }); }
                            }
                        }
                    }
                });

                const profitLoss = totalWinnings - totalEntryFees;
                const losses = stats.played - stats.wins;
                const winRate = ((stats.played > 0 ? stats.wins/stats.played : 0) * 100).toFixed(0);

                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                const transactionsHTML = transactions.length > 0 ? transactions.map(t => {
                    const isCredit = !t.isReward && t.amount > 0;

                    let amountHTML;
                    if (t.isReward) {
                        const icon = t.amount.includes('coin') ? 'fa-coins text-yellow-400' : 'fa-gem text-cyan-400';
                        amountHTML = `<p class="font-bold text-lg"><i class="fa-solid ${icon} mr-1"></i>${t.amount}</p>`;
                    } else {
                        amountHTML = `<p class="font-bold text-lg ${isCredit ? 'text-green-400' : 'text-red-400'}">${isCredit ? '+' : ''}${t.amount.toFixed(2)}</p>`;
                    }

                    let statusBadge = '';
                    if (t.status && t.status !== 'completed') {
                        const statusColors = { pending: 'bg-yellow-500', approved: 'bg-green-500', rejected: 'bg-red-500' };
                        const statusText = t.status.charAt(0).toUpperCase() + t.status.slice(1);
                        statusBadge = `<span class="text-xs font-semibold px-2 py-1 ${statusColors[t.status]} text-white rounded-full ml-2">${statusText}</span>`;
                    }
                    return `<div class="flex justify-between items-center p-3 bg-[#2a2a2a] rounded-lg">
                                <div>
                                    <p class="font-semibold text-sm flex items-center">${t.type}${statusBadge}</p>
                                    <p class="text-xs text-gray-400">${t.description}</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(t.date).toLocaleString()}</p>
                                </div>
                                ${amountHTML}
                            </div>`
                }).join('') : '<p class="text-center text-gray-500 p-4">No transactions found.</p>';

                contentArea.innerHTML = `
                    <div class="p-4">
                        <div class="flex gap-2 mb-4">
                            <button class="tab-button wallet-tab active-tab" data-target="wallet-dashboard-section">Dashboard</button>
                            <button class="tab-button wallet-tab" data-target="wallet-stats-section">Statistics</button>
                            <button class="tab-button wallet-tab" data-target="wallet-history-section">Transaction</button>
                        </div>

                        <div id="wallet-dashboard-section" class="tab-content-section active-section space-y-4">
                            <div class="bg-gradient-to-br from-blue-900 to-purple-900 border border-blue-700 rounded-3xl p-6 shadow-lg text-left">
                               <div class="flex justify-between items-center"><div><p class="text-lg text-blue-200">Live Balance</p><h2 class="text-4xl font-bold text-white my-1">${(currentUserData.wallet?.live || 0).toFixed(2)}<span class="text-xl font-normal"> TK</span></h2></div><i class="fa-solid fa-money-bill-wave text-5xl text-blue-500/50"></i></div>
                               <div class="grid grid-cols-2 gap-4 mt-4">
                                   <button id="deposit-btn" class="w-full py-3 rounded-xl action-button text-base flex items-center justify-center"><i class="fa-solid fa-plus mr-2"></i> Deposit</button>
                                   <button id="withdraw-btn" class="w-full py-3 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 text-white font-bold flex items-center justify-center"><i class="fa-solid fa-arrow-down mr-2"></i> Withdraw</button>
                               </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700"><p class="text-sm text-gray-400">Total Winnings</p><p class="text-2xl font-bold text-green-400 mt-1">${totalWinnings.toFixed(2)} <span class="text-sm">TK</span></p></div>
                                <div class="bg-[#1e1e1e] p-4 rounded-xl border ${profitLoss >= 0 ? 'border-green-700' : 'border-red-700'}">
                                    <p class="text-sm text-gray-400">P/L (from matches)</p>
                                    <p class="text-2xl font-bold mt-1 ${profitLoss >= 0 ? 'text-green-400' : 'text-red-400'}">${profitLoss >= 0 ? '+' : ''}${profitLoss.toFixed(2)} <span class="text-lg">TK</span></p>
                                </div>
                            </div>
                        </div>

                        <div id="wallet-stats-section" class="tab-content-section space-y-4">
                             <div class="grid grid-cols-2 gap-4">
                                <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700 text-center"><p class="text-3xl font-bold font-oswald">${stats.played}</p><p class="text-xs text-gray-400 mt-1">Matches Played</p></div>
                                <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700 text-center"><p class="text-3xl font-bold font-oswald text-green-400">${stats.wins}</p><p class="text-xs text-gray-400 mt-1">Matches Won</p></div>
                                 <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700 text-center"><p class="text-3xl font-bold font-oswald text-red-400">${losses}</p><p class="text-xs text-gray-400 mt-1">Matches Lost</p></div>
                                <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700 text-center"><p class="text-3xl font-bold font-oswald">${winRate}%</p><p class="text-xs text-gray-400 mt-1">Win Rate</p></div>
                            </div>
                             <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700">
                                 <div class="grid grid-cols-2 divide-x divide-gray-700 text-center">
                                    <div><p class="text-2xl font-bold font-oswald">${stats.kills}</p><p class="text-xs text-gray-400">Total Kills</p></div>
                                    <div><p class="text-2xl font-bold font-oswald text-green-400">${totalWinnings.toFixed(2)}</p><p class="text-xs text-gray-400">Total Earning</p></div>
                                 </div>
                            </div>
                        </div>

                        <div id="wallet-history-section" class="tab-content-section space-y-2">
                            ${transactionsHTML}
                        </div>
                    </div>
                `;
                setupTabs(contentArea.id, '.wallet-tab', '.tab-content-section');
                contentArea.querySelector('#deposit-btn')?.addEventListener('click', startDepositFlow);
                contentArea.querySelector('#withdraw-btn')?.addEventListener('click', startWithdrawFlow);
            }
            
            function renderMailbox() {
                const content = document.getElementById('mailbox-content');
                const sortedMail = Object.values(currentUserData.mailbox || {}).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                let mailHTML = sortedMail.map(mail => { 
                    const post = window.dbData.posts[mail.postId]; 
                    let bodyContent = '';

                    switch(mail.type) {
                        case 'post_deleted':
                            bodyContent = `<p>Your post titled "<strong>${mail.body.postTitle}</strong>" was removed by an administrator.</p><p class="mt-2"><strong>Reason:</strong> ${mail.body.reason}</p>`;
                            break;
                        case 'edit':
                            bodyContent = `<p class="font-semibold">A sponsor has updated your points for a match.</p><p class="mt-2"><strong>Reason:</strong> ${mail.body.reason}</p>${mail.body.screenshot ? `<p class="mt-2">Evidence:</p><img src="${mail.body.screenshot}" class="w-full max-w-xs h-auto object-cover rounded-md cursor-pointer mt-1" onclick="event.stopPropagation(); showLightbox('${mail.body.screenshot}')">` : ''}`;
                            break;
                        case 'rejection':
                            bodyContent = `<p class="font-semibold text-red-400">Your result submission was rejected.</p><p class="mt-2"><strong>Reason:</strong> ${mail.body.reason}</p><p class="mt-2 text-yellow-400">Please go to the match page and submit the correct result.</p>`;
                            break;
                        default:
                             bodyContent = `<p>${mail.body.reason}</p>${mail.body.screenshot ? `<p class="mt-2">Sponsor's Evidence:</p><img src="${mail.body.screenshot}" class="w-full max-w-xs h-auto object-cover rounded-md cursor-pointer mt-1" onclick="event.stopPropagation(); showLightbox('${mail.body.screenshot}')">` : ''}${mail.body.videoLink ? `<p class="mt-2">Video Link: <a href="${mail.body.videoLink}" target="_blank" class="text-blue-400 hover:underline">Watch Video</a></p>` : ''}`;
                            break;
                    }
                    
                    const acceptButtonHTML = mail.type === 'ban' ? `<div class="mt-4 flex gap-2"><button class="accept-ban-btn w-full py-2 bg-gray-600/80 hover:bg-gray-700 rounded-lg text-xs font-bold" data-mail-id="${mail.id}" data-sponsor-id="${mail.sponsorId}">,   </button></div>` : ''; 
                    const refundInfo = mail.body.refunded ? `<p class="mt-2 text-green-400 font-semibold">Your entry fee for this match has been refunded.</p>` : (mail.type === 'ban' ? `<p class="mt-2 text-red-400 font-semibold">No refund was issued as the match was already live.</p>` : ''); 
                    
                    return `<div class="mail-item p-4 border-l-4 ${mail.read ? 'border-gray-700' : 'border-green-500 bg-[#1e1e1e]'} rounded-r-lg mb-3" data-mail-id="${mail.id}"><div class="flex justify-between items-start gap-2"><div class="flex-grow"><p class="font-bold">${mail.subject}</p>${post ? `<p class="text-sm text-gray-400">Regarding: ${post.details.eventName}</p>` : ''}</div><button class="delete-mail-btn text-gray-500 hover:text-red-500 text-lg flex-shrink-0" data-mail-id="${mail.id}"><i class="fa-solid fa-trash-can"></i></button><span class="text-xs text-gray-500 flex-shrink-0">${timeAgo(mail.timestamp)}</span></div><div class="mail-body mt-2 pt-2 border-t border-gray-700/50 text-gray-300 text-sm hidden">${bodyContent}${refundInfo}${acceptButtonHTML}</div></div>`; 
                
                }).join('');
                content.innerHTML = `<div class="p-4"><div class="space-y-2">${sortedMail.length > 0 ? mailHTML : '<p class="text-center text-gray-500 mt-8">Your mailbox is empty.</p>'}</div></div>`;
                content.querySelectorAll('.mail-item').forEach(item => item.addEventListener('click', e => { if (e.target.closest('.delete-mail-btn') || e.target.closest('.accept-ban-btn')) return; const mailId = item.dataset.mailId; item.querySelector('.mail-body').classList.toggle('hidden'); if (!currentUserData.mailbox[mailId]?.read) { database.ref(`users/${auth.currentUser.uid}/mailbox/${mailId}/read`).set(true); } }));
                content.querySelectorAll('.delete-mail-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); if (confirm("Are you sure you want to delete this mail?")) { database.ref(`users/${auth.currentUser.uid}/mailbox/${e.currentTarget.dataset.mailId}`).remove(); } }));
                content.querySelectorAll('.accept-ban-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); if (confirm('        ?')) { const sponsorId = e.target.dataset.sponsorId; const mailId = Date.now(); const newMail = { id: mailId, type: 'ban_accepted', subject: 'User Accepted Ban', body: { reason: 'The user has accepted the ban issued for this match.'}, timestamp: new Date().toISOString(), read: false }; database.ref(`users/${sponsorId}/mailbox/${mailId}`).set(newMail); btn.closest('.mail-body').innerHTML += '<p class="text-center text-green-400 font-bold mt-4">Thank you for your cooperation.</p>'; } }));
            }
            
            function setupProfilePageListeners() {
                document.getElementById('wallet-button').addEventListener('click', () => { navigateToPage('wallet-content'); });
                document.getElementById('profile-wallet-button').addEventListener('click', () => { navigateToPage('wallet-content'); });
                document.getElementById('create-team-button').addEventListener('click', () => { renderMyTeamPage(); navigateToPage('team-form-content'); });
                document.getElementById('manage-posts-button').addEventListener('click', () => { navigateToPage('manage-posts-content'); });
                document.getElementById('mailbox-button').addEventListener('click', () => { navigateToPage('mailbox-content'); });
                document.getElementById('logout-button-settings').addEventListener('click', () => { auth.signOut().then(() => window.location.reload()); });

                document.getElementById('edit-profile-btn').addEventListener('click', () => {
                    document.getElementById('edit-profile-avatar-preview').src = currentUserData.avatar || DEFAULT_AVATAR;
                    document.getElementById('edit-profile-name').value = currentUserData.name || '';
                    navigateToPage('edit-profile-content');
                });
                document.getElementById('change-password-button').addEventListener('click', () => {
                    navigateToPage('change-password-content');
                });

                document.getElementById('new-profile-image-upload').addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (file) {
                        newAvatarFile = file;
                        const reader = new FileReader();
                        reader.onload = (event) => { document.getElementById('edit-profile-avatar-preview').src = event.target.result; };
                        reader.readAsDataURL(file);
                    }
                });

                document.getElementById('edit-profile-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const form = e.target;
                    handleFormSubmit(form, 'Saving...', async () => {
                        const newName = document.getElementById('edit-profile-name').value.trim();
                        if (!newName) throw new Error('Please enter your full name.');
                        let newAvatarUrl = currentUserData.avatar; let newAvatarSize = currentUserData.avatarSizeKB || 0;
                        if (newAvatarFile) {
                            const uploadResult = await uploadImage(newAvatarFile, 'avatars');
                            if (!uploadResult || !uploadResult.url) throw new Error('Image upload failed. Please try again with a valid image file.');
                            newAvatarUrl = uploadResult.url; newAvatarSize = uploadResult.size;
                            updateTotalStorage(newAvatarSize - (currentUserData.avatarSizeKB || 0));
                        }
                        await auth.currentUser.updateProfile({ displayName: newName, photoURL: newAvatarUrl });
                        await database.ref('users/' + auth.currentUser.uid).update({ name: newName, avatar: newAvatarUrl, avatarSizeKB: newAvatarSize });
                        newAvatarFile = null; goBackToProfile(); showModal('success', 'Profile Updated', 'Your changes have been saved successfully.');
                    });
                });

                document.getElementById('change-password-form').querySelectorAll('.password-toggle').forEach(el => { el.addEventListener('click', (e) => { const input = e.target.previousElementSibling; const type = input.getAttribute('type') === 'password' ? 'text' : 'password'; input.setAttribute('type', type); e.target.classList.toggle('fa-eye'); e.target.classList.toggle('fa-eye-slash'); }); });
                document.getElementById('change-password-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const form = e.target;
                    handleFormSubmit(form, 'Updating...', async () => {
                        const currentPassword = document.getElementById('current-password').value;
                        const newPassword = document.getElementById('new-password').value;
                        const confirmNewPassword = document.getElementById('confirm-new-password').value;

                        if (newPassword !== confirmNewPassword) throw new Error('The new passwords do not match.');
                        if (newPassword.length < 6) throw new Error('Password should be at least 6 characters long.');

                        const user = auth.currentUser;
                        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                        
                        try {
                            await user.reauthenticateWithCredential(credential);
                            await user.updatePassword(newPassword);
                            form.reset(); goBackToProfile();
                            showModal('success', 'Password Updated', 'Your password has been changed. Please log in again.', 'OK', () => {
                                auth.signOut().then(() => window.location.reload());
                            });
                        } catch (error) {
                            if (error.code === 'auth/wrong-password' || error.code === 'auth/internal-error') throw { message: 'The current password you entered is incorrect.' };
                            else throw error;
                        }
                    });
                });
                 document.getElementById('delete-account-btn').addEventListener('click', () => {
                    showCustomModal({
                        type: 'error',
                        title: 'Are you absolutely sure?',
                        message: 'This action cannot be undone. This will permanently delete your account and remove your data from our servers.',
                        primaryButton: { text: 'Continue Deletion', onClick: () => {
                            showCustomModal({
                                type: 'error',
                                title: 'Final Confirmation',
                                message: `Please enter your password to confirm account deletion.<br><input type="password" id="delete-confirm-password" class="form-input mt-4" placeholder="Your Password">`,
                                primaryButton: { text: 'Confirm & Delete Account', closeOnClick: false, onClick: () => {
                                    const password = document.getElementById('delete-confirm-password').value;
                                    if (!password) {
                                        showModal('error', 'Password Required', 'You must enter your password to proceed.');
                                        return;
                                    }
                                    handleAccountDeletion(password);
                                }},
                                secondaryButton: { text: 'Cancel' }
                            });
                        }},
                        secondaryButton: { text: 'Cancel' }
                    });
                });
            }

            async function handleAccountDeletion(password) {
                const user = auth.currentUser;
                if (!user) return;
                showLoader('Deleting Account...');
                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                    await user.reauthenticateWithCredential(credential);
                    await database.ref('users/' + user.uid).remove();
                    await user.delete();
                    hideLoader();
                    localStorage.removeItem('accountCreated'); // Clear device lock
                    showModal('success', 'Account Deleted', 'Your account has been permanently deleted.', 'OK', () => {
                        window.location.reload();
                    });
                } catch (error) {
                    hideLoader();
                    if (error.code === 'auth/wrong-password') {
                        handleFirebaseError({ message: 'The password you entered is incorrect. Account deletion failed.' });
                    } else {
                        handleFirebaseError({ message: 'An error occurred during account deletion. Please try again.' });
                    }
                }
            }


            const backFromPaymentBtn = document.getElementById('back-from-payment-btn');
            function startDepositFlow() { screens.payment.classList.remove('hidden'); hideNavBar(); document.getElementById('payment-header').classList.remove('hidden'); document.querySelector('#payment-header h2').textContent = 
'  '; backFromPaymentBtn.onclick = () => { screens.payment.classList.add('hidden'); navigateToPage('wallet-content'); showNavBar(); }; renderPaymentMethodSelection('deposit'); }
            function startWithdrawFlow() { screens.payment.classList.remove('hidden'); hideNavBar(); document.getElementById('payment-header').classList.remove('hidden'); document.querySelector('#payment-header h2').textContent = '  '; backFromPaymentBtn.onclick = () => { screens.payment.classList.add('hidden'); navigateToPage('wallet-content'); showNavBar(); }; renderPaymentMethodSelection('withdraw'); }
            function renderPaymentMethodSelection(type) {
                const contentArea = document.getElementById('payment-content-area'); contentArea.scrollTop = 0; backFromPaymentBtn.onclick = () => { screens.payment.classList.add('hidden'); navigateToPage('wallet-content'); showNavBar(); };
                contentArea.innerHTML = `<h2 class="text-xl font-bold text-center mb-6">   </h2><div class="space-y-4 max-w-sm mx-auto">${Object.keys(paymentMethods).map(key => `<button class="w-full flex items-center p-4 rounded-xl payment-method-btn" data-method-key="${key}" data-type="${type}"><img src="${paymentMethods[key].logo}" class="payment-method-img"><span class="text-lg font-semibold">${paymentMethods[key].name}</span><i class="fa-solid fa-chevron-right text-gray-500 ml-auto"></i></button>`).join('')}</div>`;
                contentArea.querySelectorAll('.payment-method-btn').forEach(btn => { btn.addEventListener('click', () => { if (type === 'deposit') renderDepositForm(btn.dataset.methodKey); else if (type === 'withdraw') renderWithdrawForm(btn.dataset.methodKey); }); });
            }
            function renderDepositForm(methodKey) {
                const method = paymentMethods[methodKey]; currentPaymentData = { type: 'deposit', method: method.name, methodKey: methodKey, proofFile: null };
                const contentArea = document.getElementById('payment-content-area'); contentArea.scrollTop = 0; backFromPaymentBtn.onclick = () => renderPaymentMethodSelection('deposit');
                contentArea.innerHTML = `<div class="max-w-md mx-auto pb-24"><div class="text-center mb-6"><img src="${method.logo}" class="w-20 h-20 mx-auto mb-2 object-contain"><h2 class="text-2xl font-bold">Deposit via ${method.name}</h2></div><div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-3 mb-4"><h3 class="font-semibold text-green-400"></h3><p class="text-sm text-gray-300"> ${method.name}     <strong class="text-white">${method.type}</strong> </p><div class="bg-black/30 p-3 rounded-lg flex justify-between items-center"><code id="payment-number" class="text-xl font-bold tracking-wider">${method.number}</code><button id="copy-payment-number-btn" class="bg-gray-600 hover:bg-gray-700 w-10 h-10 rounded-md flex items-center justify-center transition-colors"><i class="fa-solid fa-copy"></i></button></div></div><div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-4"><div><label for="payment-amount" class="form-label">  (Min: ${MIN_DEPOSIT} - Max: ${MAX_DEPOSIT})</label><input type="number" id="payment-amount" class="form-input" placeholder="e.g., 500" required></div><div><label for="payment-trxid" class="form-label">  (TrxID)</label><input type="text" id="payment-trxid" class="form-input" placeholder="e.g., 9C4B8A71D3" required></div><div><label class="form-label">    (Optional)</label><div class="relative"><img id="screenshot-preview" class="hidden w-full h-auto object-cover rounded-lg mb-2 border-2 border-gray-600"><label for="payment-screenshot" class="w-full"><input type="file" id="payment-screenshot" class="hidden" accept="image/*"><div id="file-label" class="form-input text-gray-400 cursor-pointer flex justify-center items-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> <span>Select Screenshot</span></div></label></div></div></div><div class="bg-red-900/50 border border-red-700 rounded-xl p-3 text-center text-xs text-red-300 mt-4"><i class="fa-solid fa-triangle-exclamation mr-1"></i><strong>:</strong>            </div><div class="fixed bottom-0 left-0 w-full p-4 bg-[#121212]/80 backdrop-blur-sm border-t border-gray-800"><div id="payment-swipe-confirm" class="swipe-container"><div class="swipe-track"></div><div class="swipe-handle"><i class="fa-solid fa-chevron-right text-white"></i><i class="fa-solid fa-chevron-right text-white -ml-2"></i></div><div class="swipe-text">    </div></div></div></div>`;
                document.getElementById('copy-payment-number-btn').addEventListener('click', () => { navigator.clipboard.writeText(method.number).then(() => showModal('success', '  !', `${method.number}      `)); });
                document.getElementById('payment-screenshot').addEventListener('change', e => { const file = e.target.files[0]; const preview = document.getElementById('screenshot-preview'); if (file) { currentPaymentData.proofFile = file; document.getElementById('file-label').innerHTML = `<i class="fa-solid fa-check text-green-400"></i> <span class="text-white">${file.name}</span>`; const reader = new FileReader(); reader.onload = (event) => { preview.src = event.target.result; preview.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { preview.classList.add('hidden'); } });
                initSwipeToConfirm(async (resetSwipe) => {
                    const amount = parseFloat(document.getElementById('payment-amount').value);
                    const trxId = document.getElementById('payment-trxid').value.trim().toUpperCase();
                    const snapshot = await database.ref('deposits').orderByChild('trxId').equalTo(trxId).once('value');
                    if (isNaN(amount) || !trxId) {
                        showModal('error', ' ', '        ');
                        resetSwipe();
                    } else if (amount < MIN_DEPOSIT || amount > MAX_DEPOSIT) {
                        showModal('error', '  ', `  ${MIN_DEPOSIT}    ${MAX_DEPOSIT}    `);
                        resetSwipe();
                    } else if (snapshot.exists()) {
                        showModal('error', ' ', '           ');
                        resetSwipe();
                    } else {
                        currentPaymentData.amount = amount;
                        currentPaymentData.trxId = trxId;
                        submitDepositRequest();
                    }
                });
            }

            async function renderWithdrawForm(methodKey) {
                const method = paymentMethods[methodKey];
                const today = new Date().toISOString().slice(0, 10);
                const withdrawalsSnapshot = await database.ref('withdrawals').orderByChild('userId').equalTo(auth.currentUser.uid).once('value');
                const todayWithdrawals = Object.values(withdrawalsSnapshot.val() || {}).filter(w => w.timestamp.startsWith(today));
                if (todayWithdrawals.length >= WITHDRAW_LIMIT_PER_DAY) { showModal('error', '  ', `   ${WITHDRAW_LIMIT_PER_DAY}          `, ' ', () => startWithdrawFlow()); return; }
                currentPaymentData = { type: 'withdraw', method: method.name, methodKey: methodKey }; const contentArea = document.getElementById('payment-content-area'); contentArea.scrollTop = 0; backFromPaymentBtn.onclick = () => renderPaymentMethodSelection('withdraw');
                contentArea.innerHTML = `<div class="max-w-md mx-auto pb-24"><div class="text-center mb-6"><img src="${method.logo}" class="w-20 h-20 mx-auto mb-2 object-contain"><h2 class="text-2xl font-bold">Withdraw to ${method.name}</h2></div><div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-4"><div><label for="payment-amount" class="form-label">  (Min: ${MIN_WITHDRAW} - Max: ${MAX_WITHDRAW})</label><input type="number" id="payment-amount" class="form-input" placeholder="e.g., 300" required></div><div><label for="account-number" class="form-label"> ${method.name}  </label><input type="tel" id="account-number" class="form-input" placeholder="e.g., 01xxxxxxxxx" required></div></div><div class="bg-blue-900/50 border border-blue-700 rounded-xl p-3 text-center text-xs text-blue-300 mt-4"><i class="fa-solid fa-info-circle mr-1"></i>       </div><div class="fixed bottom-0 left-0 w-full p-4 bg-[#121212]/80 backdrop-blur-sm border-t border-gray-800"><div id="payment-swipe-confirm" class="swipe-container"><div class="swipe-track"></div><div class="swipe-handle"><i class="fa-solid fa-chevron-right text-white"></i><i class="fa-solid fa-chevron-right text-white -ml-2"></i></div><div class="swipe-text">   </div></div></div></div>`;
                initSwipeToConfirm((resetSwipe) => {
                    const amount = parseFloat(document.getElementById('payment-amount').value);
                    const accountNumber = document.getElementById('account-number').value.trim();
                    const currentBalance = currentUserData.wallet?.live || 0;
                    if (isNaN(amount) || !accountNumber) {
                        showModal('error', ' ', '         ');
                        resetSwipe();
                    } else if (amount > currentBalance) {
                        showModal('error', ' ', `        ${currentBalance.toFixed(2)} `);
                        resetSwipe();
                    } else if (amount < MIN_WITHDRAW || amount > MAX_WITHDRAW) {
                        showModal('error', '  ', `  ${MIN_WITHDRAW}    ${MAX_WITHDRAW}    `);
                        resetSwipe();
                    } else {
                        currentPaymentData.amount = amount;
                        currentPaymentData.accountNumber = accountNumber;
                        submitWithdrawRequest();
                    }
                });
            }
            
            async function submitDepositRequest() {
                const { method, amount, trxId, proofFile } = currentPaymentData; let screenshotUrl = null;
                try {
                    showLoader('Submitting Request...');
                    if (proofFile) {
                        const uploadResult = await uploadImage(proofFile, 'deposit-proofs');
                        if (uploadResult && uploadResult.url) { screenshotUrl = uploadResult.url; updateTotalStorage(uploadResult.size); } 
                        else { throw new Error("Screenshot upload failed."); }
                    }
                    const depositId = database.ref('deposits').push().key;
                    await database.ref('deposits/' + depositId).set({ id: depositId, userId: auth.currentUser.uid, userName: currentUserData.name, method, amount, trxId, screenshotUrl, timestamp: new Date().toISOString(), status: 'pending' });
                    hideLoader(); screens.payment.classList.add('hidden'); navigateToPage('wallet-content'); showNavBar();
                    showCustomModal({ type: 'success', title: '  ', message: '               ', primaryButton: { text: ' ' } });
                } catch (error) { hideLoader(); handleFirebaseError(error); renderPaymentMethodSelection('deposit'); }
            }
            
            async function submitWithdrawRequest() {
                const { method, amount, accountNumber } = currentPaymentData;
                try {
                    showLoader('Submitting Request...');
                    const newBalance = (currentUserData.wallet?.live || 0) - amount;
                    await database.ref(`users/${auth.currentUser.uid}/wallet/live`).set(newBalance);
                    const withdrawId = database.ref('withdrawals').push().key;
                    await database.ref('withdrawals/' + withdrawId).set({ id: withdrawId, userId: auth.currentUser.uid, userName: currentUserData.name, method, amount, accountNumber, timestamp: new Date().toISOString(), status: 'pending' });
                    hideLoader(); screens.payment.classList.add('hidden'); navigateToPage('wallet-content'); showNavBar();
                    showCustomModal({ type: 'success', title: '  ', message: '         ', primaryButton: { text: ' ' } });
                } catch (error) { await database.ref(`users/${auth.currentUser.uid}/wallet/live`).set(currentUserData.wallet?.live || 0); hideLoader(); handleFirebaseError(error); renderPaymentMethodSelection('withdraw'); }
            }

            function renderHomeGuildPosts() {
                const container = document.getElementById('home-guild-feed');
                const allGuildPosts = Object.values(window.dbData.guildPosts || {});
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const activePosts = allGuildPosts.filter(post => new Date(post.timestamp).getTime() > thirtyDaysAgo).sort((a, b) => new Date(b.timestamp) - a.timestamp);
                if (activePosts.length === 0) { container.innerHTML = `<div class="text-center text-gray-500 p-10 bg-gray-800/50 rounded-lg"><i class="fa-solid fa-users-slash text-4xl mb-4"></i><p>     </p></div>`; return; }
                container.innerHTML = activePosts.map(createGuildPostCardHTML).join('');
            }

            function createGuildPostCardHTML(post) {
                const alreadyApplied = post.applications && post.applications[auth.currentUser.uid]; const isMyPost = post.creatorId === auth.currentUser.uid; let buttonHTML;
                if(isMyPost) { buttonHTML = `<button class="manage-my-guild-post-btn w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 font-bold text-sm">Manage Post</button>`;
                } else if(alreadyApplied) { buttonHTML = `<button class="w-full py-3 rounded-lg bg-yellow-600 font-bold text-sm" disabled>  </button>`;
                } else { buttonHTML = `<button class="guild-apply-btn w-full py-3 rounded-lg action-button font-bold text-sm" data-guild-post-id="${post.id}">   </button>`; }
                return `<div class="guild-post-card rounded-2xl overflow-hidden bg-gradient-to-br from-[#2a2a2a] to-[#202020] border border-gray-700" data-guild-post-id-wrapper="${post.id}">
                    <div class="relative">
                        <img src="${post.guildImage || 'https://via.placeholder.com/400x200?text=No+Image'}" class="w-full h-auto max-h-80 object-cover" alt="Guild Image">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-4 w-full">
                            <div class="flex justify-between items-end">
                                <div class="flex items-center gap-3 cursor-pointer user-profile-trigger" data-user-id="${post.creatorId}">
                                    <img src="${post.creatorAvatar || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-500">
                                    <div>
                                        <p class="font-semibold text-white text-sm">${post.creatorName}</p>
                                        <p class="text-xs text-gray-400">${timeAgo(post.timestamp)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-2xl font-bold font-oswald text-green-300">${post.guildName}</h3>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <span class="card-tag"><i class="fa-solid fa-globe text-green-400"></i> ${post.region}</span>
                            <span class="card-tag"><i class="fa-solid fa-gamepad text-blue-400"></i> ${post.playerType}</span>
                            <span class="card-tag"><i class="fa-solid fa-shield-halved text-yellow-400"></i> ${post.guildType}</span>
                        </div>
                        <details class="border-t border-gray-700 pt-3 mt-4">
                            <summary class="font-semibold text-gray-300 cursor-pointer text-sm">Rules & Regulations</summary>
                            <ul class="list-disc list-inside text-gray-400 text-xs space-y-1 mt-2 pl-2">${post.rules.map(rule => `<li>${rule}</li>`).join('')}</ul>
                        </details>
                    </div>
                    <div class="p-3 bg-black/30">${buttonHTML}</div>
                </div>`;
            }

            document.getElementById('home-content').addEventListener('click', e => {
                const applyBtn = e.target.closest('.guild-apply-btn'); 
                const manageBtn = e.target.closest('.manage-my-guild-post-btn');
                if (applyBtn) { const postId = applyBtn.dataset.guildPostId; startGuildApplicationFlow(postId); }
                if(manageBtn) { document.getElementById('manage-posts-button').click(); }
            });

            function renderGuildPostForm() {
                guildPostImageFile = null;
                const contentArea = document.getElementById('guild-post-form-content');
                contentArea.innerHTML = `<header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center -mx-4 -mt-4 mb-4"><button id="back-from-guild-form" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Create Guild Post</h2><div class="w-10"></div></header><form id="guild-post-form" class="space-y-6"><div class="form-section p-4 rounded-xl space-y-4"><div><label class="form-label text-center block">Guild Image</label><div class="relative w-full h-40 mx-auto border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center"><input type="file" id="guild-image-upload" class="hidden" accept="image/*" required><label for="guild-image-upload" class="cursor-pointer group w-full h-full"><img id="guild-image-preview" src="" class="hidden absolute inset-0 w-full h-full object-cover rounded-lg"><div id="guild-image-placeholder" class="flex flex-col items-center justify-center h-full text-gray-400"><i class="fa-solid fa-camera text-3xl"></i><p class="mt-2 text-sm">Select Image</p></div></label></div></div><div><label for="guild-name" class="form-label">Guild Name</label><input type="text" id="guild-name" class="form-input" required></div><div><label for="guild-code" class="form-label">Guild Code</label><input type="text" id="guild-code" class="form-input" required></div></div><div class="form-section p-4 rounded-xl space-y-4"><div><label class="form-label">Guild Region</label><div class="flex gap-2"><div><input type="radio" id="region-bd" name="guild-region" class="hidden custom-radio" value="Bangladesh" checked><label for="region-bd" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Bangladesh</label></div><div><input type="radio" id="region-nepal" name="guild-region" class="hidden custom-radio" value="Nepal"><label for="region-nepal" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Nepal</label></div></div></div><div><label class="form-label">Player Type</label><div class="flex gap-2"><div><input type="radio" id="player-esports" name="player-type" class="hidden custom-radio" value="E-SPORTS" checked><label for="player-esports" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">E-SPORTS</label></div><div><input type="radio" id="player-normal" name="player-type" class="hidden custom-radio" value="Normal"><label for="player-normal" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Normal</label></div><div><input type="radio" id="player-any" name="player-type" class="hidden custom-radio" value="Any"><label for="player-any" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Any</label></div></div></div><div><label class="form-label">Guild Type</label><div class="flex gap-2"><div><input type="radio" id="guild-esport" name="guild-type" class="hidden custom-radio" value="Esport" checked><label for="guild-esport" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Esport</label></div><div><input type="radio" id="guild-friendly" name="guild-type" class="hidden custom-radio" value="Friendly"><label for="guild-friendly" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Friendly</label></div><div><input type="radio" id="guild-normal" name="guild-type" class="hidden custom-radio" value="Normal"><label for="guild-normal" class="block w-full text-center py-2 px-4 border border-gray-600 rounded-lg cursor-pointer">Normal</label></div></div></div></div><div class="form-section p-4 rounded-xl space-y-4"><div class="flex justify-between items-center"><label class="form-label mb-0">Rules & Regulation</label><button type="button" id="add-rule-btn" class="text-green-400"><i class="fa-solid fa-plus-circle"></i> Add Rule</button></div><div id="rules-container" class="space-y-2"><input type="text" class="form-input guild-rule" placeholder="Rule 1" required></div></div><button type="submit" class="w-full py-4 mt-6 rounded-xl action-button text-lg flex items-center justify-center h-[52px]">Post</button></form>`;
                document.getElementById('back-from-guild-form').addEventListener('click', () => screens.guildPostForm.classList.add('hidden'));
                document.getElementById('guild-image-upload').addEventListener('change', e => { const file = e.target.files[0]; if (file) { guildPostImageFile = file; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('guild-image-preview').src = event.target.result; document.getElementById('guild-image-preview').classList.remove('hidden'); document.getElementById('guild-image-placeholder').classList.add('hidden'); }; reader.readAsDataURL(file); } });
                document.getElementById('add-rule-btn').addEventListener('click', () => { const container = document.getElementById('rules-container'); const ruleCount = container.children.length + 1; const newInput = document.createElement('input'); newInput.type = 'text'; newInput.className = 'form-input guild-rule'; newInput.placeholder = `Rule ${ruleCount}`; newInput.required = true; container.appendChild(newInput); });
                document.getElementById('guild-post-form').addEventListener('submit', handleGuildPostSubmit);
            }

            function handleGuildPostSubmit(e) {
                e.preventDefault();
                const form = e.target;
                handleFormSubmit(form, 'Posting...', async () => {
                    const rules = Array.from(form.querySelectorAll('.guild-rule')).map(input => input.value.trim()).filter(Boolean);
                    if (rules.length === 0) throw new Error('Please add at least one rule.');
                    const uploadResult = await uploadImage(guildPostImageFile, 'guild-images');
                    if (!uploadResult) throw new Error('Image upload failed. Make sure you selected an image.');
                    const postData = { creatorId: auth.currentUser.uid, creatorName: currentUserData.name, creatorAvatar: currentUserData.avatar || DEFAULT_AVATAR, guildImage: uploadResult.url, guildName: form.querySelector('#guild-name').value, guildCode: form.querySelector('#guild-code').value, region: form.querySelector('input[name="guild-region"]:checked').value, playerType: form.querySelector('input[name="player-type"]:checked').value, guildType: form.querySelector('input[name="guild-type"]:checked').value, rules: rules, timestamp: new Date().toISOString() };
                    const newPostRef = database.ref('guildPosts').push();
                    await newPostRef.set({ ...postData, id: newPostRef.key });
                    screens.guildPostForm.classList.add('hidden'); 
                    document.getElementById('manage-posts-button').click();
                    showModal('success', '  !', '      ');
                });
            }
            
            async function startGuildApplicationFlow(postId) {
                const post = window.dbData.guildPosts?.[postId];
                if(!post) { showModal('error', '   ', '    '); return; }
                screens.guildApplication.classList.remove('hidden'); renderGuildApplicationStep1_Rules(post);
            }

            function renderGuildApplicationStep1_Rules(post) {
                const contentArea = document.getElementById('guild-application-content');
                const rulesHTML = post.rules.map(rule => `<li class="flex items-start"><i class="fa-solid fa-check text-green-400 mt-1 mr-2"></i><span>${rule}</span></li>`).join('');
                contentArea.innerHTML = `<header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center -mx-4 -mt-4 mb-4"><h2 class="text-xl font-bold">Guild Rules</h2><button id="close-guild-app-btn" class="text-gray-400 text-3xl">&times;</button></header><div class="p-4 bg-[#1e1e1e] border border-gray-700 rounded-lg mb-6"><ul class="space-y-2 text-gray-300">${rulesHTML}</ul></div><label for="agree-guild-rules" class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" id="agree-guild-rules" class="hidden"><div class="w-6 h-6 border-2 border-gray-500 rounded flex items-center justify-center check-icon-container"><i class="fa-solid fa-check text-white hidden"></i></div><span class="text-gray-300">     </span></label><div class="fixed bottom-0 left-0 w-full p-4 bg-[#1e1e1e] border-t border-gray-800"><button id="guild-app-next-btn" class="w-full py-3 rounded-lg action-button" disabled>Next</button></div>`;
                const agreeCheckbox = contentArea.querySelector('#agree-guild-rules'), nextBtn = contentArea.querySelector('#guild-app-next-btn');
                agreeCheckbox.addEventListener('change', () => { contentArea.querySelector('.check-icon-container .fa-check').classList.toggle('hidden', !agreeCheckbox.checked); nextBtn.disabled = !agreeCheckbox.checked; });
                nextBtn.addEventListener('click', () => renderGuildApplicationStep2_Form(post));
                contentArea.querySelector('#close-guild-app-btn').addEventListener('click', () => screens.guildApplication.classList.add('hidden'));
            }

            function renderGuildApplicationStep2_Form(post) {
                const contentArea = document.getElementById('guild-application-content');
                contentArea.innerHTML = `<header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center -mx-4 -mt-4 mb-4"><button id="back-to-rules-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-xl font-bold">Application Form</h2><div class="w-10"></div></header><form id="guild-application-form" class="space-y-4 pb-16"><div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-3"><h3 class="font-semibold text-green-400">.   </h3><p class="text-sm text-gray-300">       </p><div class="bg-black/30 p-3 rounded-lg flex justify-between items-center"><code class="text-xl font-bold tracking-wider">${post.guildCode}</code><button type="button" class="copy-guild-code-btn bg-gray-600 hover:bg-gray-700 w-10 h-10 rounded-md flex items-center justify-center"><i class="fa-solid fa-copy"></i></button></div></div><div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-4"><h3 class="font-semibold text-green-400">.   </h3><label class="form-label">   ?</label><select id="request-sent-confirm" class="form-select" required><option value="">Select</option><option value="yes"></option></select><div><label for="applicant-game-name" class="form-label"> - </label><input type="text" id="applicant-game-name" class="form-input" required></div><div><label for="applicant-game-uid" class="form-label"> - UID</label><input type="text" id="applicant-game-uid" class="form-input" required></div></div></form><div class="fixed bottom-0 left-0 w-full p-4 bg-[#1e1e1e] border-t border-gray-800"><button id="submit-guild-app-btn" class="w-full py-3 rounded-lg action-button">Submit Application</button></div>`;
                contentArea.querySelector('#back-to-rules-btn').addEventListener('click', () => renderGuildApplicationStep1_Rules(post));
                contentArea.querySelector('.copy-guild-code-btn').addEventListener('click', () => navigator.clipboard.writeText(post.guildCode).then(() => showModal('success', ' !', `    `)));
                contentArea.querySelector('#submit-guild-app-btn').addEventListener('click', () => handleGuildApplicationSubmit(post));
            }

            async function handleGuildApplicationSubmit(post) {
                const confirmSelect = document.getElementById('request-sent-confirm'); const gameName = document.getElementById('applicant-game-name').value.trim(); const gameUid = document.getElementById('applicant-game-uid').value.trim();
                if(confirmSelect.value !== 'yes' || !gameName || !gameUid) { showModal('error', '  ', '      '); return; }
                const applicationData = { applicantId: auth.currentUser.uid, applicantName: currentUserData.name, applicantInGameName: gameName, applicantInGameUid: gameUid, timestamp: new Date().toISOString(), status: 'pending' };
                try {
                    await database.ref(`guildPosts/${post.id}/applications/${auth.currentUser.uid}`).set(applicationData);
                    screens.guildApplication.classList.add('hidden');
                    showCustomModal({ type: 'success', title: '  !', message: '     ', autoClose: 3000 });
                } catch(error) { handleFirebaseError(error); }
            }
            
            function renderManageNeedPage() {
                const container = document.getElementById('manage-posts-content');
                setupTabs(container.id, '.manage-need-tab', '.tab-content-section');
                
                const currentActiveTab = container.querySelector('.manage-need-tab.active-tab');
                if (!currentActiveTab) {
                    const firstTab = container.querySelector('.manage-need-tab');
                    if (firstTab) firstTab.click(); 
                }
                
                renderManagePostTab(); renderApprovalsTab(); renderMyRequestsTab();
            }

            function renderManagePostTab() {
                const container = document.getElementById('my-posts-section'); container.innerHTML = `<div class="spinner mx-auto"></div>`;
                const myGuildPosts = Object.values(window.dbData.guildPosts || {}).filter(p => p.creatorId === auth.currentUser.uid);
                const myPlayerSquadPosts = Object.values(window.dbData.playerSquadPosts || {}).filter(p => p.creatorId === auth.currentUser.uid);
                const myPosts = [...myGuildPosts, ...myPlayerSquadPosts].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (myPosts.length === 0) { container.innerHTML = `<p class="text-center text-gray-500">You haven't created any posts yet.</p>`; return; }
                container.innerHTML = myPosts.map(post => {
                    const isGuildPost = !!post.guildName; const title = isGuildPost ? post.guildName : 'Player/Squad Post'; const image = isGuildPost ? post.guildImage : post.imageUrl; const stats = isGuildPost ? `${Object.keys(post.applications || {}).length} Applications` : 'Player/Squad Post'; const postId = post.id; const postType = isGuildPost ? 'guildPosts' : 'playerSquadPosts';
                    return `<div class="bg-[#2a2a2a] p-3 rounded-lg"><div class="flex justify-between items-center"><div class="flex items-center gap-3"><img src="${image || 'https://via.placeholder.com/48'}" class="w-12 h-12 object-cover rounded-md"><div><p class="font-semibold">${title}</p><p class="text-xs text-gray-400">${stats}</p></div></div><button class="delete-need-post-btn text-red-500 hover:text-red-400" data-post-id="${postId}" data-post-type="${postType}"><i class="fa-solid fa-trash-can text-xl"></i></button>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">Post ID: ${postId}</p>
                    </div>`
                }).join('');

                container.querySelectorAll('.delete-need-post-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                    const { postId, postType } = e.currentTarget.dataset;
                        showCustomModal({
                            type: 'error',
                            title: '  ?',
                            message: '         ',
                            primaryButton: { text: ', ', onClick: () => {
                                database.ref(`${postType}/${postId}`).remove().then(() => {
                                    showModal('success', '   ', '     ');
                                }).catch(handleFirebaseError);
                            }},
                            secondaryButton: { text: '' }
                        });
                    });
                });
            }

            function renderApprovalsTab() {
                const container = document.getElementById('approvals-section');
                container.innerHTML = `<div class="spinner mx-auto"></div>`;
                const myPosts = Object.values(window.dbData.guildPosts || {}).filter(p => p.creatorId === auth.currentUser.uid);
                const allApplications = myPosts.flatMap(post => 
                    Object.values(post.applications || {}).map(app => ({...app, postName: post.guildName, postId: post.id }))
                );
                
                if (allApplications.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">You have no pending approvals.</p>`;
                    return;
                }

                container.innerHTML = allApplications.map(app => {
                    let statusHTML;
                    if (app.status === 'pending') {
                        statusHTML = `
                        <div class="flex gap-2 mt-2">
                            <button class="approve-guild-app-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs" data-post-id="${app.postId}" data-applicant-id="${app.applicantId}">Approve</button>
                            <button class="reject-guild-app-btn flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs" data-post-id="${app.postId}" data-applicant-id="${app.applicantId}">Reject</button>
                        </div>`;
                    } else {
                        const statusClass = app.status === 'approved' ? 'text-green-400' : 'text-red-400';
                        statusHTML = `<p class="text-sm font-bold mt-2 ${statusClass}">${app.status.toUpperCase()}</p>`;
                    }

                    return `
                    <div class="bg-[#2a2a2a] p-3 rounded-lg">
                        <p class="text-xs text-gray-400">For Guild: <span class="font-semibold text-white">${app.postName}</span></p>
                        <div class="border-t border-gray-700 my-2"></div>
                        <p><strong>Applicant:</strong> ${app.applicantName}</p>
                        <p><strong>Game Name:</strong> ${app.applicantInGameName}</p>
                        <p><strong>Game UID:</strong> ${app.applicantInGameUid}</p>
                        ${statusHTML}
                    </div>
                `;
                }).join('');

                container.querySelectorAll('.approve-guild-app-btn').forEach(btn => btn.addEventListener('click', e => {
                    const { postId, applicantId } = e.currentTarget.dataset;
                    database.ref(`guildPosts/${postId}/applications/${applicantId}/status`).set('approved');
                }));
                container.querySelectorAll('.reject-guild-app-btn').forEach(btn => btn.addEventListener('click', e => {
                    const { postId, applicantId } = e.currentTarget.dataset;
                    showCustomModal({
                        type: 'error',
                        title: '  ',
                        message: `<textarea id="rejection-reason-input" class="form-textarea w-full" rows="3" placeholder="  ..."></textarea>`,
                        primaryButton: { text: 'Submit Rejection', closeOnClick: false, onClick: () => {
                             const reason = document.getElementById('rejection-reason-input').value.trim();
                             if (!reason) {
                                 alert('Please provide a reason.');
                                 return;
                             }
                             database.ref(`guildPosts/${postId}/applications/${applicantId}`).update({ status: 'rejected', rejectionReason: reason })
                                .then(() => {
                                    document.getElementById('modal-screen').classList.add('hidden');
                                    document.getElementById('dashboard-screen').classList.remove('blur-it');
                                });
                        }},
                        secondaryButton: { text: 'Cancel'}
                    });
                }));
            }

            function renderMyRequestsTab() {
                const container = document.getElementById('my-requests-section');
                container.innerHTML = `<div class="spinner mx-auto"></div>`;
                
                const allPosts = Object.values(window.dbData.guildPosts || {});
                const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);

                const myApps = allPosts.flatMap(post => 
                    post.applications && post.applications[auth.currentUser.uid]
                    ? [{ ...post.applications[auth.currentUser.uid], postName: post.guildName, postId: post.id }]
                    : []
                ).filter(app => new Date(app.timestamp).getTime() > threeDaysAgo);

                if (myApps.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">You have not applied to any guilds recently.</p>`;
                    return;
                }

                container.innerHTML = myApps.map(app => {
                    let statusHTML;
                    const statusClass = {
                        pending: 'text-yellow-400',
                        approved: 'text-green-400',
                        rejected: 'text-red-400'
                    }[app.status];
                    
                    if (app.status === 'approved') {
                        statusHTML = `<p class="font-bold ${statusClass}">Congratulations!   </p>`;
                    } else if (app.status === 'rejected') {
                        statusHTML = `
                        <p class="font-bold ${statusClass}">    
                            <button class="view-reason-btn text-blue-400 underline text-sm ml-1" data-reason="${app.rejectionReason || 'No reason provided.'}"> </button>
                        </p>`;
                    } else {
                        statusHTML = `<p class="font-bold ${statusClass}">Pending</p>`;
                    }
                    
                    return `
                    <div class="bg-[#2a2a2a] p-3 rounded-lg">
                        <p class="font-semibold">Application to: <span class="text-green-400">${app.postName}</span></p>
                        <p class="text-xs text-gray-400">${timeAgo(app.timestamp)}</p>
                        <div class="border-t border-gray-700 my-2"></div>
                        <div class="text-sm">${statusHTML}</div>
                    </div>
                    `;
                }).join('');

                container.querySelectorAll('.view-reason-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        showModal('error', '  ', e.currentTarget.dataset.reason, ' ');
                    });
                });
            }
            
            function calculateUserProfileStats(userId) {
                const userData = window.dbData.users[userId];
                if (!userData) return null;
            
                const allPosts = window.dbData.posts;
                const { played, kills } = calculateUserStats(userData, allPosts);

                let totalWinnings = 0;
                const bookings = Object.values(userData.bookings || {});
                bookings.forEach(booking => {
                    const post = allPosts[booking.postId];
                    if (post && post.status === 'completed') {
                        const finalRankings = Object.values(post.participants || {}).map(p => { 
                            let totalPoints = 0; 
                            if (post.approvedResults && post.approvedResults[p.userId]) { 
                                Object.values(post.approvedResults[p.userId]).forEach(mapResult => { 
                                    totalPoints += calculatePoints(mapResult.kills, mapResult.position); 
                                }); 
                            } 
                            return { userId: p.userId, totalPoints }; 
                        }).sort((a, b) => b.totalPoints - a.totalPoints);

                        const myRankIndex = finalRankings.findIndex(r => r.userId === userId);
                        if (myRankIndex !== -1) {
                            const myRank = myRankIndex + 1;
                            const prizeInfo = (post.details.winningPrizes || []).find(prize => prize.rank === `Top ${myRank}`);
                            if (prizeInfo) {
                                totalWinnings += parseFloat(prizeInfo.prize) || 0;
                            }
                        }
                    }
                });

                return {
                    teamName: userData.team?.name || 'N/A',
                    played,
                    kills,
                    totalWinnings
                };
            }


            function renderUserProfile(userId) {
                const user = window.dbData.users[userId];
                if (!user) {
                    showModal('error', 'User Not Found', 'Could not retrieve user details.');
                    return;
                }

                const stats = calculateUserProfileStats(userId);
                const content = document.getElementById('user-profile-content');
                
                content.innerHTML = `
                    <header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center -mx-4 -mt-4 mb-4">
                        <button id="back-from-user-profile" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <h2 class="text-xl font-bold">User Profile</h2>
                        <div class="w-10"></div>
                    </header>
                    <div class="text-center">
                        <img src="${user.avatar || DEFAULT_AVATAR}" class="w-32 h-32 rounded-full mx-auto border-4 border-green-500">
                        <h2 class="text-3xl font-bold mt-4">${user.name}</h2>
                        <p class="text-gray-500 text-sm">Team: ${stats.teamName}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-8">
                        <div class="user-profile-stat">
                            <p class="user-profile-stat-value">${stats.played}</p>
                            <p class="user-profile-stat-label">Total Matches</p>
                        </div>
                        <div class="user-profile-stat">
                            <p class="user-profile-stat-value text-red-400">${stats.kills}</p>
                            <p class="user-profile-stat-label">Total Kills</p>
                        </div>
                        <div class="user-profile-stat col-span-2">
                             <p class="user-profile-stat-value text-green-400">${stats.totalWinnings.toFixed(2)} <span class="text-lg">TK</span></p>
                            <p class="user-profile-stat-label">Total Earnings</p>
                        </div>
                    </div>
                `;

                content.querySelector('#back-from-user-profile').addEventListener('click', () => {
                    screens.userProfile.classList.add('hidden');
                    showNavBar();
                });
            }
            
            function renderHomePlayerSquadPosts() {
                const container = document.getElementById('home-player-squad-feed');
                const allPosts = Object.values(window.dbData.playerSquadPosts || {});
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                const activePosts = allPosts.filter(p => new Date(p.timestamp).getTime() > thirtyDaysAgo).sort((a,b) => new Date(b.timestamp) - a.timestamp);

                if(activePosts.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 p-10 bg-gray-800/50 rounded-lg"><i class="fa-solid fa-user-plus text-4xl mb-4"></i><p>No one is looking for players or squads right now.</p></div>`;
                    return;
                }
                container.innerHTML = activePosts.map(createPlayerSquadPostCardHTML).join('');
            }
            
            function createPlayerSquadPostCardHTML(post) {
                return `
                <div class="player-squad-post-card rounded-2xl overflow-hidden bg-gradient-to-br from-[#2a2a2a] to-[#202020] border border-gray-700" data-playersquad-post-id-wrapper="${post.id}">
                    ${post.imageUrl ? `<img src="${post.imageUrl}" class="w-full h-auto max-h-96 object-contain" alt="Post Image">` : ''}
                    <div class="p-4">
                         <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3 cursor-pointer user-profile-trigger" data-user-id="${post.creatorId}">
                                <img src="${post.creatorAvatar || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-500">
                                <div>
                                    <p class="font-semibold text-white">${post.creatorName}</p>
                                    <p class="text-xs text-gray-400">${timeAgo(post.timestamp)}</p>
                                </div>
                            </div>
                         </div>
                        <p class="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed">${post.description}</p>
                        <button class="w-full mt-4 py-2.5 rounded-lg bg-green-600/20 text-green-300 border border-green-600/50 font-bold text-sm hover:bg-green-600/40 transition-colors">Contact User</button>
                    </div>
                </div>`;
            }

            function renderPlayerSquadPostForm() {
                playerSquadPostImageFile = null;
                const contentArea = document.getElementById('player-squad-post-form-content');
                contentArea.innerHTML = `
                     <header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center -mx-4 -mt-4 mb-4">
                        <button id="back-from-ps-form" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold">Need Player/Squad</h2>
                        <div class="w-10"></div>
                    </header>
                    <form id="player-squad-post-form" class="space-y-4">
                         <div>
                            <label for="ps-description" class="form-label">Description (Max 100 words)</label>
                            <textarea id="ps-description" class="form-textarea" rows="5" maxlength="550" placeholder="Describe what you're looking for..." required></textarea>
                            <p id="word-count" class="text-right text-xs text-gray-500 mt-1">0 / 100 words</p>
                        </div>
                         <div>
                            <label class="form-label">Image (Optional)</label>
                            <input type="file" id="ps-image-upload" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-white hover:file:bg-gray-700" accept="image/*">
                        </div>
                        <button type="submit" class="w-full py-3 mt-4 rounded-xl action-button text-lg">Post</button>
                    </form>
                `;
                document.getElementById('back-from-ps-form').addEventListener('click', () => screens.playerSquadPostForm.classList.add('hidden'));
                
                const textarea = document.getElementById('ps-description');
                const wordCountEl = document.getElementById('word-count');
                textarea.addEventListener('input', () => {
                    const words = textarea.value.trim().split(/\s+/).filter(Boolean);
                    const wordCount = words.length > 100 ? 100 : words.length;
                    wordCountEl.textContent = `${wordCount} / 100 words`;
                    if(words.length > 100) {
                        textarea.value = words.slice(0, 100).join(' ');
                    }
                });
                
                document.getElementById('ps-image-upload').addEventListener('change', e => { playerSquadPostImageFile = e.target.files[0]; });
                document.getElementById('player-squad-post-form').addEventListener('submit', handlePlayerSquadPostSubmit);
            }

            function handlePlayerSquadPostSubmit(e) {
                e.preventDefault();
                const form = e.target;
                handleFormSubmit(form, 'Posting...', async () => {
                    const description = document.getElementById('ps-description').value.trim();
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const promoKeywords = ['buy', 'sell', 'promote', 'follow me', 'subscribe', 'shop', 'discount'];
                    if(urlRegex.test(description) || promoKeywords.some(keyword => description.toLowerCase().includes(keyword))) {
                        throw new Error('Posts cannot contain links or promotional language.');
                    }
                    let imageUrl = null;
                    if(playerSquadPostImageFile) {
                        const uploadResult = await uploadImage(playerSquadPostImageFile, 'player-squad-posts');
                        if(!uploadResult) throw new Error('Image upload failed');
                        imageUrl = uploadResult.url;
                    }
                    const postData = { id: '', creatorId: auth.currentUser.uid, creatorName: currentUserData.name, creatorAvatar: currentUserData.avatar, description, imageUrl, timestamp: new Date().toISOString() };
                    const newPostRef = database.ref('playerSquadPosts').push();
                    postData.id = newPostRef.key;
                    await newPostRef.set(postData);

                    screens.playerSquadPostForm.classList.add('hidden');
                    document.getElementById('manage-posts-button').click();
                    setTimeout(() => document.querySelector('.manage-need-tab[data-target="my-posts-section"]').click(), 250);
                    showModal('success', 'Post Created', 'Your post has been successfully created.');
                });
            }
            
            function setupSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                const toggleBtn = document.getElementById('sidebar-toggle');
                const closeSidebar = () => {
                    sidebar.classList.remove('open');
                    overlay.classList.add('hidden');
                };
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.add('open');
                    overlay.classList.remove('hidden');
                });
                overlay.addEventListener('click', closeSidebar);
                
                document.getElementById('sidebar-profile-header').addEventListener('click', () => {
                    closeSidebar();
                    navigateToPage('profile-content');
                    setActiveNavItem(document.getElementById('nav-profile'));
                });

                const comingSoonItems = ['sidebar-stream-stats', 'sidebar-leaderboard', 'sidebar-my-channel', 'sidebar-monetize'];
                comingSoonItems.forEach(id => {
                    document.getElementById(id)?.addEventListener('click', (e) => {
                        e.preventDefault();
                        closeSidebar();
                        navigateToPage('coming-soon-content');
                        setActiveNavItem(null);
                    });
                });
                
                document.getElementById('sidebar-contact-btn').addEventListener('click', () => {
                    const adminTelegramId = 'Blackmoney54';
                    showCustomModal({
                        title: 'Admin Support',
                        message: `
                            <div class="text-left text-gray-300">
                                <p>            </p>
                                <div class="bg-black/30 p-3 my-3 rounded-lg flex justify-between items-center">
                                    <code id="admin-tg-id" class="text-lg font-bold tracking-wider text-green-400">${adminTelegramId}</code>
                                    <button id="copy-admin-tg-btn" class="bg-gray-600 hover:bg-gray-700 w-10 h-10 rounded-md flex items-center justify-center transition-colors"><i class="fa-solid fa-copy"></i></button>
                                </div>
                            </div>`,
                        primaryButton: { text: 'Close' },
                        onRender: (modal) => {
                            modal.querySelector('#copy-admin-tg-btn').addEventListener('click', () => {
                                navigator.clipboard.writeText(adminTelegramId).then(() => {
                                    showModal('success', 'Copied!', `Admin's Telegram ID has been copied.`);
                                });
                            });
                        }
                    });
                });

                document.getElementById('sidebar-store').addEventListener('click', () => {
                     closeSidebar();
                     navigateToPage('home-content');
                     setTimeout(() => {
                        document.querySelector('.home-tab-link[data-target="home-store-feed"]').click();
                     }, 100);
                });
                
                document.getElementById('sidebar-history').addEventListener('click', () => {
                    closeSidebar();
                    navigateToPage('history-content');
                    setActiveNavItem(null);
                });

                document.getElementById('sidebar-redeem').addEventListener('click', () => {
                    closeSidebar();
                    navigateToPage('redeem-content');
                    setActiveNavItem(null);
                });

                document.getElementById('sidebar-coupons').addEventListener('click', () => {
                    closeSidebar();
                    navigateToPage('my-coupons-content');
                    setActiveNavItem(null);
                });
                 document.getElementById('sidebar-partner').addEventListener('click', () => {
                    closeSidebar();
                    screens.partner.classList.remove('hidden');
                    renderPartnerScreen();
                });
            }

            function renderMyCouponsPage() {
                const container = document.getElementById('my-coupons-content');
                const coupons = Object.values(currentUserData.myCoupons || {});
                const now = Date.now();
                const threeDaysAgo = now - (3 * 24 * 60 * 60 * 1000);

                giftCardTimers.forEach(clearInterval);
                giftCardTimers = [];

                const visibleCoupons = coupons.filter(c => {
                    if (c.scratched) { return new Date(c.scratchedAt).getTime() > threeDaysAgo; }
                    return true;
                });
                
                if (visibleCoupons.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-400 mt-8">You have no gift cards yet. Complete missions to earn them!</p>`;
                    return;
                }
                
                const cardImages = {
                    'Daily Reward': 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F9c96c050d71780c9117555ebdc2c5471.jpg?alt=media&token=0dc9f743-826d-449e-a13f-060086a4f84f',
                    'Sign-up Bonus': 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F9c96c050d71780c9117555ebdc2c5471.jpg?alt=media&token=0dc9f743-826d-449e-a13f-060086a4f84f',
                    'Referral Bonus': 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F9c96c050d71780c9117555ebdc2c5471.jpg?alt=media&token=0dc9f743-826d-449e-a13f-060086a4f84f',
                    'Match Reward': 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2FAddText_11-10-09.22.31.png?alt=media&token=f9ae0a65-1ef3-49cb-8b95-bf30854a4554'
                };
                
                const couponsHTML = visibleCoupons.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map((coupon, index) => {
                    let cardImage;
                    const expiresAt = new Date(coupon.expiresAt).getTime();
                    const isExpired = expiresAt < now;
                    let cardClass = '';
                    let footerHTML = '';

                    if (coupon.scratched) {
                        cardClass = 'gift-card-claimed';
                        footerHTML = ``;
                        if (coupon.reward && coupon.reward.type !== 'bad_luck' && coupon.reward.image) {
                            cardImage = coupon.reward.image;
                        } else {
                            cardImage = coupon.storeCardId 
                                ? window.dbData.admin?.store?.giftCards?.[coupon.storeCardId]?.image || cardImages['Daily Reward']
                                : cardImages[coupon.reason] || cardImages['Daily Reward'];
                        }
                    } else {
                        cardImage = coupon.storeCardId 
                            ? window.dbData.admin?.store?.giftCards?.[coupon.storeCardId]?.image || cardImages['Daily Reward']
                            : cardImages[coupon.reason] || cardImages['Daily Reward'];
                        
                        if (isExpired) {
                            cardClass = 'opacity-50 cursor-default';
                            footerHTML = `<div class="card-footer" style="background: #ef4444; color: white;">Expired</div>`;
                        } else {
                            footerHTML = `<div class="card-footer" data-countdown-id="${coupon.id}" data-expires-at="${coupon.expiresAt}">Calculating...</div>`;
                        }
                    }
                    
                    return `<div class="gift-card-preview" style="background-image: url('${cardImage}');" data-coupon-id="${coupon.id}">
                                <div class="${cardClass}"></div>
                                ${footerHTML}
                            </div>`;
                }).join('');
                
                container.innerHTML = `<div class="gift-card-grid">${couponsHTML}</div>`;

                container.querySelectorAll('[data-countdown-id]').forEach(footer => {
                    const expiresAt = new Date(footer.dataset.expiresAt).getTime();
                    
                    const updateTimer = () => {
                        const timeLeft = expiresAt - Date.now();
                        if (timeLeft <= 0) {
                            footer.textContent = 'Expired';
                            footer.style.backgroundColor = '#ef4444';
                            footer.closest('.gift-card-preview').querySelector('div:first-child').classList.add('opacity-50', 'cursor-default');
                            clearInterval(timer);
                            return;
                        }
                        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                        footer.textContent = `Expires in: ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    };
                    
                    updateTimer();
                    const timer = setInterval(updateTimer, 1000);
                    giftCardTimers.push(timer);
                });


                container.querySelectorAll('.gift-card-preview').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (card.querySelector('.gift-card-claimed') || card.querySelector('.opacity-50')) return;
                        const couponId = card.dataset.couponId;
                        const coupon = currentUserData.myCoupons[couponId];
                        if (coupon) {
                            showGiftCardOpenModal(coupon);
                        }
                    });
                });
            }

            // Home Header Search Listeners
            document.getElementById('home-search-btn').addEventListener('click', () => {
                document.getElementById('main-header').classList.add('hidden');
                document.getElementById('home-search-header').classList.remove('hidden');
                document.getElementById('home-search-input').focus();
            });
            document.getElementById('back-from-home-search-btn').addEventListener('click', () => {
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('home-search-header').classList.add('hidden');
                document.getElementById('home-search-input').value = '';
                handleHomeSearch();
            });
            document.getElementById('home-search-input').addEventListener('input', handleHomeSearch);

            function updateSidebarBadges(userData) {
                const unreadCoupons = Object.values(userData.myCoupons || {}).filter(c => !c.scratched && new Date(c.expiresAt).getTime() > Date.now()).length;
                const couponBadge = document.getElementById('sidebar-coupons-badge');
                if (unreadCoupons > 0) {
                    couponBadge.textContent = unreadCoupons;
                    couponBadge.classList.remove('hidden');
                } else {
                    couponBadge.classList.add('hidden');
                }
            }
            
            async function handleDailyRewardClaim() {
                const btn = document.getElementById('claim-scratch-card-btn');
                if(btn.disabled) return;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner"></span> Claiming...`;
                try {
                    await giveScratchCard(auth.currentUser.uid, { reason: 'Daily Reward' });
                    await database.ref(`users/${auth.currentUser.uid}/lastScratchClaim`).set(Date.now());
                    showModal('success', 'Reward Claimed!', 'A new Gift Card has been added to your collection.', 'OK', () => {
                        navigateToPage('my-coupons-content');
                    });
                } catch(err) {
                    handleFirebaseError(err);
                    btn.disabled = false;
                    btn.innerHTML = 'Claim Daily Reward';
                }
            }

            function updateDailyRewardUI(userData) {
                const lastClaim = userData.lastScratchClaim || 0;
                const now = Date.now();
                const twentyFourHours = 24 * 60 * 60 * 1000;
                const timeSinceLastClaim = now - lastClaim;

                const btn = document.getElementById('claim-scratch-card-btn');
                const timerEl = document.getElementById('claim-cooldown-timer');
                if(!btn || !timerEl) return;
                
                let dailyRewardInterval = null;
                clearInterval(dailyRewardInterval);

                if (timeSinceLastClaim >= twentyFourHours) {
                    btn.disabled = false;
                    btn.innerHTML = 'Claim Daily Reward';
                    timerEl.classList.add('hidden');
                } else {
                    btn.disabled = true;
                    btn.innerHTML = 'Claimed Today';
                    timerEl.classList.remove('hidden');
                    
                    const updateTimer = () => {
                        const timeLeft = twentyFourHours - (Date.now() - lastClaim);
                        if (timeLeft <= 0) {
                            clearInterval(dailyRewardInterval);
                            renderMissionsPage(); 
                            return;
                        }
                        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                        timerEl.textContent = `Next claim in: ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                    };
                    
                    updateTimer();
                    dailyRewardInterval = setInterval(updateTimer, 1000);
                }
            }

            async function renderStorePage(){
                const container = document.getElementById('home-store-feed');
                const giftCardItems = window.dbData.admin?.store?.giftCards || {};
                const topupItems = window.dbData.admin?.store?.topups || {};

                const topupDiamondsHTML = Object.entries(topupItems).filter(([id, item]) => item.type === 'diamond').map(([id, item]) => createTopupCardHTML(id, item)).join('');
                const giftCardsHTML = Object.entries(giftCardItems).map(([id, card]) => createGiftCardStoreHTML(id, card)).join('');

                container.innerHTML = `<div class="space-y-6">
                    <div><h3 class="section-header">TOP-UP DIAMONDS</h3><div class="horizontal-scroll-container no-scrollbar">${topupDiamondsHTML || '<p class="text-gray-500 w-full text-center">No diamond top-ups available.</p>'}</div></div>
                    <div><h3 class="section-header">GIFT CARDS</h3><div class="horizontal-scroll-container no-scrollbar">${giftCardsHTML || '<p class="text-gray-500 w-full text-center">No gift cards available.</p>'}</div></div>
                </div>`;

                container.querySelectorAll('.buy-store-card-btn').forEach(btn => btn.addEventListener('click', () => handleGiftCardPurchase(btn.dataset.cardId, btn)));
                container.querySelectorAll('.buy-topup-btn').forEach(btn => btn.addEventListener('click', () => handleTopupPurchase(btn.dataset.topupId, btn)));
            }

            function createGiftCardStoreHTML(id, card) {
                 const userCoins = currentUserData.wallet?.coins || 0;
                 const isStockOut = card.stock <= 0;
                 const canAfford = userCoins >= card.price;
                 return `
                    <div class="store-item-h">
                        <img src="${card.image}" class="store-item-h-image" alt="${card.name}">
                        ${isStockOut ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><span class="font-bold text-red-500">Stock Out</span></div>` : ''}
                        <div class="store-item-h-content">
                            <button class="store-item-h-button action-button buy-store-card-btn" data-card-id="${id}" ${isStockOut || !canAfford ? 'disabled' : ''}>
                                <i class="fa-solid fa-coins"></i><span>${formatNumberCompact(card.price)}</span>
                            </button>
                        </div>
                    </div>`;
            }

            function createTopupCardHTML(id, item) {
                const userCoins = currentUserData.wallet?.coins || 0;
                const isStockOut = item.stockOut === true;
                const canAfford = userCoins >= item.price;
                const icon = item.type === 'diamond' ? 'fa-gem text-cyan-400' : 'fa-coins text-yellow-400';

                return `
                <div class="store-item-h">
                    <img src="${item.image}" class="store-item-h-image" alt="${item.amount} ${item.type}">
                    ${isStockOut ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><span class="font-bold text-red-500">Stock Out</span></div>` : ''}
                    <div class="store-item-h-content">
                        <h4 class="store-item-h-title"><i class="fa-solid ${icon} mr-1"></i>${item.amount} ${item.type === 'diamond' ? 'Diamonds' : 'Coins'}</h4>
                        <button class="store-item-h-button action-button buy-topup-btn" data-topup-id="${id}" ${isStockOut || !canAfford ? 'disabled' : ''}>
                           <i class="fa-solid fa-coins"></i><span>${formatNumberCompact(item.price)}</span>
                        </button>
                    </div>
                </div>`;
            }

            function handleGiftCardPurchase(cardId, btn) {
                const card = window.dbData.admin?.store?.giftCards?.[cardId];
                if (!card || btn.disabled) return;
                
                showCustomModal({
                    title: 'Confirm Purchase',
                    message: `
                        <div class="text-center p-4">
                            <img src="${card.image}" class="w-48 h-auto object-cover rounded-xl mx-auto mb-4 border-2 border-gray-600">
                            <p class="text-gray-300 text-base">Are you sure you want to buy this gift card for <span class="font-bold text-yellow-400">${card.price} Coins</span>?</p>
                        </div>`,
                    primaryButton: {
                        text: 'Confirm & Buy',
                        onClick: async () => {
                            btn.disabled = true;
                            showLoader('Purchasing...');
                            try {
                                const result = await database.ref().transaction(data => {
                                    if (data && data.users[auth.currentUser.uid] && data.admin.store.giftCards[cardId].stock > 0 && data.users[auth.currentUser.uid].wallet.coins >= card.price) {
                                        data.admin.store.giftCards[cardId].stock--;
                                        data.users[auth.currentUser.uid].wallet.coins -= card.price;
                                        if (!data.users[auth.currentUser.uid].storePurchaseCounters) {
                                            data.users[auth.currentUser.uid].storePurchaseCounters = {};
                                        }
                                        data.users[auth.currentUser.uid].storePurchaseCounters[cardId] = (data.users[auth.currentUser.uid].storePurchaseCounters[cardId] || 0) + 1;
                                        return data;
                                    }
                                    return; // Abort
                                });

                                if (result.committed) {
                                    await giveScratchCard(auth.currentUser.uid, { reason: 'Store Purchase', storeCardId: cardId });
                                    hideLoader();
                                    showModal('success', 'Purchase Successful!', `A new gift card has been added to your collection.`, 'OK', () => { navigateToPage('my-coupons-content'); });
                                } else {
                                    throw new Error('Transaction aborted. Item might be out of stock or you may not have enough coins.');
                                }
                            } catch (error) {
                                hideLoader();
                                handleFirebaseError(error);
                                btn.disabled = false;
                            }
                        }
                    },
                    secondaryButton: { text: 'Cancel' }
                });
            }

            async function deletePostAsAdmin(postTypeRef, postId, reason) {
                 const postRef = database.ref(`/${postTypeRef}/${postId}`);
                 const postSnapshot = await postRef.once('value');
                 const post = postSnapshot.val();
                 if (post) {
                     await postRef.remove();
                     const postTitle = post.details?.eventName || post.guildName || 'Player/Squad Post';
                     await sendMailToUser(post.creatorId, 'Your Post Was Removed', { reason: reason || 'Violation of community guidelines.', postTitle: postTitle });
                 }
            }
            
            async function showGiftCardOpenModal(coupon) {
                const modal = screens.giftCardOpen;
                let cardImage;
                if(coupon.storeCardId) {
                    cardImage = window.dbData.admin?.store?.giftCards?.[coupon.storeCardId]?.image || 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F9c96c050d71780c9117555ebdc2c5471.jpg?alt=media&token=0dc9f743-826d-449e-a13f-060086a4f84f';
                } else {
                    cardImage = 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F9c96c050d71780c9117555ebdc2c5471.jpg?alt=media&token=0dc9f743-826d-449e-a13f-060086a4f84f';
                }
                
                modal.innerHTML = `
                    <div class="modal-box">
                        <button class="close-card-modal-btn">&times;</button>
                        <div class="gift-card-open-modal-content">
                            <div class="gift-card-flipper">
                                <div class="gift-card-face card-front" style="background-image: url('${cardImage}');"></div>
                                <div class="gift-card-face card-back"></div>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button class="open-card-btn">OPEN</button>
                        </div>
                    </div>`;
                modal.classList.remove('hidden');

                const closeModal = () => {
                    modal.classList.add('hidden');
                    modal.innerHTML = '';
                };

                modal.querySelector('.close-card-modal-btn').addEventListener('click', closeModal);
                
                modal.querySelector('.open-card-btn').addEventListener('click', async (e) => {
                    if (e.currentTarget.disabled) return;
                    
                    if (coupon.reason === 'Daily Reward') {
                        handleAdGatedCardOpen(coupon, modal);
                    } else {
                        handleStandardCardOpen(coupon, modal);
                    }
                }, { once: true });
            }

            async function handleStandardCardOpen(coupon, modal) {
                const openBtn = modal.querySelector('.open-card-btn');
                openBtn.disabled = true;
                openBtn.style.opacity = '0';
                openBtn.style.pointerEvents = 'none';

                let reward = coupon.reward;
                if (!reward) {
                    reward = generateReward(coupon);
                    await database.ref(`users/${auth.currentUser.uid}/myCoupons/${coupon.id}/reward`).set(reward);
                    currentUserData.myCoupons[coupon.id].reward = reward;
                }

                if (reward.image) preloadImages([reward.image]);

                const flipper = modal.querySelector('.gift-card-flipper');
                flipper.classList.add('is-flipped');

                setTimeout(async () => {
                    await revealPrize(modal, reward);
                    if (!coupon.scratched) {
                        await finalizeReward(coupon.id, reward);
                    }
                    setTimeout(() => modal.classList.add('hidden'), reward.type === 'bad_luck' ? 2000 : 3000);
                }, 400); // Halfway through the flip
            }

            async function handleAdGatedCardOpen(coupon, giftCardModal) {
                const openBtn = giftCardModal.querySelector('.open-card-btn');
                openBtn.disabled = true;
                openBtn.innerHTML = '<span class="spinner"></span>';

                const adUrl = window.dbData.admin?.settings?.dailyRewardAdUrl || 'https://otieu.com/4/9010052';
                
                const adScreen = screens.adView;
                adScreen.innerHTML = `
                    <header class="w-full p-4 bg-[#1e1e1e] flex justify-between items-center z-10">
                        <h2 class="font-bold text-white">Claiming Reward...</h2>
                        <div class="flex items-center gap-2 text-white font-bold">
                            <i class="fa-solid fa-clock"></i>
                            <span id="ad-countdown-timer">15</span>s
                        </div>
                    </header>
                    <iframe src="${adUrl}" class="w-full flex-grow border-0"></iframe>
                `;
                adScreen.classList.remove('hidden');

                let countdown = 15;
                const timerEl = document.getElementById('ad-countdown-timer');
                
                const intervalId = setInterval(async () => {
                    countdown--;
                    if (timerEl) timerEl.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(intervalId);
                        adScreen.classList.add('hidden');
                        
                        let reward = coupon.reward;
                        if (!reward) {
                            reward = generateReward(coupon);
                            await database.ref(`users/${auth.currentUser.uid}/myCoupons/${coupon.id}/reward`).set(reward);
                             currentUserData.myCoupons[coupon.id].reward = reward;
                        }

                        const flipper = giftCardModal.querySelector('.gift-card-flipper');
                        flipper.classList.add('is-flipped');
                        
                        setTimeout(async () => {
                            await revealPrize(giftCardModal, reward);
                            if (!coupon.scratched) {
                               await finalizeReward(coupon.id, reward);
                            }
                            setTimeout(() => giftCardModal.classList.add('hidden'), reward.type === 'bad_luck' ? 2000 : 3000);
                        }, 400);
                    }
                }, 1000);

                document.addEventListener("visibilitychange", function onVisible() {
                    if (document.visibilityState === 'hidden' && countdown > 0) {
                        clearInterval(intervalId);
                        adScreen.classList.add('hidden');
                        giftCardModal.classList.add('hidden');
                        showModal('error', 'Task Incomplete', 'You must stay on the page to claim the reward. Please try again.');
                        document.removeEventListener("visibilitychange", onVisible);
                    } else if (countdown <= 0) {
                        document.removeEventListener("visibilitychange", onVisible);
                    }
                });
            }

            async function revealPrize(modal, reward) {
                const cardBack = modal.querySelector('.card-back');
                if (reward.type === 'bad_luck') {
                    cardBack.style.backgroundImage = 'radial-gradient(circle, #374151, #1f2937)';
                    cardBack.innerHTML = `<i class="bad-luck-icon fa-solid fa-face-frown"></i>
                                          <p class="bad-luck-text">Better Luck Next Time!</p>`;
                } else {
                    cardBack.style.backgroundImage = `url('${reward.image || "https://i.imgur.com/8x8eFqg.jpg"}')`;
                    cardBack.innerHTML = ''; 
                }
                
                const rect = cardBack.getBoundingClientRect();
                const origin = { x: (rect.left + rect.width / 2) / window.innerWidth, y: (rect.top + rect.height / 2) / window.innerHeight };
                if (reward.type !== 'bad_luck') {
                    confetti({ particleCount: 150, spread: 100, origin: origin, zIndex: 1003 });
                }
            }

            async function finalizeReward(couponId, reward) {
                if (reward.type !== 'bad_luck') {
                    await addTransaction(auth.currentUser.uid, { type: 'Gift Card Reward', description: `From Gift Card`, amount: reward.value, currency: reward.type });
                    if (reward.type === 'coin') { await database.ref(`users/${auth.currentUser.uid}/wallet/coins`).transaction(current => (current || 0) + reward.value); } 
                    else if (reward.type === 'diamond') { await database.ref(`users/${auth.currentUser.uid}/wallet/diamonds`).transaction(current => (current || 0) + reward.value); }
                }
                await database.ref(`users/${auth.currentUser.uid}/myCoupons/${couponId}`).update({ scratched: true, scratchedAt: new Date().toISOString() });
            }


            function handleTopupPurchase(topupId, btn) {
                 const item = window.dbData.admin?.store?.topups?.[topupId];
                 if (!item || btn.disabled) return;
                
                 showCustomModal({
                    title: 'Confirm Purchase',
                    message: `
                        <div class="text-center p-4">
                            <img src="${item.image}" class="w-48 h-auto object-cover rounded-xl mx-auto mb-4 border-2 border-gray-600">
                            <p class="text-gray-300 text-base">Are you sure you want to buy <span class="font-bold text-white">${item.amount} Diamonds</span> for <span class="font-bold text-yellow-400">${item.price} Coins</span>?</p>
                        </div>`,
                    primaryButton: { 
                        text: 'Confirm & Buy', 
                        onClick: () => {
                           showTopupPurchaseModal(item, topupId, btn);
                        }
                    },
                    secondaryButton: { text: 'Cancel' }
                 });
            }

            function generateRedeemCode(amount) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 7; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return `LEVELUP-DIAMOND${amount}-${result}`;
            }

            async function submitTopupPurchase(item, topupId, btn) {
                const redeemCode = generateRedeemCode(item.amount);
                
                const updates = {};
                updates[`/users/${auth.currentUser.uid}/wallet/coins`] = firebase.database.ServerValue.increment(-item.price);
                updates[`/redeemCodes/${redeemCode}`] = {
                    itemId: topupId,
                    amount: item.amount,
                    type: item.type,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    ownerId: auth.currentUser.uid,
                    used: false
                };

                const userTransactionRef = database.ref(`users/${auth.currentUser.uid}/transactions`).push();
                updates[`/users/${auth.currentUser.uid}/transactions/${userTransactionRef.key}`] = {
                    id: userTransactionRef.key,
                    type: 'Top-up Purchase',
                    description: `Bought ${item.amount} Diamonds`,
                    amount: -item.price,
                    currency: 'coin',
                    redeemCode: redeemCode,
                    status: 'completed',
                    timestamp: new Date().toISOString()
                };

                try {
                    await database.ref().update(updates);
                    return redeemCode;
                } catch (error) {
                    // Rollback coin deduction if update fails
                    await database.ref(`users/${auth.currentUser.uid}/wallet/coins`).transaction(current => (current || 0) + item.price);
                    handleFirebaseError(error);
                    btn.disabled = false;
                    return null;
                }
            }
            
            async function showTopupPurchaseModal(item, topupId, btn) {
                const modal = screens.topupPurchase;
                btn.disabled = true;

                modal.innerHTML = `
                <div class="modal-box relative">
                     <button id="close-topup-modal-btn" class="absolute top-2 right-3 text-gray-400 hover:text-white text-3xl z-20">&times;</button>
                     <div class="topup-card-flipper">
                        <div class="topup-card-face" style="background-image: url('${item.image}');"></div>
                        <div class="topup-card-face topup-card-back">
                            <!-- Content revealed after flip -->
                        </div>
                    </div>
                    <div id="topup-modal-footer" class="text-center mt-6 opacity-0 transition-opacity duration-500">
                         <button id="copy-redeem-code-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-sm flex items-center justify-center gap-2 transition-all duration-200">
                            <i class="fa-solid fa-copy"></i> Copy Code
                        </button>
                    </div>
                </div>`;
                modal.classList.remove('hidden');

                const flipper = modal.querySelector('.topup-card-flipper');
                const cardBack = modal.querySelector('.topup-card-back');
                const footer = document.getElementById('topup-modal-footer');
                
                const redeemCode = await submitTopupPurchase(item, topupId, btn);
                if (!redeemCode) {
                    modal.classList.add('hidden');
                    return;
                }

                setTimeout(() => {
                    flipper.classList.add('is-flipped');
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 1003 });
                }, 100);

                setTimeout(() => {
                    cardBack.innerHTML = `
                        <i class="fa-solid fa-gem text-5xl text-cyan-400 mb-2"></i>
                        <h3 class="font-bold text-2xl text-green-400">Purchase Successful!</h3>
                        <p class="text-sm text-gray-400 mt-1 mb-4">Your Redeem Code is ready.</p>
                        <div class="redeem-code-wrapper scan-overlay">
                            <p id="redeem-code-display" class="redeem-code-text text-center">${redeemCode}</p>
                        </div>
                    `;
                    footer.classList.remove('opacity-0');
                }, 1000); // Wait for flip to be halfway

                const copyBtn = document.getElementById('copy-redeem-code-btn');
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(redeemCode).then(() => {
                        copyBtn.innerHTML = `<i class="fa-solid fa-check"></i> Code Copied!`;
                        copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        copyBtn.classList.add('bg-blue-600');
                        setTimeout(() => {
                            copyBtn.innerHTML = `<i class="fa-solid fa-copy"></i> Copy Code`;
                            copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                            copyBtn.classList.remove('bg-blue-600');
                        }, 2000);
                    });
                });
                
                document.getElementById('close-topup-modal-btn').addEventListener('click', () => {
                     modal.classList.add('hidden');
                });
            }
            
            function renderRedeemPage() {
                const container = document.getElementById('redeem-content');
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-[#2a2a2a] to-[#1e1e1e] border border-gray-700 rounded-2xl p-6 text-center max-w-sm mx-auto shadow-2xl">
                        <i class="fa-solid fa-gift text-6xl text-green-400 mb-4"></i>
                        <h3 class="text-2xl font-bold font-oswald text-green-300 mb-2">REDEEM CODE</h3>
                        <p class="text-gray-400 mb-6 text-sm">Enter the code from your top-up purchase to claim your diamonds.</p>
                        <form id="redeem-form" class="space-y-4">
                            <input type="text" id="redeem-code-input" class="form-input text-center tracking-widest font-mono uppercase bg-black/30 border-gray-600 focus:border-green-500" placeholder="LEVELUP-DIAMOND..." required>
                            <button type="submit" class="w-full py-3 action-button rounded-lg font-bold">REDEEM NOW</button>
                        </form>
                    </div>
                `;
                document.getElementById('redeem-form').addEventListener('submit', handleRedeemCode);
            }

            async function handleRedeemCode(e) {
                e.preventDefault();
                const form = e.target;
                const code = document.getElementById('redeem-code-input').value.trim().toUpperCase();

                handleFormSubmit(form, 'Redeeming...', async () => {
                    const codeRef = database.ref(`redeemCodes/${code}`);
                    const result = await codeRef.transaction(codeData => {
                        if (codeData && codeData.ownerId === auth.currentUser.uid && !codeData.used) {
                            codeData.used = true;
                            codeData.usedAt = firebase.database.ServerValue.TIMESTAMP;
                            return codeData;
                        }
                        return; // Abort
                    });

                    if (result.committed) {
                        const redeemedData = result.snapshot.val();
                        await database.ref(`users/${auth.currentUser.uid}/wallet/diamonds`).transaction(current => (current || 0) + redeemedData.amount);
                        
                        await addTransaction(auth.currentUser.uid, {
                            type: 'Redeem Code',
                            description: `Redeemed ${redeemedData.amount} Diamonds`,
                            amount: redeemedData.amount,
                            currency: 'diamond'
                        });
                        
                        showCustomModal({
                            type: 'success',
                            title: 'Success!',
                            message: `You have successfully redeemed ${redeemedData.amount} Diamonds!`,
                            iconHtml: `<dotlottie-wc src="https://lottie.host/808b26f5-072f-4c59-b17b-232d665a3962/qYI7k2RGvS.lottie" autoplay style="width: 150px; height: 150px;"></dotlottie-wc>`,
                            primaryButton: {text: 'Awesome!'},
                            autoClose: 3000
                        });
                        form.reset();

                    } else {
                        const snapshot = await codeRef.once('value');
                        const data = snapshot.val();
                        if (!data) throw new Error('Invalid code. Please check and try again.');
                        if (data.ownerId !== auth.currentUser.uid) throw new Error('This code does not belong to you.');
                        if (data.used) throw new Error('This code has already been used.');
                        throw new Error('An unknown error occurred. Please try again.');
                    }
                });
            }

            async function renderHistoryPage() {
                 const contentArea = document.getElementById('history-content');
                 let transactions = [];

                 const depositsSnapshot = await database.ref('deposits').orderByChild('userId').equalTo(auth.currentUser.uid).once('value');
                 Object.values(depositsSnapshot.val() || {}).forEach(t => transactions.push({ ...t, txType: 'Deposit', sortTimestamp: t.timestamp }));

                 const withdrawalsSnapshot = await database.ref('withdrawals').orderByChild('userId').equalTo(auth.currentUser.uid).once('value');
                 Object.values(withdrawalsSnapshot.val() || {}).forEach(t => transactions.push({ ...t, txType: 'Withdrawal', sortTimestamp: t.timestamp }));

                 const userTransactionsSnapshot = await database.ref(`users/${auth.currentUser.uid}/transactions`).once('value');
                 Object.values(userTransactionsSnapshot.val() || {}).forEach(t => transactions.push({ ...t, txType: 'General', sortTimestamp: t.timestamp }));
                
                 transactions.sort((a, b) => new Date(b.sortTimestamp) - new Date(a.sortTimestamp));

                 const transactionsHTML = transactions.map(t => {
                     let amountHTML, description, title, status;
                     status = t.status || 'completed';

                     switch(t.txType) {
                         case 'Deposit':
                             title = `Deposit via ${t.method}`;
                             description = `TrxID: ${t.trxId || 'N/A'}`;
                             amountHTML = `<p class="font-bold text-lg text-green-400">+${t.amount.toFixed(2)} TK</p>`;
                             break;
                         case 'Withdrawal':
                             title = `Withdrawal to ${t.method}`;
                             description = `Acc: ${t.accountNumber}`;
                             amountHTML = `<p class="font-bold text-lg text-red-400">${-t.amount.toFixed(2)} TK</p>`;
                             break;
                         case 'General':
                             title = t.type;
                             description = t.redeemCode ? `Code: ${t.redeemCode}` : t.description;
                             if (t.currency) {
                                 const icon = t.currency === 'coin' ? 'fa-coins text-yellow-400' : 'fa-gem text-cyan-400';
                                 const isCredit = !String(t.amount).startsWith('-');
                                 amountHTML = `<p class="font-bold text-lg ${isCredit ? '' : 'text-red-400'}"><i class="fa-solid ${icon} mr-1"></i>${t.amount}</p>`;
                             } else {
                                const isCredit = t.amount > 0;
                                amountHTML = `<p class="font-bold text-lg ${isCredit ? 'text-green-400' : 'text-red-400'}">${isCredit ? '+' : ''}${t.amount.toFixed(2)} TK</p>`;
                             }
                             break;
                     }
                     
                     const statusColors = { pending: 'bg-yellow-500', approved: 'bg-green-500', completed: 'bg-green-500', rejected: 'bg-red-500' };
                     const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                     const statusBadge = `<span class="text-xs font-semibold px-2 py-1 ${statusColors[status]} text-white rounded-full ml-2">${statusText}</span>`;

                     return `<div class="flex justify-between items-center p-3 bg-[#2a2a2a] rounded-lg">
                                <div>
                                    <p class="font-semibold text-sm flex items-center">${title}${statusBadge}</p>
                                    <p class="text-xs text-gray-400">${description}</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(t.timestamp).toLocaleString()}</p>
                                </div>
                                ${amountHTML}
                            </div>`;
                 }).join('');

                 contentArea.innerHTML = `<div class="space-y-2">${transactions.length > 0 ? transactionsHTML : '<p class="text-center text-gray-500 p-4">No transactions found.</p>'}</div>`;
            }
            
            // --- NEW MISSIONS/TASKS LOGIC ---
            function renderMissionsPage() {
                const container = document.getElementById('home-missions-feed');
                const tasks = window.dbData.admin?.missions || {};
                
                if (Object.keys(tasks).length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 p-10 bg-gray-800/50 rounded-lg"><i class="fa-solid fa-list-check text-4xl mb-4"></i><p>No missions available right now.</p></div>`;
                    return;
                }

                let tasksHTML = '';
                const bannerAdHTML = `
                    <div class="my-4 flex justify-center">
                        <script type="text/javascript">
                            atOptions = {
                                'key' : 'e47c31db450a47318457030182d72c9b',
                                'format' : 'iframe',
                                'height' : 60,
                                'width' : 468,
                                'params' : {}
                            };
                        <\/script>
                        <script type="text/javascript" src="//www.highperformanceformat.com/e47c31db450a47318457030182d72c9b/invoke.js"><\/script>
                    </div>`;

                Object.entries(tasks).forEach(([taskId, task], index) => {
                    tasksHTML += createTaskCardHTML(taskId, task);
                    if ((index + 1) % 3 === 0 && index < Object.keys(tasks).length -1) {
                        tasksHTML += bannerAdHTML;
                    }
                });
                
                container.innerHTML = tasksHTML;

                container.querySelectorAll('.task-action-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        const task = tasks[taskId];
                        if (task.type === 'watchAd') {
                            handleWatchAdTask(taskId, task);
                        } else if (task.type === 'redeem') {
                            renderRedeemTaskPage(taskId, task);
                        }
                    });
                });
            }

            function createTaskCardHTML(taskId, task) {
                const userProgress = currentUserData.missionProgress?.[taskId] || { count: 0, lastCompletedDate: '' };
                const todayBst = getBangladeshDateString();
                const isCompletedToday = userProgress.lastCompletedDate === todayBst && userProgress.count >= (task.limit || 1);

                let iconHtml = '<i class="fa-solid fa-question"></i>';
                if (task.icon) {
                    iconHtml = `<i class="fa-solid ${task.icon}"></i>`;
                }

                const rewardCurrencyIcon = task.rewardType === 'diamond' 
                    ? 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763297995.png?alt=media&token=db9ebed1-ff51-49ed-a311-0327313dae56' 
                    : 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763055321.png?alt=media&token=58051d4b-446d-4a30-b588-bed5a5f49c8d';
                
                const buttonText = task.type === 'redeem' ? 'View' : 'Watch';
                
                let currentCount = userProgress.lastCompletedDate === todayBst ? userProgress.count : 0;
                
                return `
                    <div class="task-card">
                        <div class="task-icon-container">
                            ${iconHtml}
                            ${task.limit ? `<span class="task-progress">${currentCount}/${task.limit}</span>` : ''}
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-bold text-white">${task.title}</h4>
                            <div class="task-reward mt-1">
                                Win <img src="${rewardCurrencyIcon}" alt="${task.rewardType}">
                                <span>${task.rewardAmount}</span>
                            </div>
                        </div>
                        <button class="task-action-btn" data-task-id="${taskId}" ${isCompletedToday ? 'disabled' : ''}>
                           ${isCompletedToday ? 'Completed' : buttonText}
                        </button>
                    </div>
                `;
            }

            function handleWatchAdTask(taskId, task) {
                const adScreen = screens.adView;
                const totalDuration = task.duration || 30;
                const showTimerAt = 20;

                let countdown = totalDuration;
                
                adScreen.innerHTML = `
                    <header class="w-full p-4 bg-gray-900 flex justify-between items-center z-10 opacity-0 transition-opacity duration-500" id="ad-header">
                        <h2 class="font-bold text-white">${task.title}</h2>
                        <div class="flex items-center gap-2 text-white font-bold bg-black/50 px-3 py-1 rounded-full">
                            <div class="w-4 h-4 border-2 border-white rounded-full animate-spin border-t-transparent"></div>
                            <span id="ad-countdown-timer">${countdown}</span>s
                        </div>
                    </header>
                    <iframe src="${task.url}" class="w-full flex-grow border-0"></iframe>
                `;
                adScreen.classList.remove('hidden');

                const adHeader = document.getElementById('ad-header');
                const timerEl = document.getElementById('ad-countdown-timer');
                
                const intervalId = setInterval(async () => {
                    countdown--;
                    if (timerEl) timerEl.textContent = countdown;
                    
                    if (countdown <= showTimerAt) {
                        adHeader.classList.remove('opacity-0');
                    }

                    if (countdown <= 0) {
                        clearInterval(intervalId);
                        adScreen.classList.add('hidden');
                        
                        const userProgressRef = database.ref(`users/${auth.currentUser.uid}/missionProgress/${taskId}`);
                        await userProgressRef.transaction(progress => {
                            progress = progress || { count: 0, lastCompletedDate: '' };
                            const todayBst = getBangladeshDateString();
                            
                            if (progress.lastCompletedDate !== todayBst) {
                                progress.count = 0;
                            }
                            
                            progress.count++;
                            progress.lastCompletedDate = todayBst;
                            return progress;
                        });

                        const currency = task.rewardType === 'diamond' ? 'diamonds' : 'coins';
                        await database.ref(`users/${auth.currentUser.uid}/wallet/${currency}`).transaction(current => (current || 0) + task.rewardAmount);
                        await addTransaction(auth.currentUser.uid, {
                            type: 'Mission Reward',
                            description: `Completed: ${task.title}`,
                            amount: task.rewardAmount,
                            currency: task.rewardType
                        });

                        showModal('success', 'Task Completed!', `You earned ${task.rewardAmount} ${task.rewardType}s.`);
                    }
                }, 1000);

                document.addEventListener("visibilitychange", function onVisible() {
                    if (document.visibilityState === 'hidden' && countdown > 0) {
                        clearInterval(intervalId);
                        adScreen.classList.add('hidden');
                        showModal('error', 'Task Incomplete', 'You must stay on the page to complete the task. Please try again.');
                        document.removeEventListener("visibilitychange", onVisible);
                    } else if (countdown <= 0) {
                        document.removeEventListener("visibilitychange", onVisible);
                    }
                }, { once: true });
            }

            function renderRedeemTaskPage(taskId, task) {
                const contentArea = document.getElementById('redeem-task-content');
                screens.redeemTask.classList.remove('hidden');

                const rewardCurrencyIcon = task.rewardType === 'diamond' 
                    ? 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763297995.png?alt=media&token=db9ebed1-ff51-49ed-a311-0327313dae56' 
                    : 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762763055321.png?alt=media&token=58051d4b-446d-4a30-b588-bed5a5f49c8d';

                contentArea.innerHTML = `
                    <header class="sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center -mx-4 -mt-4 mb-4">
                        <button id="back-from-redeem-task" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold">${task.title}</h2>
                        <div class="w-10"></div>
                    </header>
                    <div class="space-y-6">
                        <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700">
                            <h3 class="font-bold text-green-400 mb-2">Rules & Instructions</h3>
                            <p class="text-sm text-gray-300 whitespace-pre-wrap">${task.rules}</p>
                        </div>
                         <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700">
                            <h3 class="font-bold text-green-400 mb-2">Download Link</h3>
                             <div class="bg-black/30 p-3 rounded-lg flex justify-between items-center">
                                <code class="text-sm text-gray-300 truncate">${task.url}</code>
                                <button id="copy-task-url-btn" class="bg-gray-600 hover:bg-gray-700 w-10 h-10 rounded-md flex items-center justify-center transition-colors flex-shrink-0 ml-2"><i class="fa-solid fa-copy"></i></button>
                            </div>
                        </div>
                        <div class="bg-[#1e1e1e] p-4 rounded-xl border border-gray-700">
                             <h3 class="font-bold text-green-400 mb-2">Submit Your Code</h3>
                             <form id="submit-redeem-code-form" class="space-y-3">
                                <input type="text" id="redeem-task-code-input" class="form-input text-center" placeholder="Enter code here..." required>
                                <button type="submit" class="w-full py-3 action-button rounded-lg font-bold flex items-center justify-center gap-2">
                                    Claim <img src="${rewardCurrencyIcon}" class="w-5 h-5"> ${task.rewardAmount}
                                </button>
                             </form>
                        </div>
                    </div>
                `;

                contentArea.querySelector('#back-from-redeem-task').addEventListener('click', () => screens.redeemTask.classList.add('hidden'));
                contentArea.querySelector('#copy-task-url-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(task.url).then(() => showModal('success', 'Link Copied!'));
                });
                contentArea.querySelector('#submit-redeem-code-form').addEventListener('submit', (e) => handleRedeemTaskSubmit(e, taskId, task));
            }

            async function handleRedeemTaskSubmit(e, taskId, task) {
                 e.preventDefault();
                 const form = e.target;
                 const inputCode = document.getElementById('redeem-task-code-input').value.trim();
                 
                 handleFormSubmit(form, 'Verifying Code...', async () => {
                    if (inputCode === task.redeemCode) {
                        const userProgressRef = database.ref(`users/${auth.currentUser.uid}/missionProgress/${taskId}`);
                        await userProgressRef.transaction(progress => {
                            progress = progress || { count: 0, lastCompletedDate: '' };
                            const todayBst = getBangladeshDateString();
                            
                            if (progress.lastCompletedDate !== todayBst) {
                                progress.count = 0;
                            }
                            
                            progress.count++;
                            progress.lastCompletedDate = todayBst;
                            return progress;
                        });

                        const currency = task.rewardType === 'diamond' ? 'diamonds' : 'coins';
                        await database.ref(`users/${auth.currentUser.uid}/wallet/${currency}`).transaction(current => (current || 0) + task.rewardAmount);
                        await addTransaction(auth.currentUser.uid, {
                            type: 'Mission Reward',
                            description: `Completed: ${task.title}`,
                            amount: task.rewardAmount,
                            currency: task.rewardType
                        });
                        
                        screens.redeemTask.classList.add('hidden');
                        showModal('success', 'Task Completed!', `You earned ${task.rewardAmount} ${task.rewardType}s.`);

                    } else {
                        throw new Error("Invalid code. Please make sure you copied the correct code.");
                    }
                 });
            }

             function renderPartnerScreen() {
                const screen = screens.partner;
                screen.classList.remove('hidden');
                
                document.getElementById('back-from-partner-screen').addEventListener('click', () => {
                    screen.classList.add('hidden');
                });

                document.getElementById('copy-partner-link-btn').addEventListener('click', (e) => {
                    const link = document.getElementById('partner-link-text').textContent;
                    navigator.clipboard.writeText(link).then(() => {
                        showModal('success', '  !', '     ');
                    });
                });
            }

        });
    </script>
</body>
</html>
