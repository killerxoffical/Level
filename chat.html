<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEVEL UP - Global Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        html, body {
            height: 100%; overflow: hidden; 
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
            -webkit-touch-callout: none; /* iOS Safari */
        }
        body { 
            background-color: #111214; color: #dcddde; font-family: 'Montserrat', sans-serif;
            margin: 0;
        }
        #chat-ui { height: 100%; position: relative; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #loading-chat { background-color: #ffffff; transition: opacity 0.5s ease-out; }
        #loading-chat.fade-out { opacity: 0; }
        #loading-icon { animation: loading-animation 3s ease-in-out forwards; }
        @keyframes loading-animation {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0; } 15% { transform: scale(1.1) rotate(15deg); opacity: 1; }
            30% { transform: scale(1.1) rotate(-15deg); } 55% { transform: scale(1.1) rotate(360deg); } 100% { transform: scale(1.1) rotate(0deg); }
        }

        #chat-ui.fade-in { animation: fade-in-animation 0.5s ease-in forwards; }
        @keyframes fade-in-animation { from { opacity: 0; } to { opacity: 1; } }

        @keyframes header-icon-dance {
            0%, 100% { transform: rotate(0deg); } 20% { transform: rotate(15deg); }
            40% { transform: rotate(-15deg); } 80% { transform: rotate(360deg); }
        }
        
        #chat-header { background-color: #111214; border-bottom: 1px solid #2d2f34; flex-shrink: 0; z-index: 20; }
        #chat-messages { 
            flex: 1 1 auto; 
            overflow-y: auto; 
            padding: 1rem 1rem 0 1rem; 
            scroll-padding-bottom: 10px; 
        }
        
        /* Message Bubble Visual Hierarchy */
        .message-group { position: relative; margin-top: 1.25rem; overflow: hidden; }
        .reply-icon-container { position: absolute; top: 0; right: 0; bottom: 0; width: 70px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: #fff; opacity: 0; z-index: 1; transition: opacity 0.1s ease-in-out; }
        .message-container { display: flex; position: relative; background-color: transparent; z-index: 2; transition: transform 0.2s ease-out; border-radius: 8px; }
        .message-container.highlight .message-content-wrapper { background-color: rgba(88, 81, 127, 0.4); }
        .avatar-container { width: 42px; height: 42px; flex-shrink: 0; margin-right: 1rem; position: relative; cursor: pointer; }
        .avatar { width: 100%; height: 100%; border-radius: 9999px; object-fit: cover; }
        .avatar-frame { position: absolute; top: 50%; left: 50%; width: 140%; height: 140%; transform: translate(-50%, -50%); object-fit: contain; pointer-events: none; }
        .message-content-wrapper { padding: 0.5rem 0.75rem; min-width: 0; border-radius: 12px; background-color: #202225; }
        .message-header { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 4px; }
        .username { font-weight: 600; color: #ffffff; font-size: 1rem; cursor: pointer; }
        .profile-badge-chat { height: 1.1em; width: auto; vertical-align: middle; }
        .timestamp { font-size: 0.7rem; color: #72767d; }
        .edited-tag { font-style: italic; margin-left: 4px; }
        .message-text { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .inline-image-emoji { height: 1.5em; width: 1.5em; vertical-align: middle; margin: 0 2px; }
        
        .message-media { margin-top: 0.5rem; max-height: 200px; border-radius: 12px; max-width: 250px; display: block; }
        .message-content-wrapper:has(.message-media:only-child) { background-color: transparent; padding: 0; }
        .message-content-wrapper:has(.message-media:only-child) .message-media { box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
        .message-media.sticker { max-width: 128px; max-height: 128px; background: transparent; }
        
        .message-container.admin-message .message-content-wrapper { background-color: rgba(138, 43, 226, 0.1); box-shadow: 0 0 15px rgba(138, 43, 226, 0.2); border: 1px solid rgba(138, 43, 226, 0.25); }
        .message-container.admin-message .message-text { font-family: 'Oswald', sans-serif; letter-spacing: 0.5px; font-size: 1rem; }
        
        .replied-message-block { display: flex; align-items: center; padding: 4px 8px; margin-bottom: 6px; margin-left: 58px; position: relative; cursor: pointer; width: fit-content; max-width: 80%; border-radius: 8px; }
        .replied-message-block.premium { background: linear-gradient(to right, var(--reply-bg-color-start, rgba(88, 101, 242, 0.4)) 0%, var(--reply-bg-color-mid, rgba(116, 79, 195, 0.25)) 60%, var(--reply-bg-color-end, rgba(116, 79, 195, 0)) 100%); }
        .replied-message-block.default { background: rgba(40, 43, 48, 0.7); }
        .replied-avatar { width: 16px; height: 16px; border-radius: 50%; margin-right: 0.5rem; }
        .replied-username { font-size: 0.8rem; font-weight: 600; color: #fff; margin-right: 0.5rem; white-space: nowrap; flex-shrink: 0; }
        .replied-text { font-size: 0.8rem; color: #b9bbbe; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .reply-prefix-icon { color: #8e9297; font-size: 0.7rem; margin-right: 0.4rem; }

        .date-separator { display: flex; align-items: center; color: #72767d; margin: 1.5rem 0 0.5rem; font-size: 0.75rem; font-weight: 600; }
        .date-separator hr { flex-grow: 1; border: none; border-top: 1px solid #36393f; }
        .date-separator span { padding: 0 1rem; }

        #chat-footer { flex-shrink: 0; background-color: #111214; padding: 0.5rem 0.75rem 0.75rem 0.75rem; border-top: 1px solid #2d2f34; position: relative; z-index: 20; }
        #input-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-row { display: flex; align-items: flex-end; gap: 0.5rem; }
        #message-input-wrapper { background-color: #202225; border-radius: 22px; flex-grow: 1; display: flex; align-items: center; position: relative; }
        #message-input { background: transparent; resize: none; max-height: 120px; padding: 0.7rem 45px 0.7rem 3rem; color: white; width: 100%; }
        #message-input:focus { outline: none; }
        #emoji-btn { position: absolute; left: 2px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: #b9bbbe; transition: color 0.2s ease; }
        #emoji-btn:hover { color: #fff; }
        #char-counter { position: absolute; bottom: 8px; right: 10px; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; background-color: #2b2d31; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: color 0.2s ease-in-out; z-index: 5; }
        #char-counter.green { color: #3ba55d; } #char-counter.yellow { color: #faa61a; } #char-counter.red { color: #f04747; }
        #reply-indicator, #selected-media-preview { background-color: rgba(0,0,0,0.2); border-radius: 10px; }
        #send-btn { width: 44px; height: 44px; flex-shrink: 0; background-color: #37393f; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s ease; }
        #send-btn.ready-to-send { background-color: #22c55e; }
        
        #header-back-btn .fa-arrow-left, #header-back-btn .fa-chevron-down { transition: transform 0.3s ease, opacity 0.3s ease; }
        #header-back-btn.show-scroll-down .fa-arrow-left { transform: translateY(-120%); opacity: 0; }
        #header-back-btn.show-scroll-down .fa-chevron-down { transform: translateY(0); opacity: 1; }
        #header-back-btn .fa-arrow-left { transform: translateY(0); opacity: 1; }
        #header-back-btn .fa-chevron-down { transform: translateY(120%); opacity: 0; }

        #premium-settings-modal { z-index: 50; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        #premium-settings-modal .modal-content { background-color: #18191c; border-radius: 12px; box-shadow: 0 0 30px rgba(138, 43, 226, 0.2); border: 1px solid rgba(138, 43, 226, 0.15); width: 100%; max-w-md; padding: 1.5rem; text-white; position: relative; }
        #premium-settings-modal .settings-section { margin-bottom: 2rem; }
        #premium-settings-modal .section-header { font-family: 'Oswald', sans-serif; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: #a1a1aa; display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        #premium-settings-modal .section-header::after { content: ''; flex-grow: 1; height: 1px; background: #3a3a3a; }
        .color-swatch { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: #ffffff; box-shadow: 0 0 10px #fff; }

        #typing-indicator { transition: opacity 0.3s; align-items: center; gap: 8px; padding: 0 0.5rem; }
        .typing-avatar-stack { display: flex; align-items: center; }
        .typing-avatar { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #111214; object-fit: cover; }
        .typing-avatar:not(:first-child) { margin-left: -12px; }
        .typing-plus-badge { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; margin-left: -12px; z-index: 5; border-radius: 50%; background-color: #37393f; color: #dcddde; font-size: 0.65rem; font-weight: 700; border: 2px solid #111214; }
        .typing-text { font-size: 0.85rem; color: #8e9297; font-weight: 500; }
        
        .online-dot { /* animation removed */ }
        
        #media-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 45vh; background-color: #18191c; border-top: 1px solid #2d2f34; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 15; box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2); transform: translateY(100%); border-top-left-radius: 16px; border-top-right-radius: 16px; }
        #media-panel.show { transform: translateY(0); }
        .media-tab { color: #8e9297; transition: color 0.2s, border-color 0.2s; }
        .media-tab:hover { color: #ffffff; }
        .media-tab.active-tab { color: #ffffff; border-color: #5865f2; }
        .media-item { cursor: pointer; text-align: center; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; aspect-ratio: 1 / 1; background-color: #2b2d31; border-radius: 8px; position: relative; }
        .media-item:hover { transform: scale(1.1); background-color: #37393f; }
        .media-item span { font-size: 2rem; }
        .media-item img { max-width: 90%; max-height: 90%; object-fit: contain; }
        #emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 1rem; }
        #sticker-grid, #gif-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(96px, 1fr)); gap: 1rem; }
        .media-loader { text-align: center; color: #8e9297; padding: 2rem; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #ffffff; width: 24px; height: 24px; animation: spin-alt 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin-alt { to { transform: rotate(360deg); } }
        .media-lock-icon { position: absolute; top: 4px; right: 4px; color: #facc15; background-color: rgba(0,0,0,0.6); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }

        .fullscreen-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1000; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); overflow-y: auto; color: white; }
        .fullscreen-panel.show { transform: translateX(0); }
        #chat-profile-banner { border-bottom-left-radius: 2rem; border-bottom-right-radius: 2rem; overflow: hidden; }
        #chat-profile-banner-media video, #chat-profile-banner-media img { width: 100%; height: 100%; object-fit: cover; }
        #chat-profile-avatar { border: 4px solid #121212; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        .profile-badge-view { height: 1.5em; width: auto; vertical-align: middle; margin-left: 0.5rem; }
        .premium-section-header { font-family: 'Oswald', sans-serif; text-align: center; color: #a1a1aa; font-weight: 600; font-size: 0.9rem; position: relative; display: flex; align-items: center; gap: 1rem; }
        .premium-section-header::before, .premium-section-header::after { content: ''; flex-grow: 1; height: 1px; background: #3a3a3a; }
        #chat-profile-badges-container .badge-slot, #chat-profile-titles-grid .title-slot { background: transparent !important; border: none !important; box-shadow: none !important; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; }
        #chat-profile-badges-container .badge-slot { width: 40px; height: 40px; }
        #chat-profile-titles-grid .title-slot { width: 100%; height: 48px; }
        #chat-profile-badges-container .badge-slot img, #chat-profile-badges-container .badge-slot video, #chat-profile-titles-grid .title-slot img { width: 100%; height: 100%; object-fit: contain; background: transparent !important; border: none !important; box-shadow: none !important; }
        .empty-text-bn { color: #6b7280; font-size: 0.8rem; text-align: center; width: 100%; padding: 10px; }
        .follow-button { background-image: linear-gradient(to right, #1DB954, #1ed760); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
        .unfollow-button { background-image: linear-gradient(to right, #ef4444, #dc2626); color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
        #chat-my-team-card { background-color: #1e1e1e; border: 1px solid #3a3a3a; border-radius: 1rem; padding: 1rem; }
        #chat-my-team-card .team-logo { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #4a4a4a; }
        #chat-my-team-card .rank-score { font-family: 'Oswald', sans-serif; font-size: 2rem; font-weight: 700; }
        #chat-my-team-card .rank-change-arrows { display: flex; flex-direction: column; font-size: 1.1rem; margin-left: 0.25rem; }
        .report-form-label { font-weight: 600; color: #a1a1aa; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .report-form-input { background-color: #1e1e1e; border: 1px solid #3a3a3a; border-radius: 0.5rem; padding: 0.75rem; width: 100%; color: #fff; }
        .report-form-input:focus { outline: none; border-color: #4f46e5; }
        #report-suggestion { font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem; }

        #subscription-details-screen {
            background: linear-gradient(160deg, #1e133a 0%, #111214 40%);
            z-index: 1001;
        }
        .pricing-card {
            background: linear-gradient(145deg, #242428, #1e1e1e);
            border: 1px solid #3a3a3a;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 15px rgba(168, 85, 247, 0.1);
        }
        .pricing-card.gold { border-color: #a855f7; }
        .pricing-card ul li { display: flex; align-items: center; gap: 0.75rem; font-weight: 500;}
        .pricing-card ul li i { color: #a855f7; }
        .action-button-premium {
            background-image: linear-gradient(to right, #a855f7, #ec4899);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }
        .action-button-premium:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4); }
        
        #one-tap-buy-panel { position: fixed; bottom: 0; left: 0; right: 0; background-color: #18191c; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; box-shadow: 0 -10px 30px rgba(0,0,0,0.4); z-index: 1002; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding-bottom: env(safe-area-inset-bottom); }
        #one-tap-buy-panel.show { transform: translateY(0); }
        
        #purchase-loading-overlay { z-index: 1100; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        #purchase-loading-overlay .spinner-premium {
            width: 56px; height: 56px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #a855f7;
            border-right-color: #ec4899;
            animation: spin-alt 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        /* --- UPDATED: FULLSCREEN ANNOUNCEMENT STYLES --- */
        #fullscreen-announcement {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #fullscreen-announcement-content {
            background-color: #18191c;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(255, 193, 7, 0.15);
        }
        #announcement-content-scroll {
            flex-grow: 1;
            overflow-y: auto;
        }
        #announcement-content-scroll::-webkit-scrollbar { width: 4px; }
        #announcement-content-scroll::-webkit-scrollbar-track { background: transparent; }
        #announcement-content-scroll::-webkit-scrollbar-thumb { background: #4a4a52; border-radius: 4px; }
        #ack-announcement-btn {
            background-color: #ffc107;
            color: #111214;
            font-weight: bold;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
            margin-top: 1rem;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        #ack-announcement-btn:hover {
            background-color: #ffca2c;
        }
    </style>
</head>
<body>

    <div id="loading-chat" class="flex items-center justify-center h-full">
        <!-- Loading SVG remains the same -->
        <div id="loading-icon" class="w-24 h-24"><svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 60 60" viewBox="0 0 60 60" id="discord"><g><path fill="#FFF" d="M50,60H10C4.477,60,0,55.523,0,50V10C0,4.477,4.477,0,10,0h40c5.523,0,10,4.477,10,10v40 C60,55.523,55.523,60,50,60z"></path></g><g><path fill="#D2BBFF" d="M44.82,50.27l-3.49-4.36c-5.55,1.45-11.11,1.45-16.66,0l-3.49,4.36C7.68,48.29,9,43,9,43c0-16,6-24,6-24 s3.62-2.4,10.84-3.48l1.29,3.86C28.86,19.15,30.82,19,33,19s4.14,0.15,5.87,0.38l1.29-3.86C47.38,16.6,51,19,51,19s6,8,6,24 C57,43,58.32,48.29,44.82,50.27z"></path><path fill="#7D40F4" d="M18.18 48.77c-.072 0-.145-.005-.218-.016C11.44 47.798 7.21 45.933 5.387 43.212c-.993-1.483-.959-2.793-.887-3.332.029-16.233 6.043-24.438 6.3-24.781.103-.137.229-.256.371-.35.159-.106 3.983-2.597 11.447-3.713.716-.113 1.413.318 1.645 1.008l1.29,3.86c.263.786-.162 1.636-.947 1.898-.789.264-1.636-.162-1.898-.947l-.885-2.647c-5.017.911-7.966 2.447-8.771 2.909C12.151 18.477 7.5 26.176 7.5 40c0 .123-.015.245-.045.363 0 0 .001-.001.001-.001.005 0-.077.791.951 1.811 1.104 1.096 3.584 2.563 9.145 3.481l2.947-3.682c.518-.648 1.463-.751 2.108-.233.646.518.751 1.461.233 2.108l-3.49 4.36C19.063 48.566 18.631 48.77 18.18 48.77zM41.82 48.77c-.452 0-.884-.204-1.171-.562l-3.49-4.36c-.518-.647-.413-1.591.233-2.108.646-.517 1.592-.414 2.108.233l2.947 3.682c5.561-.917 8.04-2.385 9.145-3.481 1.047-1.039.943-1.84.938-1.874C52.501 40.181 52.5 40.123 52.5 40c0-13.898-4.643-21.526-5.548-22.881-.796-.457-3.746-1.998-8.774-2.911l-.885 2.647c-.263.785-1.111 1.209-1.898.947-.785-.263-1.21-1.113-.947-1.898l1.29-3.86c.23-.69.922-1.12 1.645-1.008 7.464 1.116 11.288 3.607 11.447 3.713.143.094.269.213.371.35.257.342 6.271 8.548 6.3 24.781.072.539.106 1.849-.887 3.332-1.823 2.721-6.054 4.585-12.575 5.542C41.965 48.765 41.893 48.77 41.82 48.77z"></path><g><circle cx="22" cy="32" r="4" fill="#FFF"></circle><path fill="#7D40F4" d="M22,36.75c-2.619,0-4.75-2.131-4.75-4.75s2.131-4.75,4.75-4.75s4.75,2.131,4.75,4.75 S24.619,36.75,22,36.75z M22,28.75c-1.792,0-3.25,1.458-3.25,3.25s1.458,3.25,3.25,3.25s3.25-1.458,3.25-3.25 S23.792,28.75,22,28.75z"></path></g><g><circle cx="38" cy="32" r="4" fill="#FFF"></circle><path fill="#7D40F4" d="M38,36.75c-2.619,0-4.75-2.131-4.75-4.75s2.131-4.75,4.75-4.75s4.75,2.131,4.75,4.75 S40.619,36.75,38,36.75z M38,28.75c-1.792,0-3.25,1.458-3.25,3.25s1.458,3.25,3.25,3.25s3.25-1.458,3.25-3.25 S39.792,28.75,38,28.75z"></path></g><ellipse cx="24.298" cy="17.231" fill="#D2BBFF" rx="1.702" ry=".705"></ellipse><ellipse cx="35.596" cy="17.231" fill="#FFF" rx="1.702" ry=".705"></ellipse><path fill="#7D40F4" d="M45.184,19.756c-0.113,0-0.229-0.026-0.338-0.081C43.107,18.795,38.18,16.75,30,16.75 c-8.177,0-13.104,2.042-14.842,2.92c-0.371,0.188-0.82,0.039-1.008-0.332c-0.187-0.37-0.038-0.821,0.332-1.007 C16.316,17.405,21.501,15.25,30,15.25c8.502,0,13.688,2.159,15.523,3.086c0.369,0.187,0.518,0.638,0.33,1.008 C45.722,19.605,45.458,19.756,45.184,19.756z"></path><g><path fill="#D2BBFF" d="M14,40c10.667,5.333,21.333,5.333,32,0"></path><path fill="#7D40F4" d="M30,44.735c-5.458,0-10.916-1.354-16.335-4.064c-0.371-0.186-0.521-0.636-0.336-1.006 c0.187-0.37,0.636-0.52,1.006-0.335c10.395,5.197,20.936,5.197,31.33,0c0.371-0.185,0.82-0.035,1.006,0.335 c0.186,0.371,0.035,0.821-0.336,1.006C40.916,43.381,35.458,44.735,30,44.735z"></path></g></g></svg></div>
    </div>

    <div id="chat-ui" class="hidden" style="opacity: 0;">
        <header id="chat-header" class="p-2 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button id="header-back-btn" class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center text-gray-300 hover:text-white shadow-md transition-colors relative overflow-hidden text-lg">
                    <i class="fas fa-arrow-left absolute"></i>
                    <i class="fas fa-chevron-down absolute"></i>
                </button>
                <svg id="header-discord-icon" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 100 100" viewBox="0 0 100 100" class="w-8 h-8"><g id="Layer_2"><path fill="#D2BBFF" d="M64.193 47.63c2.334 0 4.465 1.302 5.698 3.484.256.452.726.706 1.21.706 1.029.026 1.747-1.183 1.208-2.074-1.708-3.019-4.818-4.894-8.117-4.894-12.607.418-12.524 19.726 0 20.216 5.312 0 9.473-4.44 9.473-10.108-.033-1.828-2.747-1.825-2.779 0 0 4.11-2.94 7.329-6.695 7.329C55.358 61.976 55.299 47.89 64.193 47.63zM44.737 54.982c.211-5.297-4.149-10.216-9.474-10.131-12.608.419-12.523 19.727 0 20.215C40.576 65.067 44.737 60.627 44.737 54.982zM28.569 54.959c-.157-6.239 7.012-9.771 11.312-5.363 4.305 4.223 1.52 12.82-4.618 12.693C31.573 62.288 28.569 59.001 28.569 54.959z"></path><path fill="#7D40F4" d="M86.094,24.562c-10.864-8.869-24.123-9.672-24.451-8.483c0,0-1.11,1.268-1.11,1.268c-0.669,0.722-0.299,1.989,0.647,2.245 c0.674,0.202,1.328,0.409,1.965,0.62c-9.388-1.933-19.11-1.551-28.487,0.298c1.233-0.426,2.539-0.838,3.918-1.229 c0.946-0.234,1.333-1.5,0.688-2.227c-0.411-0.44-1.054-1.537-1.83-1.45c-0.02-0.083-12.775,0.089-23.438,8.957 c-0.078,0.141-1.943,3.515-4.18,9.224c-0.626,1.723,1.884,2.697,2.587,1.014c1.821-4.647,3.413-7.747,3.883-8.63 c4.241-3.105,8.396-4.973,11.883-6.096c-7.792,3.468-11.499,6.977-11.703,7.174c-1.146,1.104,0.232,2.987,1.629,2.22 c18.938-10.094,43.589-10.543,62.559,0.004c1.369,0.775,2.794-1.151,1.615-2.231c-0.222-0.211-4.747-4.436-14.232-8.206 c4.014,0.839,9.827,2.756,15.764,7.133c1.277,2.416,10.979,21.53,11.101,44.45c-1.563,2.222-8.137,10.217-22.156,10.904 c-0.682-0.818-2.069-2.485-3.488-4.216c9.308-3.242,12.995-9.069,13.157-9.332c0.773-1.24-0.729-2.707-1.947-1.889 C62.612,77.828,38.071,77.51,20.207,66.105c-1.166-0.879-2.784,0.641-1.983,1.861c0.156,0.257,3.703,5.949,12.729,9.243 c-1.455,1.805-2.906,3.551-3.608,4.393c-8.549-0.112-18.133-4.802-22.157-10.959c0.048-9.99,1.869-20.379,5.411-30.886 c0.569-1.73-2.029-2.612-2.632-0.888c-3.59,11.159-5.989,22.27-5.37,32.881c0.288,0.493,7.253,12.084,25.33,12.656 c0.424,0.014,0.834-0.168,1.107-0.494c0.03-0.035,2.975-3.538,5.339-6.532c0.612-0.734,0.225-1.943-0.693-2.192 c4.547,1.498,20.09,4.356,32.365,0.304c-0.616,0.444-0.728,1.402-0.237,1.981c2.357,2.907,5.217,6.324,5.245,6.358 c0.275,0.327,0.651,0.51,1.11,0.497c16.405-0.52,23.844-10.359,25.241-12.444C98.707,47.531,86.21,24.87,86.094,24.562z"></path></g></svg>
                <div><div class="flex items-center gap-2"><h1 id="header-username" class="font-bold text-white text-lg"></h1><div class="flex items-center gap-1 text-xs font-semibold text-green-400"><div class="w-1.5 h-1.5 bg-green-400 rounded-full online-dot"></div><span>Online</span></div></div><p class="text-xs text-gray-400">Global Chat Community</p></div>
            </div>
            <button id="open-premium-settings-btn" class="w-12 h-12 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" id="discord-nitro"><path fill="#FF4DA5" d="M15 4.25C10.7198 4.25 7.25 7.71979 7.25 12C7.25 16.2802 10.7198 19.75 15 19.75C19.2802 19.75 22.75 16.2802 22.75 12C22.75 7.71979 19.2802 4.25 15 4.25Z"></path><path fill="#FF4DA5" fill-rule="evenodd" d="M5.25 5C5.25 4.58579 5.58579 4.25 6 4.25H15C15.4142 4.25 15.75 4.58579 15.75 5 15.75 5.41421 15.4142 5.75 15 5.75H6C5.58579 5.75 5.25 5.41421 5.25 5zM4.75 8.5C4.75 8.08579 5.08579 7.75 5.5 7.75H8.5C8.91421 7.75 9.25 8.08579 9.25 8.5 9.25 8.91421 8.91421 9.25 8.5 9.25H5.5C5.08579 9.25 4.75 8.91421 4.75 8.5zM1.25 8.5C1.25 8.08579 1.58579 7.75 2 7.75H3.5C3.91421 7.75 4.25 8.08579 4.25 8.5 4.25 8.91421 3.91421 9.25 3.5 9.25H2C1.58579 9.25 1.25 8.91421 1.25 8.5zM3.25 12.5C3.25 12.0858 3.58579 11.75 4 11.75H8C8.41421 11.75 8.75 12.0858 8.75 12.5 8.75 12.9142 8.41421 13.25 8 13.25H4C3.58579 13.25 3.25 12.9142 3.25 12.5z" clip-rule="evenodd"></path><path fill="#ECEFF1" fill-rule="evenodd" d="M12.376 8.58397C12.5151 8.37533 12.7492 8.25 13 8.25H17C17.2508 8.25 17.4849 8.37533 17.624 8.58397L19.624 11.584C19.792 11.8359 19.792 12.1641 19.624 12.416L17.624 15.416C17.4849 15.6247 17.2508 15.75 17 15.75H13C12.7492 15.75 12.5151 15.6247 12.376 15.416L10.376 12.416C10.208 12.1641 10.208 11.8359 10.376 11.584L12.376 8.58397ZM13.4014 9.75L11.9014 12L13.4014 14.25H16.5986L18.0986 12L16.5986 9.75H13.4014Z" clip-rule="evenodd"></path></svg></button>
        </header>

        <main id="chat-messages" class="no-scrollbar"></main>
        
        <div id="media-panel" class="no-scrollbar flex flex-col">
            <div class="p-4 flex-shrink-0 sticky top-0 bg-[#18191c] z-10 border-b border-[#2d2f34]">
                <div class="relative flex items-center justify-center">
                    <h2 class="text-lg font-bold text-white">Premium Media</h2>
                    <button id="close-media-panel-btn" class="absolute right-0 text-gray-400 hover:text-white text-xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav class="mt-4 flex space-x-2">
                    <button data-tab="emoji" class="media-tab active-tab flex-1 py-2 text-sm font-semibold border-b-2">Emoji</button>
                    <button data-tab="sticker" class="media-tab flex-1 py-2 text-sm font-semibold border-b-2 border-transparent">Sticker</button>
                    <button data-tab="gif" class="media-tab flex-1 py-2 text-sm font-semibold border-b-2 border-transparent">GIF</button>
                </nav>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-24">
                <div id="media-tab-content-emoji" class="media-tab-content">
                    <div id="emoji-grid"></div>
                </div>
                <div id="media-tab-content-sticker" class="media-tab-content hidden">
                    <div id="sticker-grid"></div>
                </div>
                <div id="media-tab-content-gif" class="media-tab-content hidden">
                    <div id="gif-grid"></div>
                </div>
            </div>
        </div>

        <footer id="chat-footer" style="display: none;">
            <div id="input-container">
                <div id="reply-indicator" class="hidden items-center justify-between p-2 text-sm"><div><p class="text-gray-400">Replying to <strong id="reply-username" class="text-white"></strong></p><p id="reply-text" class="text-gray-300 truncate max-w-xs"></p></div><button id="cancel-reply-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button></div>
                <div id="selected-media-preview" class="hidden items-center justify-between p-2 text-sm">
                    <div class="flex items-center gap-2">
                        <img id="selected-media-img" src="" class="w-8 h-8 object-contain">
                        <p id="selected-media-text" class="text-gray-300">Media Attached</p>
                    </div>
                    <button id="cancel-media-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="typing-indicator" class="h-6 flex items-center gap-2 text-sm text-gray-400 opacity-0 hidden"></div>
                
                <div class="input-row">
                    <div id="message-input-wrapper">
                        <button id="emoji-btn"><i class="far fa-smile"></i></button>
                        <textarea id="message-input" rows="1" maxlength="30" placeholder="Message Global Chat" class="no-scrollbar"></textarea>
                        <span id="char-counter" class="green">30</span>
                    </div>
                    <button id="send-btn" disabled class="w-11 h-11 flex-shrink-0 text-white text-xl flex items-center justify-center rounded-full transition-all duration-300"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </footer>

        <div id="ban-indicator" class="hidden flex-shrink-0 bg-red-900/50 p-4 border-t border-red-700 text-center flex-col items-center justify-center">
            <h3 class="text-lg font-bold text-red-300">YOU ARE CHAT BANNED</h3>
            <p class="text-red-200">Remaining Time: <span id="ban-timer" class="font-mono font-bold"></span></p>
            <p class="text-sm text-red-400 mt-2">Please contact an administrator for assistance.</p>
        </div>

        <div id="lock-indicator" class="hidden flex-shrink-0 bg-gray-900/50 p-4 border-t border-gray-700 text-center flex-col items-center justify-center">
            <i class="fas fa-lock text-2xl text-yellow-300 mb-2"></i>
            <h3 class="text-lg font-bold text-yellow-300">CHAT IS LOCKED</h3>
            <p class="text-sm text-yellow-200">The chat is temporarily locked by an official.</p>
        </div>
    </div>
    
    <!-- UPDATED: FULLSCREEN ANNOUNCEMENT OVERLAY -->
    <div id="fullscreen-announcement">
        <div id="fullscreen-announcement-content">
            <div id="announcement-content-scroll" class="space-y-3">
                <!-- Announcement content will be injected here -->
            </div>
            <button id="ack-announcement-btn">আমি সম্পূর্ণ ঘোষণাটি পড়েছি</button>
        </div>
    </div>
    
    <div id="premium-settings-modal" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content">
            <button id="close-premium-settings-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-center">Premium Settings</h2>
            
            <div id="premium-timer-container" class="text-center mb-4 hidden">
                <p class="text-sm text-yellow-400 font-semibold" id="premium-timer"></p>
            </div>

            <div class="settings-section">
                <h3 class="section-header">Identity</h3>
                <div id="settings-message-preview" class="message-group mx-auto opacity-80" style="margin-top:0; max-width: 90%;">
                     <div class="message-container">
                         <div class="avatar-container"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" class="avatar"></div>
                         <div class="message-content-wrapper">
                             <div class="message-header">
                                 <span id="settings-username-preview" class="username">YourName</span>
                                 <span class="timestamp">12:00 PM</span>
                             </div>
                             <div class="message-text">This is how your name will look.</div>
                         </div>
                    </div>
                </div>
                <div id="username-color-picker" class="flex flex-wrap gap-3 justify-center mt-4"></div>
            </div>

            <div class="settings-section">
                <h3 class="section-header">Reply Style</h3>
                 <div id="settings-reply-preview" class="message-group mx-auto opacity-80" style="margin-top:0; max-width: 90%;">
                    <div class="replied-message-block premium" style="margin-left: 0;">
                        <i class="fas fa-reply reply-prefix-icon"></i>
                        <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" class="replied-avatar">
                        <span id="settings-reply-username-preview" class="replied-username">LEVEL UP</span>
                        <span class="replied-text">Hello</span>
                    </div>
                </div>
                <h4 class="font-semibold mb-2 text-gray-400 text-sm text-center mt-4">Reply Box Color</h4>
                <div id="reply-box-color-picker" class="flex flex-wrap gap-3 justify-center"></div>
                <h4 class="font-semibold mb-2 text-gray-400 text-sm text-center mt-4">Replied Name Color</h4>
                <div id="reply-name-color-picker" class="flex flex-wrap gap-3 justify-center"></div>
            </div>
            
            <button id="premium-action-btn" class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 rounded-lg transition-colors"></button>
        </div>
    </div>

    <!-- USER PROFILE SCREEN -->
    <div id="user-profile-screen" class="fullscreen-panel no-scrollbar">
        <!-- Profile screen content remains the same -->
        <header class="p-2 flex items-center justify-between gap-3 absolute top-0 left-0 w-full z-20 bg-gradient-to-b from-black/50 to-transparent">
            <button id="close-profile-btn" class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center text-gray-300 hover:text-white shadow-md transition-colors"><i class="fas fa-arrow-left text-lg"></i></button>
            <button id="report-user-btn" class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center text-gray-300 hover:text-white shadow-md transition-colors"><i class="fas fa-flag text-lg"></i></button>
        </header>

        <div class="w-full text-white pb-10">
            <div id="chat-profile-banner" class="relative w-full h-40 bg-gray-800">
                <div id="chat-profile-banner-media" class="w-full h-full"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
            </div>
            <div class="relative px-4 pb-4 -mt-14">
                <div class="flex justify-center">
                    <div class="relative w-28 h-28">
                        <img id="chat-profile-avatar" src="" class="w-full h-full rounded-full object-cover">
                        <img id="chat-profile-avatar-frame" src="" class="absolute top-1/2 left-1/2 w-[140%] h-[140%] -translate-x-1/2 -translate-y-1/2 object-contain pointer-events-none hidden">
                    </div>
                </div>
                <div id="chat-profile-username-container" class="text-center mt-3 flex items-center justify-center">
                    <h2 id="chat-profile-username" class="text-3xl font-bold font-oswald inline"></h2>
                </div>
                <div class="flex justify-center items-center gap-8 mt-4" id="chat-profile-follow-stats"></div>
                <div class="mt-6 px-4">
                    <button id="follow-toggle-btn" class="w-full py-3 rounded-lg text-sm"></button>
                </div>
                
                <div id="profile-badges-section" class="mt-8">
                    <h3 class="premium-section-header">BADGES</h3>
                    <div id="chat-profile-badges-container" class="flex justify-center items-center gap-2 mt-3 min-h-[40px]"></div>
                </div>
                <div id="profile-titles-section" class="mt-8">
                    <h3 class="premium-section-header">MY TITLE</h3>
                    <div id="chat-profile-titles-grid" class="grid grid-cols-2 gap-3 mt-3 max-w-sm mx-auto min-h-[48px]"></div>
                </div>
                <div id="profile-team-section" class="mt-8 px-4">
                     <h3 class="premium-section-header">MY TEAM</h3>
                     <div id="chat-profile-team-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT SCREEN -->
    <div id="report-screen" class="fullscreen-panel no-scrollbar">
        <!-- Report screen content remains the same -->
        <header class="p-2 flex items-center justify-between gap-3 sticky top-0 left-0 w-full z-20 bg-black/80 backdrop-blur-sm">
            <button id="close-report-btn" class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center text-gray-300 hover:text-white shadow-md transition-colors"><i class="fas fa-arrow-left text-lg"></i></button>
            <h2 class="text-xl font-bold text-white">Report User</h2>
            <div class="w-10 h-10"></div> <!-- Spacer -->
        </header>
        <div class="p-4 space-y-6">
            <div>
                <h3 class="text-lg font-semibold mb-2">Report <span id="reported-username" class="text-indigo-400"></span></h3>
                <p class="text-sm text-gray-400">Your report is anonymous. If someone is in immediate danger, call local emergency services.</p>
            </div>

            <form id="report-form" class="space-y-4">
                <div>
                    <label for="report-reason" class="report-form-label block">Reason for report</label>
                    <select id="report-reason" class="report-form-input">
                        <option>Spam or Scams</option>
                        <option>Harassment or Bullying</option>
                        <option>Inappropriate Content</option>
                        <option>Impersonation</option>
                        <option>Other rule violation</option>
                    </select>
                </div>
                <div>
                    <label for="report-details" class="report-form-label block">Details (Required)</label>
                    <textarea id="report-details" rows="4" class="report-form-input" placeholder="Please provide as much detail as possible."></textarea>
                </div>
                <div>
                    <label for="report-video-link" class="report-form-label block">Video Evidence Link (Optional)</label>
                    <input type="url" id="report-video-link" class="report-form-input" placeholder="https://youtube.com/watch?v=...">
                    <p id="report-suggestion">For best results, upload videos to YouTube, Streamable, or a similar platform.</p>
                </div>
                <div>
                    <label for="report-image" class="report-form-label block">Image Evidence (Optional)</label>
                    <input type="file" id="report-image" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 font-bold py-3 rounded-lg transition-colors">Submit Report</button>
            </form>

            <div class="mt-8">
                 <h3 class="premium-section-header">MY REPORT STATUS</h3>
                 <div id="my-reports-container" class="mt-4 space-y-3">
                    <div class="text-center py-4"><p class="text-sm text-gray-500">Your submitted reports will appear here.</p></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- PREMIUM SUBSCRIPTION SCREEN -->
    <div id="subscription-details-screen" class="fullscreen-panel no-scrollbar p-4">
        <header class="p-2 flex items-center w-full absolute top-0 left-0 z-10">
            <button id="close-subscription-screen-btn" class="w-10 h-10 bg-gray-800/50 rounded-full flex items-center justify-center text-gray-300 hover:text-white"><i class="fas fa-arrow-left"></i></button>
        </header>
        <div class="w-full max-w-md mx-auto flex flex-col justify-center min-h-full">
            <div class="pricing-card gold p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" viewBox="0 0 24 24" fill="url(#premium-gradient)"><defs><linearGradient id="premium-gradient" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#a855f7"></stop><stop offset="100%" stop-color="#ec4899"></stop></linearGradient></defs><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm4.286 9.714-3 3a.999.999 0 0 1-1.414 0l-1.5-1.5a.999.999 0 1 1 1.414-1.414L11.5 11.586l2.286-2.286a.999.999 0 1 1 1.414 1.414z"></path></svg>
                <h2 class="text-3xl font-bold font-oswald" style="background: -webkit-linear-gradient(#a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">CHAT PREMIUM</h2>
                <p class="text-gray-400 mb-6">Unlock exclusive features</p>
                <div class="flex items-center justify-center gap-4">
                    <del id="premium-original-price" class="text-3xl font-bold text-gray-500 hidden"></del>
                    <div class="text-5xl font-bold mb-2"><span id="premium-price-display">75</span><span class="text-xl font-normal text-gray-400"> TK</span></div>
                </div>
                <p class="text-gray-400 font-semibold mb-8">/ 30 Days</p>
                <ul class="text-left space-y-3 mb-8 text-gray-300">
                    <li><i class="fas fa-check-circle"></i> Use unlimited premium Emojis</li>
                    <li><i class="fas fa-check-circle"></i> Send cool Stickers & GIFs</li>
                    <li><i class="fas fa-check-circle"></i> Customize your name color</li>
                    <li><i class="fas fa-check-circle"></i> Customize your reply style</li>
                    <li><i class="fas fa-check-circle"></i> 60 character message limit</li>
                    <li><i class="fas fa-check-circle"></i> Show your support!</li>
                </ul>
                <button id="buy-subscription-btn" class="w-full action-button-premium py-3 rounded-lg font-bold text-lg">Buy Subscription</button>
            </div>
        </div>
    </div>

    <!-- 1-TAP BUY PANEL -->
    <div id="one-tap-buy-panel" class="p-4 pt-2">
        <div class="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mb-4"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Confirm Purchase</h3>
            <button id="close-buy-panel-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="bg-gray-800/50 p-4 rounded-lg space-y-2">
            <div class="flex justify-between items-center text-sm">
                <p class="text-gray-400">Item</p>
                <p class="font-semibold text-purple-400">Chat Premium (30 Days)</p>
            </div>
            <div class="flex justify-between items-center text-sm">
                <p class="text-gray-400">Your Wallet Balance</p>
                <p class="font-semibold" id="buy-panel-balance">0.00 TK</p>
            </div>
            <div class="border-t border-gray-700 my-1"></div>
            <div class="flex justify-between items-center text-lg">
                <p class="font-bold">Total Price</p>
                <p class="font-bold text-green-400" id="buy-panel-price">75.00 TK</p>
            </div>
        </div>
        <button id="one-tap-buy-btn" class="w-full action-button-premium py-4 rounded-lg font-bold text-lg mt-4">1-Tap Buy</button>
    </div>

    <!-- PREMIUM PURCHASE LOADING OVERLAY -->
    <div id="purchase-loading-overlay" class="hidden fixed inset-0 flex items-center justify-center">
        <div class="text-center text-white">
            <div class="spinner-premium mx-auto"></div>
            <p class="mt-4 font-semibold text-lg tracking-wider">Processing Purchase...</p>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // --- SCRIPT CONTENT FROM PREVIOUS RESPONSE, WITH MODIFICATIONS ---
        
        // =================================================================================
        // --- 1. SETUP & INITIALIZATION ---
        // =================================================================================

        // Firebase Configuration
        const firebaseConfig = { apiKey: "AIzaSyBLhxlVr8mjel_rVI1xqeRJ2DSywjiI2ek", authDomain: "nxzwallet.firebaseapp.com", databaseURL: "https://nxzwallet-default-rtdb.firebaseio.com", projectId: "nxzwallet", storageBucket: "nxzwallet.appspot.com", messagingSenderId: "910859278641", appId: "1:910859278641:web:d896205c530816fb297810" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Firebase Database References
        const chatRef = database.ref('chats/public-v2');
        const typingRef = database.ref('typingStatus/public-v2');
        const adminConfigRef = database.ref('admin/config');

        // DOM Element References
        const loadingScreen = document.getElementById('loading-chat');
        const chatUI = document.getElementById('chat-ui');
        const messagesContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const replyIndicator = document.getElementById('reply-indicator');
        const profileScreen = document.getElementById('user-profile-screen');
        const reportScreen = document.getElementById('report-screen');
        const emojiBtn = document.getElementById('emoji-btn');
        const mediaPanel = document.getElementById('media-panel');
        const selectedMediaPreview = document.getElementById('selected-media-preview');
        
        // Global State Variables
        let currentUser = null;
        let currentUserData = null;
        let allData = {};
        let replyToMessage = null;
        let selectedMedia = null;
        let lastRenderedDate = null;
        let reportingUserId = null;
        let banInterval = null;
        let premiumTimerInterval = null;
        let isPremiumUser = false;
        let censoredWords = [];
        let currentAnnouncement = null;
        let cachedImageEmojis = {};

        // --- UPDATED: Footer State Flags ---
        let isUserBanned = false;
        let isChatLockedGlobal = false;
        let hasUnreadAnnouncement = false;

        // Prevent image context menu
        document.addEventListener('contextmenu', e => { if (e.target.tagName === 'IMG') e.preventDefault(); });

        // Fix viewport height on mobile
        function fixViewportHeight() {
            if (chatUI) chatUI.style.height = `${window.innerHeight}px`;
        }

        // =================================================================================
        // --- 2. AUTHENTICATION & DATA LOADING ---
        // =================================================================================

        auth.onAuthStateChanged(user => { 
            if (user) { 
                currentUser = user;
                fixViewportHeight();
                fetchAndCacheAllData().then(() => {
                    currentUserData = allData.users[currentUser.uid];
                    
                    setTimeout(() => { 
                        loadingScreen.classList.add('fade-out'); 
                        setTimeout(() => { 
                            loadingScreen.style.display = 'none'; 
                            chatUI.classList.remove('hidden'); 
                            chatUI.classList.add('flex', 'fade-in'); 
                        }, 500); 
                        initializeChatApplication(); 
                    }, 3000); 

                    database.ref('users/' + currentUser.uid).on('value', snapshot => {
                        const updatedUserData = snapshot.val();
                        if (updatedUserData) {
                            currentUserData = updatedUserData;
                            if (allData.users) allData.users[currentUser.uid] = updatedUserData;
                            checkPremiumStatus();
                            checkChatBan(); 
                        }
                    });
                }); 
            } else { 
                window.location.href = 'index.html'; 
            } 
        });
        
        async function fetchAndCacheAllData() {
             allData = (await database.ref().once('value')).val() || { users: {}, admin: {} }; 
        }

        // =================================================================================
        // --- 3. CORE CHAT APPLICATION LOGIC ---
        // =================================================================================

        function initializeChatApplication() {
            const userData = allData.users[currentUser.uid] || {};
            document.getElementById('header-username').textContent = userData.name || 'User';
            
            listenForAdminConfigChanges();
            startHeaderIconAnimationLoop();
            setupAllEventListeners();
            listenForMessages();
            listenForMyReports();
            checkChatBan();
            listenForMediaItems();
            listenForChatLock();
            listenForAnnouncements();
            checkPremiumStatus();
            listenForCensoredWords();
        }
        
        function listenForMessages() {
            let initialLoad = true;
            let lastKey = null;

            chatRef.limitToLast(50).once('value', snapshot => {
                messagesContainer.innerHTML = '';
                lastRenderedDate = null;
                snapshot.forEach(childSnapshot => {
                    lastKey = childSnapshot.key;
                    renderMessage(childSnapshot.key, childSnapshot.val());
                });
                setTimeout(() => {
                    scrollToBottom();
                    updateFooterState(); // Initial padding calculation
                }, 100);
                initialLoad = false;
            });

            // Listen for new messages
            chatRef.limitToLast(1).on('child_added', snapshot => {
                if (!initialLoad && snapshot.key !== lastKey) {
                    renderMessage(snapshot.key, snapshot.val());
                    lastKey = snapshot.key;
                }
            });

            // Listen for removed messages
            chatRef.on('child_removed', snapshot => {
                const messageId = snapshot.key;
                const messageElement = document.querySelector(`.message-container[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.closest('.message-group').remove();
                }
            });
            
            // Listen for changed/edited messages
            chatRef.on('child_changed', snapshot => {
                updateMessage(snapshot.key, snapshot.val());
            });
        }

        function updateMessage(messageId, msgData) {
            const messageContainer = document.querySelector(`.message-container[data-message-id="${messageId}"]`);
            if (!messageContainer) return;
            
            // Update text with inline emojis
            const textElement = messageContainer.querySelector('.message-text');
            if (textElement) {
                textElement.innerHTML = parseAndRenderInlineEmojis(msgData.text || '');
            }

            // Update edited tag
            const headerElement = messageContainer.querySelector('.message-header');
            if (headerElement) {
                let editedTag = headerElement.querySelector('.edited-tag');
                if (msgData.edited && !editedTag) {
                    editedTag = document.createElement('span');
                    editedTag.className = 'timestamp edited-tag';
                    editedTag.textContent = '(edited)';
                    headerElement.appendChild(editedTag);
                } else if (!msgData.edited && editedTag) {
                    editedTag.remove();
                }
            }
        }

        function parseAndRenderInlineEmojis(text) {
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return sanitizedText.replace(/::([\w-]+)::/g, (match, key) => {
                const emojiUrl = cachedImageEmojis[key];
                if (emojiUrl) {
                    return `<img src="${emojiUrl}" class="inline-image-emoji" alt="${key}">`;
                }
                return match; // Return the original text if emoji not found
            });
        }
        
        function renderMessage(messageId, msgData) {
            const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 150;
            
            let senderData;
            let isAdmin = false;
            let senderIsPremium = false;

            if (msgData.senderUid === 'admin_system') {
                const adminProfile = allData.admin?.profile || {};
                senderData = { 
                    name: adminProfile.name || 'Admin', 
                    avatar: adminProfile.avatar || 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed',
                    settings: adminProfile.settings || {}
                };
                isAdmin = true;
                senderIsPremium = true;
            } else {
                senderData = allData.users[msgData.senderUid] || {};
                isAdmin = senderData.role === 'admin';
                senderIsPremium = (senderData.premium && senderData.premium.expiresAt > Date.now()) || isAdmin;
            }
            
            const messageDate = new Date(msgData.timestamp);
            const messageDateString = messageDate.toDateString();
            if (lastRenderedDate !== messageDateString) {
                const separator = document.createElement('div');
                separator.className = 'date-separator';
                const separatorDate = messageDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                separator.innerHTML = `<hr><span>${separatorDate}</span><hr>`;
                messagesContainer.appendChild(separator);
                lastRenderedDate = messageDateString;
            }

            let replyHTML = '';
            if (msgData.replyTo) {
                let repliedToUserData;
                if (msgData.replyTo.authorUid === 'admin_system') {
                    const adminProfile = allData.admin?.profile || {};
                    repliedToUserData = { 
                        name: adminProfile.name || 'Admin', 
                        role: 'admin',
                        settings: adminProfile.settings || {}
                    };
                } else {
                    repliedToUserData = allData.users[msgData.replyTo.authorUid] || {};
                }

                const repliedToUserIsAdmin = repliedToUserData.role === 'admin';
                const repliedToUserIsPremium = (repliedToUserData.premium && repliedToUserData.premium.expiresAt > Date.now()) || repliedToUserIsAdmin;
                const repliedToSettings = repliedToUserData.settings || {};
                let boxClass = 'default', boxStyle = '', nameStyle = '';
                
                if (repliedToUserIsAdmin && repliedToSettings.replyColor) {
                    boxClass = 'premium';
                    const [r, g, b] = repliedToSettings.replyColor.match(/\d+/g);
                    boxStyle = `style="--reply-bg-color-start: rgba(${r},${g},${b},0.4); --reply-bg-color-mid: rgba(${r},${g},${b},0.25); --reply-bg-color-end: rgba(${r},${g},${b},0);"`;
                } else if (repliedToUserIsPremium && repliedToSettings.replyColor) {
                    boxClass = 'premium';
                    const [r, g, b] = repliedToSettings.replyColor.match(/\d+/g);
                    boxStyle = `style="--reply-bg-color-start: rgba(${r},${g},${b},0.4); --reply-bg-color-mid: rgba(${r},${g},${b},0.25); --reply-bg-color-end: rgba(${r},${g},${b},0);"`;
                }

                if (repliedToUserIsPremium && repliedToSettings.replyNameColor) {
                    nameStyle = `style="color: ${repliedToSettings.replyNameColor};"`;
                }
                replyHTML = `<div class="replied-message-block ${boxClass}" ${boxStyle} data-reply-to-id="${msgData.replyTo.id}"><i class="fas fa-reply reply-prefix-icon"></i><img src="${msgData.replyTo.authorAvatar}" class="replied-avatar"><span class="replied-username" ${nameStyle}>${msgData.replyTo.authorName}</span><span class="replied-text">${msgData.replyTo.text}</span></div>`;
            }

            const ts = new Date(msgData.timestamp).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            let frameHTML = '';
            if (senderData.equippedFrame && allData.admin?.config?.profileFrames?.[senderData.equippedFrame]) {
                const frameUrl = allData.admin.config.profileFrames[senderData.equippedFrame].url;
                frameHTML = `<img src="${frameUrl}" class="avatar-frame">`;
            }

            let badgeHTML = '';
            if (isAdmin) {
                const adminBadgeUrl = allData.admin?.profile?.badgeUrl || 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2Fbadges%2F1-removebg-preview.png?alt=media&token=c191a64f-6d2c-473d-83e7-130ca78964d4';
                badgeHTML += `<img src="${adminBadgeUrl}" class="profile-badge-chat" title="Admin">`;
            } else if (senderData.equippedProfileBadge && allData.admin?.config?.verifiedBadges?.[senderData.equippedProfileBadge]) {
                 const badge = allData.admin.config.verifiedBadges[senderData.equippedProfileBadge];
                if (badge.type === 'profile') {
                    badgeHTML = `<img src="${badge.url}" class="profile-badge-chat">`;
                }
            }
            
            const usernameStyle = (senderIsPremium && senderData.settings?.usernameColor) ? `style="color: ${senderData.settings.usernameColor}"` : '';
            const messageTextHTML = msgData.text ? `<div class="message-text">${parseAndRenderInlineEmojis(msgData.text)}</div>` : '';
            
            let messageMediaHTML = '';
            if (msgData.media) {
                let mediaClass = 'message-media';
                if (msgData.media.type === 'sticker') mediaClass += ' sticker';

                if (['image', 'gif', 'sticker'].includes(msgData.media.type)) { // image_emoji removed
                    messageMediaHTML = `<img src="${msgData.media.url}" class="${mediaClass}" alt="${msgData.media.type}">`;
                } else if (msgData.media.type === 'voice') {
                    const durationHTML = msgData.media.duration ? `<span class="text-xs text-gray-400 font-mono font-semibold">${msgData.media.duration}</span>` : '';
                    if (isAdmin) {
                        const voiceId = 'voice-' + messageId;
                        const playPauseFunction = `
                            const audio = document.getElementById('${voiceId}');
                            const icon = this.querySelector('i');
                            if (audio.paused) { audio.play(); } else { audio.pause(); }
                        `;
                        const onPlayFunction = `this.previousElementSibling.querySelector('i').className = 'fas fa-pause';`;
                        const onPauseFunction = `this.previousElementSibling.querySelector('i').className = 'fas fa-play';`;

                        messageMediaHTML = `
                        <div class="mt-2 p-2 rounded-lg flex items-center gap-3 w-full max-w-[250px]" style="background: linear-gradient(to right, rgba(138, 43, 226, 0.2), rgba(138, 43, 226, 0.05)); border: 1px solid rgba(138, 43, 226, 0.15);">
                            <button onclick="${playPauseFunction}" class="w-8 h-8 flex-shrink-0 bg-purple-500/50 rounded-full flex items-center justify-center text-white focus:outline-none transition-transform hover:scale-110"><i class="fas fa-play"></i></button>
                            <audio id="${voiceId}" src="${msgData.media.url}" preload="metadata" onplay="${onPlayFunction}" onpause="${onPauseFunction}" onended="${onPauseFunction}"></audio>
                            <div class="flex-grow bg-purple-400/20 h-1 rounded-full relative"></div>
                            ${durationHTML}
                        </div>`;
                    } else {
                         messageMediaHTML = `<div class="flex items-center gap-2 mt-2"><audio controls src="${msgData.media.url}" class="w-full max-w-[200px]"></audio>${durationHTML}</div>`;
                    }
                }
            }

            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            const authorName = senderData.name || 'User';
            const authorAvatar = senderData.avatar || 'https://via.placeholder.com/42';
            const containerClass = `message-container ${isAdmin ? 'admin-message' : ''}`;
            const hasOnlyMedia = msgData.media && !msgData.text;
            const editedTag = msgData.edited ? '<span class="timestamp edited-tag">(edited)</span>' : '';

            messageGroup.innerHTML = `
                ${replyHTML}
                <div class="reply-icon-container"><i class="fas fa-reply"></i></div>
                <div class="${containerClass}" data-message-id="${messageId}" data-author-uid="${msgData.senderUid}" data-author-name="${authorName}" data-author-avatar="${authorAvatar}" data-message-text="${msgData.text || ''}" data-timestamp="${msgData.timestamp}">
                    <div class="avatar-container" data-user-id="${msgData.senderUid}">
                        <img src="${authorAvatar}" alt="avatar" class="avatar">${frameHTML}
                    </div>
                    <div class="message-content-wrapper">
                        ${!hasOnlyMedia ? `<div class="message-header">
                            <span class="username" data-user-id="${msgData.senderUid}" ${usernameStyle}>${authorName}</span>${badgeHTML}<span class="timestamp">${ts}</span>${editedTag}
                        </div>` : ''}
                        ${messageTextHTML}
                        ${messageMediaHTML}
                    </div>
                </div>`;
            messagesContainer.appendChild(messageGroup);
            
            if (isScrolledToBottom) scrollToBottom();
        }

        async function sendMessage() {
            const maxChars = isPremiumUser ? 60 : 30;
            const text = messageInput.value.trim();
            if ((!text || text.length > maxChars) && !selectedMedia) return;

            if (text && containsCensoredWord(text)) {
                await applyCensorPunishment();
                return;
            }
            
            const messageData = { 
                senderUid: currentUser.uid, 
                text: text, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };
            if (replyToMessage) messageData.replyTo = replyToMessage;
            if (selectedMedia) messageData.media = selectedMedia;
            
            chatRef.push(messageData).then(() => {
                messageInput.value = '';
                cancelMediaSelection();
                messageInput.dispatchEvent(new Event('input')); 
                cancelReply();
            });
            typingRef.child(currentUser.uid).remove();
        }

        // --- UPDATED: ANNOUNCEMENT SYSTEM ---
        function listenForAnnouncements() {
            database.ref('admin/config/announcements/latest').on('value', snapshot => {
                currentAnnouncement = snapshot.val();
                checkAndDisplayAnnouncement();
            });
        }
        
        function checkAndDisplayAnnouncement() {
            const lastReadId = localStorage.getItem('lastReadAnnouncementId');
            hasUnreadAnnouncement = currentAnnouncement && currentAnnouncement.isActive && String(currentAnnouncement.id) !== lastReadId;
            
            const announcementOverlay = document.getElementById('fullscreen-announcement');

            if (hasUnreadAnnouncement) {
                const contentDiv = document.getElementById('announcement-content-scroll');
                let contentHTML = '<h3 class="text-lg font-bold text-yellow-300 mb-2 text-center font-oswald">📢 ঘোষণা</h3>';
                if (currentAnnouncement.text) {
                    contentHTML += `<p class="text-sm whitespace-pre-wrap">${currentAnnouncement.text}</p>`;
                }
                if (currentAnnouncement.imageUrl) {
                    contentHTML += `<img src="${currentAnnouncement.imageUrl}" class="w-full max-w-sm mx-auto rounded-lg mt-2">`;
                }
                if (currentAnnouncement.voiceUrl) {
                    contentHTML += `<audio controls src="${currentAnnouncement.voiceUrl}" class="w-full mt-2"></audio>`;
                }
                contentDiv.innerHTML = contentHTML;
                announcementOverlay.style.display = 'flex';
            } else {
                 announcementOverlay.style.display = 'none';
            }
            updateFooterState();
        }
        
        function setupAnnouncementListeners() {
            document.getElementById('ack-announcement-btn').addEventListener('click', () => {
                if (currentAnnouncement) {
                    localStorage.setItem('lastReadAnnouncementId', String(currentAnnouncement.id));
                    checkAndDisplayAnnouncement();
                    // --- FIX FOR LAYOUT BUG ---
                    setTimeout(() => {
                        fixViewportHeight(); // Recalculate viewport height
                        updateFooterState(); // Recalculate footer padding
                        scrollToBottom(true); // Scroll to bottom
                    }, 150); // A small delay to allow the DOM to update
                }
            });
        }
        
        // --- UPDATED: FOOTER LOGIC ---
        function updateFooterState() {
            const chatFooter = document.getElementById('chat-footer');
            const banIndicator = document.getElementById('ban-indicator');
            const lockIndicator = document.getElementById('lock-indicator');
            const announcementOverlay = document.getElementById('fullscreen-announcement');
            
            [chatFooter, banIndicator, lockIndicator].forEach(el => el.style.display = 'none');
            
            let activeFooter = null;

            if (announcementOverlay.style.display === 'flex') {
                activeFooter = null;
            } else if (isUserBanned) {
                activeFooter = banIndicator;
                banIndicator.style.display = 'flex';
            } else if (isChatLockedGlobal) {
                activeFooter = lockIndicator;
                lockIndicator.style.display = 'flex';
            } else {
                activeFooter = chatFooter;
                chatFooter.style.display = 'block';
            }

            if (messagesContainer) {
                messagesContainer.style.paddingBottom = (activeFooter ? activeFooter.offsetHeight : 0) + 'px';
            }
        }

        function listenForChatLock() {
            database.ref('admin/config/chatSettings/isLocked').on('value', snapshot => {
                const canBypass = currentUserData?.role === 'admin' || currentUserData?.role === 'moderator';
                isChatLockedGlobal = snapshot.val() && !canBypass;
                updateFooterState();
            });
        }
        
        function checkChatBan() {
            clearInterval(banInterval);
            const banInfo = currentUserData?.chatBan;
            isUserBanned = banInfo && banInfo.bannedUntil && (banInfo.bannedUntil === -1 || banInfo.bannedUntil > Date.now());
            
            if (isUserBanned) {
                const timerEl = document.getElementById('ban-timer');
                if (banInfo.bannedUntil === -1) {
                    timerEl.textContent = "PERMANENT";
                } else {
                    const updateTimer = () => {
                        const timeLeft = banInfo.bannedUntil - Date.now();
                        if (timeLeft <= 0) {
                            clearInterval(banInterval);
                            checkChatBan(); // Re-evaluate state
                            return;
                        }
                        const hours = Math.floor(timeLeft / 3600000);
                        const minutes = Math.floor((timeLeft % 3600000) / 60000);
                        const seconds = Math.floor((timeLeft % 60000) / 1000);
                        timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    };
                    updateTimer();
                    banInterval = setInterval(updateTimer, 1000);
                }
            }
            updateFooterState();
        }
        
        function setupAllEventListeners() {
            setupInputListeners();
            setupReplyListeners();
            setupSwipeToReply();
            setupReplyNavigation();
            setupScrollAndHeaderButton();
            setupPremiumSettings();
            setupPremiumPurchaseFlow();
            setupTypingIndicator();
            setupProfileScreenListeners();
            setupReportScreenListeners();
            setupMediaPanelEventListeners();
            setupAnnouncementListeners();
        }
        
        function setupInputListeners() {
            const charCounter = document.getElementById('char-counter');
            
            messageInput.addEventListener('input', () => {
                const maxChars = isPremiumUser ? 60 : 30;
                messageInput.maxLength = maxChars;
                const text = messageInput.value;
                const remaining = maxChars - text.length;
                charCounter.textContent = remaining;
                charCounter.className = '';
                if (remaining < 0) charCounter.classList.add('red');
                else if (remaining <= 10) charCounter.classList.add('yellow');
                else charCounter.classList.add('green');

                if ((text.trim().length > 0 || selectedMedia) && remaining >= 0) {
                    sendBtn.classList.add('ready-to-send');
                    sendBtn.disabled = false;
                } else {
                    sendBtn.classList.remove('ready-to-send');
                    sendBtn.disabled = true;
                }
                messageInput.style.height = 'auto';
                messageInput.style.height = `${Math.min(messageInput.scrollHeight, 120)}px`;
                updateFooterState();
            });
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        function setReply(messageEl) { 
            replyToMessage = { id: messageEl.dataset.messageId, authorUid: messageEl.dataset.authorUid, authorName: messageEl.dataset.authorName, authorAvatar: messageEl.dataset.authorAvatar, text: messageEl.dataset.messageText };
            document.getElementById('reply-username').textContent = replyToMessage.authorName;
            document.getElementById('reply-text').textContent = replyToMessage.text;
            replyIndicator.classList.remove('hidden'); 
            replyIndicator.classList.add('flex');
            selectedMediaPreview.classList.add('hidden'); 
            messageInput.focus();
        }

        function cancelReply() { 
            replyToMessage = null; 
            replyIndicator.classList.add('hidden'); 
            replyIndicator.classList.remove('flex'); 
        }

        function setupReplyListeners() { 
            document.getElementById('cancel-reply-btn').addEventListener('click', cancelReply); 
        }

        function setupSwipeToReply() {
            let isDragging = false, startX = 0, deltaX = 0, draggedElement = null, iconElement = null;
            const swipeThreshold = -60, maxSwipe = -70;
            const getEventX = e => e.touches ? e.touches[0].clientX : e.clientX;
            const onDragStart = (e) => {
                const target = e.target.closest('.message-container');
                if (!target) return;
                draggedElement = target;
                iconElement = target.previousElementSibling;
                startX = getEventX(e);
                isDragging = true;
                draggedElement.style.transition = 'none';
            };
            const onDragMove = (e) => {
                if (!isDragging || !draggedElement) return;
                deltaX = getEventX(e) - startX;
                if (deltaX > 0) deltaX = 0;
                if (deltaX < maxSwipe) deltaX = maxSwipe;
                draggedElement.style.transform = `translateX(${deltaX}px)`;
                iconElement.style.opacity = (Math.abs(deltaX) / Math.abs(maxSwipe));
            };
            const onDragEnd = () => {
                if (!isDragging || !draggedElement) return;
                isDragging = false;
                draggedElement.style.transition = 'transform 0.2s ease-out';
                draggedElement.style.transform = 'translateX(0px)';
                iconElement.style.opacity = 0;
                if (deltaX <= swipeThreshold) setReply(draggedElement);
                draggedElement = null;
                deltaX = 0;
            };
            messagesContainer.addEventListener('mousedown', onDragStart);
            messagesContainer.addEventListener('touchstart', onDragStart, { passive: true });
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('touchmove', onDragMove, { passive: true });
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchend', onDragEnd);
        }

        function setupReplyNavigation() {
            messagesContainer.addEventListener('click', e => {
                const replyBox = e.target.closest('.replied-message-block');
                if (!replyBox) return;
                const targetId = replyBox.dataset.replyToId;
                const targetMessage = document.querySelector(`.message-container[data-message-id="${targetId}"]`);
                if (targetMessage) {
                    targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetMessage.classList.add('highlight');
                    setTimeout(() => targetMessage.classList.remove('highlight'), 2000);
                }
            });
        }
        
        function setupScrollAndHeaderButton() {
            const headerBackBtn = document.getElementById('header-back-btn');
            if (!headerBackBtn) return;

            messagesContainer.addEventListener('scroll', () => {
                const isScrolledUp = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight > 200;
                headerBackBtn.classList.toggle('show-scroll-down', isScrolledUp);
            });

            headerBackBtn.addEventListener('click', () => {
                if (headerBackBtn.classList.contains('show-scroll-down')) {
                    scrollToBottom(true);
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        function startHeaderIconAnimationLoop() {
            const icon = document.getElementById('header-discord-icon');
            const triggerAnimation = () => {
                icon.style.animation = 'none';
                void icon.offsetWidth;
                icon.style.animation = 'header-icon-dance 2.5s ease-in-out';
            };
            setTimeout(triggerAnimation, 1000);
            setInterval(triggerAnimation, 13000);
        }
        
        function setupTypingIndicator() {
            const typingIndicatorEl = document.getElementById('typing-indicator');
            let typingTimeout;
            messageInput.addEventListener('input', () => {
                if (messageInput.value.trim().length > 0) {
                    typingRef.child(currentUser.uid).set(firebase.database.ServerValue.TIMESTAMP);
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => { typingRef.child(currentUser.uid).remove(); }, 3000);
                } else {
                    clearTimeout(typingTimeout);
                    typingRef.child(currentUser.uid).remove();
                }
            });

            typingRef.on('value', (snapshot) => {
                const typingUsers = snapshot.val() || {};
                const now = Date.now();
                
                const activeTypingUsers = Object.keys(typingUsers)
                    .filter(uid => (now - typingUsers[uid] < 5000) && uid !== currentUser.uid);

                const count = activeTypingUsers.length;

                if (count > 0) {
                    const maxAvatars = 4;
                    const usersToShow = activeTypingUsers.slice(0, maxAvatars);
                    
                    const avatarsHTML = usersToShow.map(uid => {
                        const userData = allData.users[uid] || {};
                        const avatarSrc = userData.avatar || 'https://via.placeholder.com/42';
                        return `<img src="${avatarSrc}" class="typing-avatar">`;
                    }).join('');

                    let plusBadgeHTML = '';
                    if (count > maxAvatars) {
                        const remainingCount = count - maxAvatars;
                        plusBadgeHTML = `<div class="typing-plus-badge">+${remainingCount}</div>`;
                    }
                    
                    const indicatorHTML = `
                        <div class="typing-avatar-stack">
                            ${avatarsHTML}
                            ${plusBadgeHTML}
                        </div>
                        <span class="typing-text">typing...</span>`;

                    typingIndicatorEl.innerHTML = indicatorHTML;
                    typingIndicatorEl.classList.remove('hidden');
                    typingIndicatorEl.style.opacity = '1';

                } else {
                    typingIndicatorEl.style.opacity = '0';
                    setTimeout(() => { typingIndicatorEl.classList.add('hidden'); }, 300);
                }
            });
        }
        
        function cancelMediaSelection() {
            selectedMedia = null;
            selectedMediaPreview.classList.add('hidden');
            selectedMediaPreview.classList.remove('flex');
            messageInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function setupMediaPanelEventListeners() {
            const closeBtn = document.getElementById('close-media-panel-btn');
            const tabs = document.querySelectorAll('.media-tab');
            const contentAreas = document.querySelectorAll('.media-tab-content');
            const panelContainer = mediaPanel.querySelector('.overflow-y-auto');
            const emojiIcon = emojiBtn.querySelector('i');

            const setIconState = (isOpen) => {
                emojiIcon.className = isOpen ? 'far fa-laugh-beam text-yellow-300' : 'far fa-smile';
            };

            const closePanel = () => {
                mediaPanel.classList.remove('show');
                setIconState(false);
                document.body.removeEventListener('click', closePanelOnClickOutside);
            };
            
            const openPanel = () => {
                mediaPanel.classList.add('show');
                setIconState(true);
                setTimeout(() => {
                    scrollToBottom(true);
                    document.body.addEventListener('click', closePanelOnClickOutside);
                }, 50); 
            };
            
            const togglePanel = () => {
                mediaPanel.classList.contains('show') ? closePanel() : openPanel();
            };

            const closePanelOnClickOutside = (e) => {
                const isClickInsidePanel = mediaPanel.contains(e.target);
                const isClickOnEmojiBtn = emojiBtn.contains(e.target);
                if (!isClickInsidePanel && !isClickOnEmojiBtn) {
                    closePanel();
                }
            };
            
            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                togglePanel();
            });
            closeBtn.addEventListener('click', closePanel);

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    tab.classList.add('active-tab');
                    contentAreas.forEach(area => {
                        area.classList.toggle('hidden', area.id !== `media-tab-content-${tabName}`);
                    });
                });
            });

            panelContainer.addEventListener('click', e => {
                const item = e.target.closest('.media-item');
                if (!item) return;

                if (!isPremiumUser) {
                    closePanel();
                    showSubscriptionScreen();
                    return;
                }

                const { type, value } = item.dataset;
                if (type === 'emoji') {
                    messageInput.value += value;
                    messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                    messageInput.focus();
                } 
                // --- FIX FOR MEDIA CODE ---
                else if (type === 'inline_image_emoji') {
                    const emojiKey = value;
                    const emojiUrl = cachedImageEmojis[emojiKey];
                    if (emojiUrl) {
                        selectedMedia = { type: 'sticker', url: emojiUrl }; // Treat it as a sticker for sending
                        document.getElementById('selected-media-img').src = emojiUrl;
                        document.getElementById('selected-media-text').textContent = `Sticker Attached`;
                        selectedMediaPreview.classList.remove('hidden');
                        selectedMediaPreview.classList.add('flex');
                        messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                        closePanel();
                        messageInput.focus();
                    }
                } else if (type === 'sticker' || type === 'gif') {
                    selectedMedia = { type: type, url: value };
                    document.getElementById('selected-media-img').src = value;
                    document.getElementById('selected-media-text').textContent = `${type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())} Attached`;
                    selectedMediaPreview.classList.remove('hidden');
                    selectedMediaPreview.classList.add('flex');
                    messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                    closePanel();
                    messageInput.focus();
                }
            });
            document.getElementById('cancel-media-btn').addEventListener('click', cancelMediaSelection);
        }

        function listenForMediaItems() {
            const mediaDbRef = database.ref('admin/config/media');
            const emojiGrid = document.getElementById('emoji-grid');
            const stickerGrid = document.getElementById('sticker-grid');
            const gifGrid = document.getElementById('gif-grid');

            const loadingHTML = `<div class="media-loader col-span-full"><div class="spinner"></div><p>Loading...</p></div>`;
            emojiGrid.innerHTML = loadingHTML;
            stickerGrid.innerHTML = loadingHTML;
            gifGrid.innerHTML = loadingHTML;

            mediaDbRef.on('value', snapshot => {
                const allMedia = snapshot.val() || {};
                cachedImageEmojis = {}; // Reset cache
                const enabledMedia = Object.entries(allMedia).filter(([, item]) => item.enabled);

                const emojis = enabledMedia.filter(([, i]) => i.type === 'emoji' || i.type === 'image_emoji');
                const stickers = enabledMedia.filter(([, i]) => i.type === 'sticker');
                const gifs = enabledMedia.filter(([, i]) => i.type === 'gif');

                emojis.forEach(([key, item]) => {
                    if (item.type === 'image_emoji') {
                        cachedImageEmojis[key] = item.url;
                    }
                });

                const emptyHTML = (type) => `<div class="media-loader col-span-full"><p>No ${type} available.</p></div>`;
                const lockIconHTML = `<div class="media-lock-icon hidden"><i class="fas fa-lock"></i></div>`;
                
                emojiGrid.innerHTML = emojis.length > 0 
                    ? emojis.map(([key, item]) => {
                        if (item.type === 'image_emoji') {
                            return `<div class="media-item" data-type="inline_image_emoji" data-value="${key}"><img src="${item.url}" alt="emoji">${lockIconHTML}</div>`;
                        }
                        return `<div class="media-item" data-type="emoji" data-value="${item.char}"><span>${item.char}</span>${lockIconHTML}</div>`;
                    }).join('')
                    : emptyHTML('emojis');

                stickerGrid.innerHTML = stickers.length > 0 
                    ? stickers.map(([,item]) => `<div class="media-item" data-type="sticker" data-value="${item.url}"><img src="${item.url}" alt="sticker">${lockIconHTML}</div>`).join('')
                    : emptyHTML('stickers');

                gifGrid.innerHTML = gifs.length > 0 
                    ? gifs.map(([,item]) => `<div class="media-item" data-type="gif" data-value="${item.url}"><img src="${item.url}" alt="gif">${lockIconHTML}</div>`).join('')
                    : emptyHTML('GIFs');
                
                updateUIAfterPremiumCheck();
            }, (error) => {
                console.error("Firebase media read failed: ", error);
                const errorHTML = `<div class="media-loader col-span-full"><p>Error loading media.</p></div>`;
                emojiGrid.innerHTML = errorHTML;
                stickerGrid.innerHTML = errorHTML;
                gifGrid.innerHTML = errorHTML;
            });
        }

        function setupPremiumSettings() {
            const modal = document.getElementById('premium-settings-modal');
            const openBtn = document.getElementById('open-premium-settings-btn');
            const closeBtn = document.getElementById('close-premium-settings-btn');
            const actionBtn = document.getElementById('premium-action-btn');
            
            const usernameColorPicker = document.getElementById('username-color-picker');
            const boxColorPicker = document.getElementById('reply-box-color-picker');
            const nameColorPicker = document.getElementById('reply-name-color-picker');
            
            const previewUsername = document.getElementById('settings-username-preview');
            const previewBox = document.getElementById('settings-reply-preview').querySelector('.replied-message-block');
            const previewReplyName = document.getElementById('settings-reply-username-preview');

            const colors = ['rgb(255, 82, 82)', 'rgb(255, 128, 0)', 'rgb(255, 215, 0)', 'rgb(50, 205, 50)', 'rgb(0, 191, 255)', 'rgb(65, 105, 225)', 'rgb(138, 43, 226)', 'rgb(255, 20, 147)', 'rgb(233, 233, 233)', 'rgb(139, 69, 19)'];
            let tempUsernameColor = null, tempReplyBoxColor = null, tempReplyNameColor = null;

            const updatePreview = () => {
                previewUsername.style.color = tempUsernameColor || '#ffffff';
                if (tempReplyBoxColor) {
                    const [r,g,b] = tempReplyBoxColor.match(/\d+/g);
                    previewBox.style.setProperty('--reply-bg-color-start', `rgba(${r},${g},${b},0.4)`);
                    previewBox.style.setProperty('--reply-bg-color-mid', `rgba(${r},${g},${b},0.25)`);
                    previewBox.style.setProperty('--reply-bg-color-end', `rgba(${r},${g},${b},0)`);
                } else {
                    previewBox.style.removeProperty('--reply-bg-color-start');
                    previewBox.style.removeProperty('--reply-bg-color-mid');
                    previewBox.style.removeProperty('--reply-bg-color-end');
                }
                previewReplyName.style.color = tempReplyNameColor || '#ffffff';
            };

            const createSwatches = (container, onSelect) => {
                container.innerHTML = '';
                colors.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.backgroundColor = color;
                    swatch.dataset.color = color;
                    swatch.addEventListener('click', () => onSelect(swatch));
                    container.appendChild(swatch);
                });
            };

            const selectSwatch = (container, selectedColor) => {
                container.querySelectorAll('.color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === selectedColor));
            };
            
            createSwatches(usernameColorPicker, (s) => { tempUsernameColor = s.dataset.color; selectSwatch(usernameColorPicker, tempUsernameColor); updatePreview(); });
            createSwatches(boxColorPicker, (s) => { tempReplyBoxColor = s.dataset.color; selectSwatch(boxColorPicker, tempReplyBoxColor); updatePreview(); });
            createSwatches(nameColorPicker, (s) => { tempReplyNameColor = s.dataset.color; selectSwatch(nameColorPicker, tempReplyNameColor); updatePreview(); });

            openBtn.addEventListener('click', () => {
                const userSettings = (allData.users[currentUser.uid] || {}).settings || {};
                tempUsernameColor = userSettings.usernameColor || null;
                tempReplyBoxColor = userSettings.replyColor || null;
                tempReplyNameColor = userSettings.replyNameColor || null;
                selectSwatch(usernameColorPicker, tempUsernameColor);
                selectSwatch(boxColorPicker, tempReplyBoxColor);
                selectSwatch(nameColorPicker, tempReplyNameColor);
                updateUIAfterPremiumCheck();
                updatePreview();
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });

            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });

            actionBtn.addEventListener('click', () => {
                if (isPremiumUser) {
                    const settings = { 
                        usernameColor: tempUsernameColor,
                        replyColor: tempReplyBoxColor, 
                        replyNameColor: tempReplyNameColor 
                    };
                    database.ref('users/' + currentUser.uid + '/settings').update(settings).then(() => {
                        if (!allData.users[currentUser.uid]) allData.users[currentUser.uid] = {};
                        allData.users[currentUser.uid].settings = settings;
                        alert('Settings saved successfully!');
                        closeBtn.click();
                    }).catch(err => alert('Error saving settings: ' + err.message));
                } else {
                    closeBtn.click();
                    showSubscriptionScreen();
                }
            });
        }
        
        function setupProfileScreenListeners() {
            messagesContainer.addEventListener('click', e => {
                const target = e.target.closest('[data-user-id]');
                if (target) {
                    const userId = target.dataset.userId;
                    if (userId) showUserProfile(userId);
                }
            });
            document.getElementById('close-profile-btn').addEventListener('click', hideUserProfile);
        }

        function showUserProfile(userId) {
            const user = allData.users[userId];
            if (!user) return;
            reportingUserId = userId;
            renderChatProfile(user, userId);
            profileScreen.classList.add('show');
            document.getElementById('report-user-btn').style.display = userId === currentUser.uid ? 'none' : 'flex';
        }

        function hideUserProfile() {
            profileScreen.classList.remove('show');
        }

        function renderChatProfile(user, userId) {
            const DEFAULT_BANNER = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F2e8e97546eae310a4edfaa46874232ef.jpg?alt=media&token=3f5dd29a-24d8-4aec-80e6-11504b80bdf7"; 
            let badgeHTML = ''; if (user.equippedProfileBadge && allData.admin?.config?.verifiedBadges?.[user.equippedProfileBadge]) { const badge = allData.admin.config.verifiedBadges[user.equippedProfileBadge]; if(badge.type === 'profile') { badgeHTML = `<img src="${badge.url}" class="profile-badge-view">`; } } 
            const usernameContainer = document.getElementById('chat-profile-username-container'); 
            let myProfileTag = userId === currentUser.uid ? `<span class="text-sm font-semibold text-gray-400 ml-2">(My Profile)</span>` : ''; 
            usernameContainer.innerHTML = `<h2 id="chat-profile-username" class="text-3xl font-bold font-oswald inline">${user.name || 'User'}</h2>${badgeHTML}${myProfileTag}`; 
            document.getElementById('chat-profile-avatar').src = user.avatar || 'https://via.placeholder.com/42'; 
            
            const bannerMedia = document.getElementById('chat-profile-banner-media');
            let bannerSet = false;

            if (user.equippedEffect && allData.admin?.config?.profileEffects?.[user.equippedEffect]) {
                const effect = allData.admin.config.profileEffects[user.equippedEffect];
                bannerMedia.innerHTML = `<video src="${effect.url}" autoplay loop muted playsinline></video>`;
                bannerSet = true;
            } 
            
            if (!bannerSet) {
                const defaultBanners = allData.admin?.config?.defaultBanners || {};
                const bannerUrls = Object.values(defaultBanners).map(b => b.url).filter(Boolean);
                if (bannerUrls.length > 0) {
                    const randomUrl = bannerUrls[Math.floor(Math.random() * bannerUrls.length)];
                    if (randomUrl.endsWith('.mp4') || randomUrl.endsWith('.webm')) {
                        bannerMedia.innerHTML = `<video src="${randomUrl}" autoplay loop muted playsinline></video>`;
                    } else {
                        bannerMedia.innerHTML = `<img src="${randomUrl}" alt="Default Banner">`;
                    }
                } else {
                     bannerMedia.innerHTML = `<img src="${DEFAULT_BANNER}" alt="Default Banner">`;
                }
            }

            const avatarFrame = document.getElementById('chat-profile-avatar-frame'); 
            avatarFrame.classList.add('hidden'); 
            if (user.equippedFrame && allData.admin?.config?.profileFrames?.[user.equippedFrame]) { avatarFrame.src = allData.admin.config.profileFrames[user.equippedFrame].url; avatarFrame.classList.remove('hidden'); } 
            const followersCount = user.followersCount || 0; 
            const followingCount = user.followingCount || 0; 
            document.getElementById('chat-profile-follow-stats').innerHTML = `<div class="text-center"><p class="text-3xl font-bold font-oswald">${followersCount}</p><p class="text-xs text-gray-400 uppercase tracking-wider">Followers</p></div><div class="w-px h-8 bg-gray-700"></div><div class="text-center"><p class="text-3xl font-bold font-oswald">${followingCount}</p><p class="text-xs text-gray-400 uppercase tracking-wider">Following</p></div>`; 
            const followBtn = document.getElementById('follow-toggle-btn'); 
            followBtn.dataset.targetUid = userId; followBtn.onclick = () => handleFollowToggle(userId); 
            if (userId === currentUser.uid) { followBtn.style.display = 'none'; } else { followBtn.style.display = 'block'; const isFollowing = currentUserData.following && currentUserData.following[userId]; if (isFollowing) { followBtn.textContent = 'Unfollow'; followBtn.className = 'w-full py-3 rounded-lg text-sm unfollow-button'; } else { followBtn.textContent = 'Follow'; followBtn.className = 'w-full py-3 rounded-lg text-sm follow-button'; } } 
            renderChatProfileBadges(user); renderChatProfileTitles(user); renderChatProfileTeam(user);
        }

        async function handleFollowToggle(targetUserId) {
            const followBtn = document.getElementById('follow-toggle-btn');
            followBtn.disabled = true;
            const isCurrentlyFollowing = currentUserData.following && currentUserData.following[targetUserId];
            const updates = {};
            if (isCurrentlyFollowing) {
                updates[`/users/${currentUser.uid}/following/${targetUserId}`] = null;
                updates[`/users/${targetUserId}/followers/${currentUser.uid}`] = null;
                updates[`/users/${currentUser.uid}/followingCount`] = firebase.database.ServerValue.increment(-1);
                updates[`/users/${targetUserId}/followersCount`] = firebase.database.ServerValue.increment(-1);
            } else {
                updates[`/users/${currentUser.uid}/following/${targetUserId}`] = true;
                updates[`/users/${targetUserId}/followers/${currentUser.uid}`] = true;
                updates[`/users/${currentUser.uid}/followingCount`] = firebase.database.ServerValue.increment(1);
                updates[`/users/${targetUserId}/followersCount`] = firebase.database.ServerValue.increment(1);
            }
            try {
                await database.ref().update(updates);
                await fetchAndCacheAllData();
                currentUserData = allData.users[currentUser.uid];
                renderChatProfile(allData.users[targetUserId], targetUserId);
            } catch (error) {
                console.error("Follow/Unfollow failed:", error);
                alert("An error occurred. Please try again.");
            } finally {
                followBtn.disabled = false;
            }
        }
        
        function renderChatProfileBadges(user) { const section = document.getElementById('profile-badges-section'); const container = document.getElementById('chat-profile-badges-container'); const allDbBadges = allData.admin?.config?.verifiedBadges || {}; const equippedBadges = (user.equippedBadges || []).filter(id => id && allDbBadges[id]); if (equippedBadges.length === 0) { section.style.display = 'none'; return; } section.style.display = 'block'; container.innerHTML = equippedBadges.map(id => { const badge = allDbBadges[id]; const mediaTag = badge.type === 'video' ? 'video' : 'img'; return `<div class="badge-slot"><${mediaTag} src="${badge.url}" alt="badge" ${mediaTag === 'video' ? 'autoplay loop muted playsinline' : ''}></${mediaTag}></div>`; }).join(''); }
        function renderChatProfileTitles(user) { const section = document.getElementById('profile-titles-section'); const container = document.getElementById('chat-profile-titles-grid'); const allDbTitles = allData.admin?.config?.titles || {}; const equippedTitles = (user.equippedTitles || []).filter(id => id && allDbTitles[id]); if (equippedTitles.length === 0) { section.style.display = 'none'; return; } section.style.display = 'block'; container.innerHTML = equippedTitles.map(id => { const title = allDbTitles[id]; return `<div class="title-slot"><img src="${title.url}" alt="title"></div>`; }).join(''); }
        function renderChatProfileTeam(user) { const section = document.getElementById('profile-team-section'); const container = document.getElementById('chat-profile-team-container'); const team = user.team; if (!team) { section.style.display = 'none'; return; } section.style.display = 'block'; const rankScore = team.rankScore || 0; const teamUID = team.teamUid ? `@${team.teamUid}` : `Joined: ${new Date(team.id).toLocaleDateString()}`; container.innerHTML = ` <div id="chat-my-team-card" class="mt-3 flex items-center justify-between gap-4"> <div class="flex items-center gap-4 flex-1 min-w-0"> <img src="${team.logo || 'https://via.placeholder.com/56'}" class="team-logo"> <div class="flex-1 min-w-0"> <p class="font-bold text-lg truncate">${team.name}</p> <p class="text-xs text-gray-500">${teamUID}</p> </div> </div> <div class="text-center flex-shrink-0"> <div class="flex items-center"> <p class="rank-score">${rankScore}</p> <div class="rank-change-arrows"><i class="fa-solid fa-caret-up text-green-500"></i><i class="fa-solid fa-caret-down text-red-500"></i></div> </div> <p class="text-xs text-gray-400 uppercase tracking-wider">Rank Score</p> </div> </div>`; }

        function setupReportScreenListeners() {
            document.getElementById('report-user-btn').addEventListener('click', showReportScreen);
            document.getElementById('close-report-btn').addEventListener('click', hideReportScreen);
            document.getElementById('report-form').addEventListener('submit', (e) => {
                e.preventDefault();
                submitReport();
            });
        }

        function showReportScreen() {
            const user = allData.users[reportingUserId];
            if (!user) return;
            document.getElementById('reported-username').textContent = user.name || 'this user';
            reportScreen.classList.add('show');
        }

        function hideReportScreen() {
            reportScreen.classList.remove('show');
        }

        async function submitReport() {
            const submitBtn = document.querySelector('#report-form button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Submitting...';
            try {
                const reason = document.getElementById('report-reason').value;
                const details = document.getElementById('report-details').value.trim();
                const videoLink = document.getElementById('report-video-link').value.trim();
                const imageFile = document.getElementById('report-image').files[0];
                if (!details) {
                    alert('Please provide details for the report.');
                    throw new Error("Details are required.");
                }
                let imageUrl = null;
                if (imageFile) {
                    const storageRef = storage.ref();
                    const imagePath = `report_images/${currentUser.uid}_${Date.now()}_${imageFile.name}`;
                    const imageRef = storageRef.child(imagePath);
                    await imageRef.put(imageFile);
                    imageUrl = await imageRef.getDownloadURL();
                }
                const reportData = { reporterUid: currentUser.uid, reportedUid: reportingUserId, reason: reason, details: details, videoLink: videoLink || null, imageUrl: imageUrl || null, timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'Pending' };
                const newReport = await database.ref('reports').push(reportData);
                const reportId = newReport.key;
                await database.ref(`userReports/${currentUser.uid}/${reportId}`).set(true);
                alert('Report submitted successfully. Our team will review it shortly.');
                hideReportScreen();
                document.getElementById('report-form').reset();
            } catch (error) {
                console.error("Report submission failed:", error);
                alert("Failed to submit report. Please try again.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Report';
            }
        }

        const myReportsData = {};
        function listenForMyReports() {
            const userReportsRef = database.ref('userReports/' + currentUser.uid);
            userReportsRef.on('child_added', (snapshot) => {
                const reportId = snapshot.key;
                const reportRef = database.ref('reports/' + reportId);
                reportRef.on('value', (reportSnap) => {
                    if(reportSnap.exists()) {
                        myReportsData[reportId] = reportSnap.val();
                        renderMyReports();
                    }
                });
            });
            userReportsRef.on('child_removed', (snapshot) => {
                const reportId = snapshot.key;
                delete myReportsData[reportId];
                database.ref('reports/' + reportId).off();
                renderMyReports();
            });
        }

        function renderMyReports() {
            const container = document.getElementById('my-reports-container');
            const reportsArray = Object.entries(myReportsData).sort(([,a], [,b]) => b.timestamp - a.timestamp);

            if (reportsArray.length === 0) {
                container.innerHTML = `<div class="text-center py-4"><p class="text-sm text-gray-500">You haven't submitted any reports.</p></div>`;
                return;
            }

            const statusColors = { Pending: 'text-yellow-400', Seen: 'text-blue-400', Solved: 'text-green-400' };
            container.innerHTML = reportsArray.map(([reportId, report]) => {
                const reportedUser = allData.users[report.reportedUid] || { name: 'Unknown User' };
                const status = report.status || 'Pending';
                
                return `
                <div class="bg-[#1e1e1e] p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold">Report vs <span class="text-red-400">${reportedUser.name}</span></p>
                        <p class="text-sm ${statusColors[status]}">Status: ${status}</p>
                    </div>
                    <p class="text-xs text-gray-500">${new Date(report.timestamp).toLocaleDateString()}</p>
                </div>`;
            }).join('');
        }
        
        function checkPremiumStatus() {
            const premiumInfo = currentUserData?.premium;
            isPremiumUser = premiumInfo && premiumInfo.expiresAt && premiumInfo.expiresAt > Date.now();
            updateUIAfterPremiumCheck();
        }
        
        function listenForAdminConfigChanges() {
            adminConfigRef.on('value', snapshot => {
                const newConfig = snapshot.val();
                if (newConfig) {
                    allData.admin.config = newConfig; 
                    updateUIAfterPremiumCheck(); 
                }
            });
        }
        
        function listenForCensoredWords() {
            database.ref('admin/config/censoredWords').on('value', snapshot => {
                const wordsObject = snapshot.val() || {};
                censoredWords = Object.values(wordsObject).map(word => word.toLowerCase());
            });
        }

        function containsCensoredWord(message) {
            const lowerCaseMessage = message.toLowerCase();
            return censoredWords.some(word => lowerCaseMessage.includes(word));
        }

        async function applyCensorPunishment() {
            const userRef = database.ref(`users/${currentUser.uid}`);
            let newInfractionCount = 1;

            const snapshot = await userRef.child('censorInfractions/count').once('value');
            if(snapshot.exists()) {
                newInfractionCount = snapshot.val() + 1;
            }

            let banDurationMs = 0;
            let banLiftTimestamp = null;
            let alertMessage = "";

            switch (newInfractionCount) {
                case 1:
                    banDurationMs = 3 * 60 * 1000; // 3 minutes
                    alertMessage = "First Warning: Use of inappropriate language is not allowed. You have been timed out for 3 minutes.";
                    break;
                case 2:
                    banDurationMs = 10 * 60 * 1000; // 10 minutes
                    alertMessage = "Second Warning: You have been timed out for 10 minutes.";
                    break;
                case 3:
                    banDurationMs = 24 * 60 * 60 * 1000; // 1 day
                    alertMessage = "Final Warning: You have been banned from chat for 1 day.";
                    break;
                default:
                    banLiftTimestamp = -1; // Permanent ban
                    alertMessage = "You have been permanently banned from the chat for repeated violations.";
                    break;
            }

            if(banDurationMs > 0) {
                banLiftTimestamp = Date.now() + banDurationMs;
            }

            try {
                await userRef.update({
                    'censorInfractions/count': newInfractionCount,
                    'chatBan/bannedUntil': banLiftTimestamp
                });
                alert(alertMessage);
            } catch (error) {
                console.error("Failed to apply punishment:", error);
                alert("An error occurred while processing your message.");
            }
        }

        function updateUIAfterPremiumCheck() {
            const premiumBtn = document.getElementById('premium-action-btn');
            const chatSettings = allData.admin?.config?.chatSettings || {};
            const price = chatSettings.premiumDiscountPrice || chatSettings.premiumPrice || 75;
            
            const timerContainer = document.getElementById('premium-timer-container');
            const timerEl = document.getElementById('premium-timer');

            clearInterval(premiumTimerInterval);

            messageInput.dispatchEvent(new Event('input'));

            if (isPremiumUser) {
                premiumBtn.textContent = 'Save Settings';
                premiumBtn.classList.remove('action-button-premium');
                premiumBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                timerContainer.classList.remove('hidden');
                const updateTimer = () => {
                    const timeLeft = (currentUserData.premium.expiresAt || 0) - Date.now();
                    if (timeLeft <= 0) {
                        timerEl.textContent = "Your premium has expired.";
                        clearInterval(premiumTimerInterval);
                        return;
                    }
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    timerEl.textContent = `Expires in: ${days}d ${hours}h ${minutes}m`;
                };
                updateTimer();
                premiumTimerInterval = setInterval(updateTimer, 60000); // Update every minute

            } else {
                premiumBtn.textContent = `Buy Premium (${price} TK)`;
                premiumBtn.classList.add('action-button-premium');
                premiumBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                timerContainer.classList.add('hidden');
            }
            
            updateSubscriptionScreenPrices();

            document.querySelectorAll('.media-lock-icon').forEach(overlay => {
                overlay.classList.toggle('hidden', isPremiumUser);
            });
        }

        function setupPremiumPurchaseFlow() {
            const subScreen = document.getElementById('subscription-details-screen');
            const buyPanel = document.getElementById('one-tap-buy-panel');

            document.getElementById('buy-subscription-btn').addEventListener('click', showOneTapBuyPanel);
            document.getElementById('close-subscription-screen-btn').addEventListener('click', () => subScreen.classList.remove('show'));
            document.getElementById('close-buy-panel-btn').addEventListener('click', () => buyPanel.classList.remove('show'));
            document.getElementById('one-tap-buy-btn').addEventListener('click', executePurchase);
        }

        function updateSubscriptionScreenPrices() {
            const chatSettings = allData.admin?.config?.chatSettings || {};
            const price = chatSettings.premiumPrice || 75;
            const discountPrice = chatSettings.premiumDiscountPrice;
            const originalPriceEl = document.getElementById('premium-original-price');
            const displayPriceEl = document.getElementById('premium-price-display');

            if (discountPrice && discountPrice < price) {
                displayPriceEl.textContent = discountPrice;
                originalPriceEl.textContent = `${price} TK`;
                originalPriceEl.classList.remove('hidden');
            } else {
                displayPriceEl.textContent = price;
                originalPriceEl.classList.add('hidden');
            }
        }

        function showSubscriptionScreen() {
            const subScreen = document.getElementById('subscription-details-screen');
            updateSubscriptionScreenPrices(); 
            subScreen.classList.add('show');
        }

        function showOneTapBuyPanel() {
            const subScreen = document.getElementById('subscription-details-screen');
            const buyPanel = document.getElementById('one-tap-buy-panel');
            const chatSettings = allData.admin?.config?.chatSettings || {};
            const price = chatSettings.premiumDiscountPrice || chatSettings.premiumPrice || 75;
            
            document.getElementById('buy-panel-balance').textContent = `${(currentUserData.wallet?.live || 0).toFixed(2)} TK`;
            document.getElementById('buy-panel-price').textContent = `${price.toFixed(2)} TK`;
            
            subScreen.classList.remove('show');
            buyPanel.classList.add('show');
        }

        async function executePurchase() {
            const buyPanel = document.getElementById('one-tap-buy-panel');
            const loadingOverlay = document.getElementById('purchase-loading-overlay');
            
            buyPanel.classList.remove('show');
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');

            const chatSettings = allData.admin?.config?.chatSettings || {};
            const price = chatSettings.premiumDiscountPrice || chatSettings.premiumPrice || 75;
            const currentBalance = currentUserData.wallet?.live || 0;

            if (currentBalance < price) {
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                    alert('Insufficient Balance. Please top up your wallet.');
                }, 1500);
                return;
            }

            try {
                const newExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000);
                const updates = {};
                updates[`/users/${currentUser.uid}/premium/expiresAt`] = newExpiry;
                updates[`/users/${currentUser.uid}/wallet/live`] = firebase.database.ServerValue.increment(-price);

                const newTransactionRef = database.ref(`users/${currentUser.uid}/transactions`).push();
                updates[`/users/${currentUser.uid}/transactions/${newTransactionRef.key}`] = {
                    id: newTransactionRef.key,
                    type: 'Subscription',
                    description: 'Chat Premium (30 Days)',
                    amount: -price,
                    status: 'completed',
                    timestamp: new Date().toISOString()
                };

                await database.ref().update(updates);
                
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.classList.remove('flex');
                    alert('Purchase Successful! You now have Chat Premium for 30 days.');
                }, 2000);
            } catch (error) {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
                alert('An error occurred during purchase. Please try again.');
                console.error("Purchase failed:", error);
            }
        }
        
        function scrollToBottom(smooth = false) {
            messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
        }

    </script>
</body>
</html>
